mutate(
prediction_nb = predict(
final_model,
newdata = fishnet_model,
type = "response"
)[match(uniqueID, fishnet_model$uniqueID)]
)
# Normalize KDE predictions to total burglary count
kde_sum   <- sum(fishnet$kde_value,       na.rm = TRUE)
count_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)
fishnet <- fishnet %>%
mutate(
prediction_kde = (kde_value / kde_sum) * count_sum
)
#| fig-width: 12
#| fig-height: 4
# Actual counts
p1 <- ggplot() +
geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +
scale_fill_viridis_c(
name = "Count", option = "plasma", limits = c(0, 15)
) +
labs(title = "Actual Burglaries (2017)") +
theme_default()
# Negative Binomial predictions
p2 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "NB Model Predictions") +
theme_default()
# KDE baseline predictions
p3 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "KDE Baseline Predictions") +
theme_default()
# Combine the three maps
p1 + p2 + p3 +
plot_annotation(
title = "Actual vs Predicted Burglaries",
subtitle = "Comparing NB Model and KDE Baseline"
)
# Calculate MAE and RMSE for NB model and KDE baseline
comparison <- fishnet %>%
st_drop_geometry() %>%
filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%
summarize(
model_mae  = mean(abs(countBurglaries - prediction_nb)),
model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),
kde_mae    = mean(abs(countBurglaries - prediction_kde)),
kde_rmse   = sqrt(mean((countBurglaries - prediction_kde)^2))
)
# Reshape and print the table
comparison %>%
pivot_longer(
everything(), names_to = "metric", values_to = "value"
) %>%
separate(metric, into = c("approach", "metric"), sep = "_") %>%
pivot_wider(names_from = metric, values_from = value) %>%
kable(
digits = 2,
caption = "Model Performance: NB vs KDE"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
#| fig-width: 12
#| fig-height: 8
# Signed error (NB)
p_nb_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "NB Model: Signed Error") +
theme_default()
# Absolute error (NB)
p_nb_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "NB Model: Absolute Error") +
theme_default()
# Signed error (KDE)
p_kde_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_kde), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "KDE Baseline: Signed Error") +
theme_default()
# Absolute error (KDE)
p_kde_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_kde), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "KDE Baseline: Absolute Error") +
theme_default()
# Combine 4 plots in 2×2 layout
(p_nb_err + p_nb_abs) /
(p_kde_err + p_kde_abs)
# Create named lookup table for zoning categories
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
# Extract model summary with exponentiated coefficients (rate ratios)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
# Replace term names with readable labels
term = dplyr::case_when(
term == "(Intercept)"     ~ "Intercept",
term == "mean_bldg_age"   ~ "Mean building age",
term == "knn_mean"        ~ "KNN mean burglaries (neighboring cells)",
term == "dist_to_hotspot" ~ "Distance to rodent hotspot",
# Zoning coefficient: detect zone_code_domXXX patterns
grepl("^zone_code_dom", term) ~ paste0(
"Zoning: ",
sub("zone_code_dom", "", term),                 # extract code like "RS"
" (", zoning_labels[sub("zone_code_dom", "", term)], ")"  # put full name
),
TRUE ~ term
),
# Round numeric columns
across(where(is.numeric), ~ round(.x, 3))
)
# Produce clean table
model_summary %>%
kable(
caption = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land-use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category used in the model.",
"",
"Zoning Categories:",
"RS = Residential Single-Unit District;",
"RT = Residential Two-Flat, Townhouse and Multi-Unit District;",
"RM = Residential Multi-Unit District;",
"B = Business;",
"C = Commercial;",
"DC = Downtown Core District;",
"DR = Downtown Residential District;",
"DS = Downtown Service District;",
"DX = Downtown Mixed-Use District;",
"M = Manufacturing;",
"PMD = Planned Manufacturing Districts;",
"PD = Planned Development;",
"T = Transportation;",
"POS = Parks and Open Space."
)
)
# Lookup full zoning labels
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
term = dplyr::case_when(
term == "(Intercept)"      ~ "Intercept",
term == "mean_bldg_age"    ~ "Mean building age",
term == "knn_mean"         ~ "KNN mean burglaries (neighboring cells)",
term == "dist_to_hotspot"  ~ "Distance to rodent hotspot",
# Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT, ...
grepl("^zone_prefix_dom", term) ~ paste0(
"Zoning: ",
sub("zone_prefix_dom", "", term),  # e.g. "RS"
" (",
zoning_labels[sub("zone_prefix_dom", "", term)],
")"
),
TRUE ~ term
),
# Round all numeric columns
dplyr::across(where(is.numeric), ~round(.x, 3))
)
model_summary %>%
kable(
caption   = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category (the omitted baseline level of zone_prefix_dom).",
"",
"Zoning categories:",
"RS = Residential Single-Unit District;",
"RT = Residential Two-Flat, Townhouse and Multi-Unit District;",
"RM = Residential Multi-Unit District;",
"B = Business;",
"C = Commercial;",
"DC = Downtown Core District;",
"DR = Downtown Residential District;",
"DS = Downtown Service District;",
"DX = Downtown Mixed-Use District;",
"M = Manufacturing;",
"PMD = Planned Manufacturing Districts;",
"PD = Planned Development;",
"T = Transportation;",
"POS = Parks and Open Space."
)
)
# Fit the final NB model using all available training cells
final_model <- glm.nb(
countBurglaries ~ mean_bldg_age + knn_mean + dist_to_hotspot + zone_prefix_dom,
data = fishnet_model
)
# Add NB predictions back to fishnet (matched by uniqueID)
fishnet <- fishnet %>%
mutate(
prediction_nb = predict(
final_model,
newdata = fishnet_model,
type = "response"
)[match(uniqueID, fishnet_model$uniqueID)]
)
# Normalize KDE predictions to total burglary count
kde_sum   <- sum(fishnet$kde_value,       na.rm = TRUE)
count_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)
fishnet <- fishnet %>%
mutate(
prediction_kde = (kde_value / kde_sum) * count_sum
)
#| fig-width: 12
#| fig-height: 4
# Actual counts
p1 <- ggplot() +
geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +
scale_fill_viridis_c(
name = "Count", option = "plasma", limits = c(0, 15)
) +
labs(title = "Actual Burglaries (2017)") +
theme_default()
# Negative Binomial predictions
p2 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "NB Model Predictions") +
theme_default()
# KDE baseline predictions
p3 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "KDE Baseline Predictions") +
theme_default()
# Combine the three maps
p1 + p2 + p3 +
plot_annotation(
title = "Actual vs Predicted Burglaries",
subtitle = "Comparing NB Model and KDE Baseline"
)
# Calculate MAE and RMSE for NB model and KDE baseline
comparison <- fishnet %>%
st_drop_geometry() %>%
filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%
summarize(
model_mae  = mean(abs(countBurglaries - prediction_nb)),
model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),
kde_mae    = mean(abs(countBurglaries - prediction_kde)),
kde_rmse   = sqrt(mean((countBurglaries - prediction_kde)^2))
)
# Reshape and print the table
comparison %>%
pivot_longer(
everything(), names_to = "metric", values_to = "value"
) %>%
separate(metric, into = c("approach", "metric"), sep = "_") %>%
pivot_wider(names_from = metric, values_from = value) %>%
kable(
digits = 2,
caption = "Model Performance: NB vs KDE"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
#| fig-width: 12
#| fig-height: 8
# Signed error (NB)
p_nb_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "NB Model: Signed Error") +
theme_default()
# Absolute error (NB)
p_nb_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "NB Model: Absolute Error") +
theme_default()
# Signed error (KDE)
p_kde_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_kde), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "KDE Baseline: Signed Error") +
theme_default()
# Absolute error (KDE)
p_kde_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_kde), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "KDE Baseline: Absolute Error") +
theme_default()
# Combine 4 plots in 2×2 layout
(p_nb_err + p_nb_abs) /
(p_kde_err + p_kde_abs)
# Lookup full zoning labels
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
term = dplyr::case_when(
term == "(Intercept)"      ~ "Intercept",
term == "mean_bldg_age"    ~ "Mean building age",
term == "knn_mean"         ~ "KNN mean burglaries (neighboring cells)",
term == "dist_to_hotspot"  ~ "Distance to rodent hotspot",
# Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT
grepl("^zone_prefix_dom", term) ~ paste0(
"Zoning: ",
sub("zone_prefix_dom", "", term),
" (",
zoning_labels[sub("zone_prefix_dom", "", term)],
")"
),
TRUE ~ term
),
# Round all numeric columns
dplyr::across(where(is.numeric), ~round(.x, 3))
)
model_summary %>%
kable(
caption   = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category (the omitted baseline level of zone_prefix_dom).",
"",
"Zoning categories:",
"RS = Residential Single-Unit District;",
"RT = Residential Two-Flat, Townhouse and Multi-Unit District;",
"RM = Residential Multi-Unit District;",
"B = Business;",
"C = Commercial;",
"DC = Downtown Core District;",
"DR = Downtown Residential District;",
"DS = Downtown Service District;",
"DX = Downtown Mixed-Use District;",
"M = Manufacturing;",
"PMD = Planned Manufacturing Districts;",
"PD = Planned Development;",
"T = Transportation;",
"POS = Parks and Open Space."
)
)
# Lookup full zoning labels
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
term = dplyr::case_when(
term == "(Intercept)"      ~ "Intercept",
term == "mean_bldg_age"    ~ "Mean building age",
term == "knn_mean"         ~ "KNN mean burglaries (neighboring cells)",
term == "dist_to_hotspot"  ~ "Distance to rodent hotspot",
# Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT
grepl("^zone_prefix_dom", term) ~ paste0(
"Zoning: ",
sub("zone_prefix_dom", "", term),
" (",
zoning_labels[sub("zone_prefix_dom", "", term)],
")"
),
TRUE ~ term
),
# Round all numeric columns
dplyr::across(where(is.numeric), ~round(.x, 3))
)
model_summary %>%
kable(
caption   = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category (the omitted baseline level of zone_prefix_dom)."
)
)
View(fishnet)
# Spatial join: which cell contains each rodent baiting request/burglaries?
rodent_fishnet <- st_join(rb_sf_2017, fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID) %>%
summarise(countRodent = n(), .groups = "drop")
burglary_fishnet <- st_join(burglaries, fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID) %>%
summarise(countBurglaries = n(), .groups = "drop")
# Join back to fishnet (cells with 0 requests will be NA)
fishnet <- fishnet %>%
left_join(rodent_fishnet,   by = "uniqueID") %>%
left_join(burglary_fishnet, by = "uniqueID") %>%
mutate(
countRodent     = tidyr::replace_na(countRodent, 0),
countBurglaries = tidyr::replace_na(countBurglaries, 0)
)
