#| warning: false
#| results: hide
fishnet$zone_code_dom <- as.factor(fishnet$zone_code_dom)
pois_model <- glm(
countBurglaries ~ mean_bldg_age + zone_code_dom + dist_to_hotspot + knn_mean,
data = fishnet,
family = "poisson"
)
summary(pois_model)
#| label: poisson-dispersion-check
#| message: false
#| warning: false
dispersion_rb <- sum(residuals(pois_model, type = "pearson")^2) /
pois_model$df.residual
cat("Dispersion parameter for rodent baiting Poisson model:",
round(dispersion_rb, 2), "\n")
cat("Rule of thumb: values > 1.5 indicate overdispersion.\n")
if (dispersion_rb > 1.5) {
cat("⚠ Overdispersion detected for rodent baiting counts.\n")
cat("  The Poisson model is likely too restrictive.\n")
cat("  A Negative Binomial model is more appropriate.\n")
} else {
cat("✓ Dispersion looks acceptable.\n")
cat("  The Poisson model may be adequate for these counts.\n")
}
#| label: nb-reg
#| message: false
#| warning: false
#| results: hide
nb_model <- glm.nb(
countBurglaries ~ mean_bldg_age + zone_prefix_dom + dist_to_hotspot + knn_mean,
data = fishnet
)
summary(nb_model)
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model))
)
knitr::kable(model_compare, caption = "Model Comparison: Poisson vs. NB")
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model)),
Poisson Dispersion = c(dispersion_rb)
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model)),
Dispersion = c(dispersion_rb, NA)
)
knitr::kable(model_compare, caption = "Model Comparison: Poisson vs. NB")
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model))
)
dispersion_row <- data.frame(
Statistic = "Poisson Dispersion",
Value = dispersion_rb
)
model_compare
dispersion_row
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model))
)
knitr::kable(model_compare, caption = "Model Comparison: Poisson vs. NB")
dispersion_row
#| message: false
#| warning: false
#| results: hide
# Calculate which police district the centroid of the grid falls in
fishnet_centroids <- st_centroid(fishnet) %>%
st_join(policeDistricts, join = st_within) %>%
st_drop_geometry() %>%
dplyr::select(uniqueID, District)
# Construct a dataset for cross-validation
fishnet_model <- fishnet %>%
left_join(fishnet_centroids, by = "uniqueID") %>%
filter(!is.na(District)) %>%
mutate(
District      = as.factor(District),
zone_code_dom = as.factor(zone_code_dom)
) %>%
filter(
!is.na(countRodent),
!is.na(mean_bldg_age),
!is.na(zone_code_dom),
!is.na(knn_mean),
!is.na(dist_to_hotspot)
)
# LOGO CV
districts  <- unique(fishnet_model$District)
cv_results <- tibble()
for (i in seq_along(districts)) {
test_district <- districts[i]
# Divide the training set/test set
train_data <- fishnet_model %>% filter(District != test_district)
test_data  <- fishnet_model %>% filter(District == test_district)
train_data <- train_data %>%
mutate(zone_code_dom = factor(zone_code_dom))
test_data <- test_data %>%
mutate(zone_code_dom = factor(zone_code_dom,
levels = levels(train_data$zone_code_dom)))
# Fit the NB model
model_cv <- MASS::glm.nb(
countBurglaries ~ mean_bldg_age + zone_code_dom + dist_to_hotspot + knn_mean,
data = train_data
)
# Make predictions on the test police district
test_data <- test_data %>%
mutate(
prediction = predict(model_cv, newdata = ., type = "response"),
abs_error  = abs(countRodent - prediction),
sq_error   = (countRodent - prediction)^2
)
test_eval <- test_data %>% filter(!is.na(prediction))
mae  <- mean(test_eval$abs_error, na.rm = TRUE)
rmse <- sqrt(mean(test_eval$sq_error, na.rm = TRUE))
# Save the result
cv_results <- bind_rows(
cv_results,
tibble(
fold          = i,
test_district = as.character(test_district),
n_test        = nrow(test_eval),
mae           = mae,
rmse          = rmse
)
)
cat("  Fold", i, "/", length(districts),
"- District", as.character(test_district),
"- n_test:", nrow(test_eval),
"- MAE:", round(mae, 2),
"- RMSE:", round(rmse, 2), "\n")
}
cv_sorted <- cv_results %>%
arrange(fold)
# Table 1: local MAE and RMSE
cv_sorted %>%
knitr::kable(
digits  = 2,
caption = "Leave-One-District-Out CV Results (per district)"
) %>%
kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
# Table 2: Average MAE and RMSe
cv_summary <- cv_sorted %>%
summarise(
mean_MAE  = mean(mae,  na.rm = TRUE),
mean_RMSE = mean(rmse, na.rm = TRUE),
n_folds   = dplyr::n()
)
cv_summary %>%
knitr::kable(
digits  = 2,
caption = "Average MAE and RMSE across all districts (LOGO CV)"
) %>%
kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
cv_by_district <- cv_results %>%
group_by(test_district) %>%
summarise(
mae  = mean(mae,  na.rm = TRUE),
rmse = mean(rmse, na.rm = TRUE),
.groups = "drop"
)
# Merge with the police district base map
police_cv <- policeDistricts %>%
mutate(District = as.character(District)) %>%
left_join(cv_by_district, by = c("District" = "test_district"))
# RMSE spatial distribution
ggplot(police_cv) +
geom_sf(aes(fill = rmse)) +
labs(
title = "LOGO CV RMSE by Police District",
fill  = "RMSE"
) +
theme_minimal()
# MAE spatial distribution
ggplot(police_cv) +
geom_sf(aes(fill = mae)) +
labs(
title = "LOGO CV MAE by Police District",
fill  = "MAE"
) +
theme_minimal()
# 1. Extract XY coordinates of burglary points
bur_xy <- st_coordinates(burglaries)
# 2. Create a bounding window from the Chicago boundary
win_bbox <- spatstat.geom::owin(
xrange = st_bbox(chicagoBoundary)[c("xmin", "xmax")],
yrange = st_bbox(chicagoBoundary)[c("ymin", "ymax")]
)
# 3. Create a ppp object (point pattern) for burglaries
bur_ppp <- spatstat.geom::ppp(
x      = bur_xy[, 1],
y      = bur_xy[, 2],
window = win_bbox
)
# 4. Kernel density estimate for the point pattern
#    IMPORTANT: call density.ppp(bur_ppp, ...) — no "X ="
bur_kde <- spatstat.explore::density.ppp(
bur_ppp,
sigma = 1000   # bandwidth in meters
)
# 5. Convert KDE to raster and extract values at grid centroids
bur_kde_raster <- raster::raster(bur_kde)
fishnet_centroids <- st_coordinates(st_centroid(fishnet))
fishnet$kde_value <- raster::extract(
bur_kde_raster,
fishnet_centroids
)
# 6. Replace NA values (outside the KDE window) with 0
fishnet$kde_value[is.na(fishnet$kde_value)] <- 0
# Fit the final NB model using all available training cells
final_model <- glm.nb(
countBurglaries ~ mean_bldg_age + knn_mean + dist_to_hotspot + zone_prefix_dom,
data = fishnet_model
)
# Add NB predictions back to fishnet (matched by uniqueID)
fishnet <- fishnet %>%
mutate(
prediction_nb = predict(
final_model,
newdata = fishnet_model,
type = "response"
)[match(uniqueID, fishnet_model$uniqueID)]
)
# Normalize KDE predictions to total burglary count
kde_sum   <- sum(fishnet$kde_value,       na.rm = TRUE)
count_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)
fishnet <- fishnet %>%
mutate(
prediction_kde = (kde_value / kde_sum) * count_sum
)
fishnet <- fishnet %>%
mutate(
error_nb      = countBurglaries - prediction_nb,
abs_error_nb  = abs(error_nb),
error_kde     = countBurglaries - prediction_kde,
abs_error_kde = abs(error_kde)
)
#| fig-width: 12
#| fig-height: 4
# Actual counts
p1 <- ggplot() +
geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +
scale_fill_viridis_c(
name = "Count", option = "plasma", limits = c(0, 15)
) +
labs(title = "Actual Burglaries (2017)") +
theme_default()
# Negative Binomial predictions
p2 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "NB Model Predictions") +
theme_default()
# KDE baseline predictions
p3 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "KDE Baseline Predictions") +
theme_default()
# Combine the three maps
p1 + p2 + p3 +
plot_annotation(
title = "Actual vs Predicted Burglaries",
subtitle = "Comparing NB Model and KDE Baseline"
)
#| fig-width: 12
#| fig-height: 4
# Actual counts
p1 <- ggplot() +
geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +
scale_fill_viridis_c(
name = "Count", option = "plasma", limits = c(0, 15)
) +
labs(title = "Actual Burglaries (2017)") +
theme_default()
# Negative Binomial predictions
p2 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "NB Model Predictions") +
theme_default()
# KDE baseline predictions
p3 <- ggplot() +
geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +
scale_fill_viridis_c(
name = "Predicted", option = "plasma", limits = c(0, 15)
) +
labs(title = "KDE Baseline Predictions") +
theme_default()
# Combine the three maps
p1 + p2 + p3 +
plot_annotation(
title = "Actual vs Predicted Burglaries",
subtitle = "Comparing NB Model and KDE Baseline"
)
# Calculate MAE and RMSE for NB model and KDE baseline
comparison <- fishnet %>%
st_drop_geometry() %>%
filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%
summarize(
model_mae  = mean(abs(countBurglaries - prediction_nb)),
model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),
kde_mae    = mean(abs(countBurglaries - prediction_kde)),
kde_rmse   = sqrt(mean((countBurglaries - prediction_kde)^2))
)
# Reshape and print the table
comparison %>%
pivot_longer(
everything(), names_to = "metric", values_to = "value"
) %>%
separate(metric, into = c("approach", "metric"), sep = "_") %>%
pivot_wider(names_from = metric, values_from = value) %>%
kable(
digits = 2,
caption = "Model Performance: NB vs KDE"
) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
#| fig-width: 12
#| fig-height: 8
# Signed error (NB)
p_nb_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "NB Model: Signed Error") +
theme_default()
# Absolute error (NB)
p_nb_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "NB Model: Absolute Error") +
theme_default()
# Signed error (KDE)
p_kde_err <- ggplot() +
geom_sf(data = fishnet, aes(fill = error_kde), color = NA) +
scale_fill_gradient2(
name     = "Error",
low      = "#2166ac",
mid      = "white",
high     = "#b2182b",
midpoint = 0,
limits   = c(-10, 10)
) +
labs(title = "KDE Baseline: Signed Error") +
theme_default()
# Absolute error (KDE)
p_kde_abs <- ggplot() +
geom_sf(data = fishnet, aes(fill = abs_error_kde), color = NA) +
scale_fill_viridis_c(
name   = "Abs. Error",
option = "magma"
) +
labs(title = "KDE Baseline: Absolute Error") +
theme_default()
# Combine 4 plots in 2×2 layout
(p_nb_err + p_nb_abs) /
(p_kde_err + p_kde_abs)
# Lookup full zoning labels
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
term = dplyr::case_when(
term == "(Intercept)"      ~ "Intercept",
term == "mean_bldg_age"    ~ "Mean building age",
term == "knn_mean"         ~ "KNN mean burglaries (neighboring cells)",
term == "dist_to_hotspot"  ~ "Distance to rodent hotspot",
# Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT
grepl("^zone_prefix_dom", term) ~ paste0(
"Zoning: ",
sub("zone_prefix_dom", "", term),
" (",
zoning_labels[sub("zone_prefix_dom", "", term)],
")"
),
TRUE ~ term
),
# Round all numeric columns
dplyr::across(where(is.numeric), ~round(.x, 3))
)
model_summary %>%
kable(
caption   = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category (the omitted baseline level of zone_prefix_dom)."
)
)
# Lookup full zoning labels
zoning_labels <- c(
"RS"  = "Residential Single-Unit District",
"RT"  = "Residential Two-Flat, Townhouse and Multi-Unit District",
"RM"  = "Residential Multi-Unit District",
"B"   = "Business",
"C"   = "Commercial",
"DC"  = "Downtown Core District",
"DR"  = "Downtown Residential District",
"DS"  = "Downtown Service District",
"DX"  = "Downtown Mixed-Use District",
"M"   = "Manufacturing",
"PMD" = "Planned Manufacturing Districts",
"PD"  = "Planned Development",
"T"   = "Transportation",
"POS" = "Parks and Open Space"
)
model_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%
mutate(
term = dplyr::case_when(
term == "(Intercept)"      ~ "Intercept",
term == "mean_bldg_age"    ~ "Mean building age",
term == "knn_mean"         ~ "KNN mean (neighboring rodent baiting requests)",
term == "dist_to_hotspot"  ~ "Distance to rodent hotspot",
# Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT
grepl("^zone_prefix_dom", term) ~ paste0(
"Zoning: ",
sub("zone_prefix_dom", "", term),
" (",
zoning_labels[sub("zone_prefix_dom", "", term)],
")"
),
TRUE ~ term
),
# Round all numeric columns
dplyr::across(where(is.numeric), ~round(.x, 3))
)
model_summary %>%
kable(
caption   = "Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)",
col.names = c("Variable", "Rate Ratio", "Std. Error", "Z", "P-Value")
) %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
footnote(
general = paste(
"Rate ratios > 1 indicate a positive association with burglary counts,",
"while rate ratios < 1 indicate a negative association.",
"Zoning (land use) is a categorical variable; each zoning category is interpreted",
"relative to the reference category (the omitted baseline level of zone_prefix_dom)."
)
)
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model      = c("Poisson", "Negative Binomial"),
AIC        = c(AIC(pois_model), AIC(nb_model)),
Dispersion = c(dispersion_rb, NA)
)
knitr::kable(model_compare, caption = "Poisson vs Negative Binomial Model Comparison")
#| label: compare-aic
#| message: false
#| warning: false
model_compare <- data.frame(
Model = c("Poisson", "Negative Binomial"),
AIC   = c(AIC(pois_model), AIC(nb_model))
)
knitr::kable(model_compare, caption = "Model Comparison: Poisson vs. NB")
dispersion_row <- data.frame(
Statistic = "Poisson Dispersion",
Value     = dispersion_rb
)
knitr::kable(dispersion_row, caption = "Poisson Dispersion Statistic")
