{
  "hash": "7371c9533e193e810fc79d7e7d79e2ef",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assignment 2: Spatial Analysis and Visualization\"\nsubtitle: \"Healthcare Access and Equity in Pennsylvania\"\nauthor: \"Yuqing(Demi) Yang\"\ndate: today\nformat: \n  html:\n    theme: cosmo\n    embed-resources: true\n    toc-depth: 2\n    code-fold: false\n    code-tools: true\n    toc-location: left\nexecute:\n  warning: false\n  message: false\n  echo: true\n---\n\n## Assignment Overview\n\n**Learning Objectives:**\n- Apply spatial operations to answer policy-relevant research questions\n- Integrate census demographic data with spatial analysis\n- Create publication-quality visualizations and maps\n- Work with spatial data from multiple sources\n- Communicate findings effectively for policy audiences\n\n---\n\n## Part 1: Healthcare Access for Vulnerable Populations\n\n### Research Question\n\n- **Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare investment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief explanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n- Pennsylvania county boundaries\n- Pennsylvania hospitals (from lecture data)\n- Pennsylvania census tracts\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\n\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(scales)\nlibrary(patchwork)\nlibrary(here)\nlibrary(units)\nlibrary(kableExtra)\ncensus_api_key(\"42bf8a20a3df1def380f330cf7edad0dd5842ce6\")\n\n# Load spatial data\n\noptions(tigris_progress = FALSE, tigris_use_cache = TRUE)\npa_counties <- st_read(here(\"assignments/assignment_2/data/Pennsylvania_County_Boundaries.shp\"),quiet = TRUE)\nhospitals <- st_read(here(\"assignments/assignment_2/data/hospitals.geojson\"),quiet = TRUE)\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE)\n\n# Check that all data loaded correctly\n\n## 1)Make a table for checking\n\nlayers <- list(\n  pa_counties   = pa_counties,\n  hospitals     = hospitals,\n  census_tracts = census_tracts\n)\n\nqc <- function(x) {\n  data.frame(\n    is_sf    = inherits(x, \"sf\"),\n    n        = nrow(x),\n    geom     = paste(unique(as.character(st_geometry_type(x))), collapse = \", \"),\n    crs_epsg = st_crs(x)$epsg,\n    crs_txt  = st_crs(x)$input,\n    invalid  = sum(!st_is_valid(x)),\n    empty    = sum(st_is_empty(x)),\n    bbox     = paste(round(st_bbox(x), 3), collapse = \", \")\n  )\n}\n\nqc_table <- do.call(rbind, lapply(layers, qc)) %>%\n  tibble::rownames_to_column(\"Layer\")\n\nkable(\n  qc_table,\n  caption = \"Summary of Spatial Layers and Geometry Quality Checks\",\n  align = \"c\"\n) %>%\n  kable_styling(\n    full_width = FALSE,\n    bootstrap_options = c(\"striped\", \"hover\", \"condensed\")\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Summary of Spatial Layers and Geometry Quality Checks</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> Layer </th>\n   <th style=\"text-align:center;\"> is_sf </th>\n   <th style=\"text-align:center;\"> n </th>\n   <th style=\"text-align:center;\"> geom </th>\n   <th style=\"text-align:center;\"> crs_epsg </th>\n   <th style=\"text-align:center;\"> crs_txt </th>\n   <th style=\"text-align:center;\"> invalid </th>\n   <th style=\"text-align:center;\"> empty </th>\n   <th style=\"text-align:center;\"> bbox </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> pa_counties </td>\n   <td style=\"text-align:center;\"> TRUE </td>\n   <td style=\"text-align:center;\"> 67 </td>\n   <td style=\"text-align:center;\"> MULTIPOLYGON </td>\n   <td style=\"text-align:center;\"> 3857 </td>\n   <td style=\"text-align:center;\"> WGS 84 / Pseudo-Mercator </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> -8963376.946, 4825316.222, -8314403.862, 5201412.518 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> hospitals </td>\n   <td style=\"text-align:center;\"> TRUE </td>\n   <td style=\"text-align:center;\"> 223 </td>\n   <td style=\"text-align:center;\"> POINT </td>\n   <td style=\"text-align:center;\"> 4326 </td>\n   <td style=\"text-align:center;\"> WGS 84 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> -80.496, 39.752, -74.867, 42.134 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> census_tracts </td>\n   <td style=\"text-align:center;\"> TRUE </td>\n   <td style=\"text-align:center;\"> 3445 </td>\n   <td style=\"text-align:center;\"> MULTIPOLYGON </td>\n   <td style=\"text-align:center;\"> 4269 </td>\n   <td style=\"text-align:center;\"> NAD83 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n   <td style=\"text-align:center;\"> -80.52, 39.72, -74.69, 42.27 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Questions to answer:**\n\n- **How many hospitals are in your dataset?**\n  - 223\n\n- **How many census tracts?**\n  - 3445\n\n- **What coordinate reference system is each dataset in?**\n  - *Pennsylvania county boundaries* is in EPSG:3857(WGS 84 / Web-Mercator, meters), *Pennsylvania hospitals* is in EPSG:4326(WGS 84 geographic, degrees), and *Pennsylvania census tracts* is in EPSG:4269(NAD83 geographic, degrees).\n\n---\n\n#### Step 2: Get Demographic Data \n\nUse `tidycensus` to download tract-level demographic data for Pennsylvania.\n\n**Required variables:**\n- Total population\n- Median household income\n- Population 65 years and over (you may need to sum multiple age categories)\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get demographic data from ACS\n\n## 1)Reach the data\ncore_vars <- c(\n  total_pop     = \"B01003_001\",\n  median_income = \"B19013_001\"\n)\n\nacs_core <- get_acs(\n  geography = \"tract\",\n  state     = \"PA\",\n  variables = core_vars,\n  year      = 2022,\n  survey    = \"acs5\",\n  output    = \"wide\",\n  geometry  = FALSE\n) %>%\n  transmute(\n    GEOID,\n    total_pop     = total_popE,\n    median_income = median_incomeE\n  )\n\n## 2) Calculate the population 65 years and over\nage65_vars <- c(sprintf(\"B01001_%03d\", 20:25), sprintf(\"B01001_%03d\", 44:49))\n\nacs_65_wide <- get_acs(\n  geography = \"tract\", state = \"PA\", variables = age65_vars,\n  year = 2022, survey = \"acs5\"\n) %>%\n  select(GEOID, variable, estimate) %>%\n  pivot_wider(names_from = variable, values_from = estimate)\n\nacs_65plus <- acs_65_wide %>%\n  mutate(\n    non_na_bins = rowSums(!is.na(across(all_of(age65_vars)))),\n    over65 = if_else(\n      non_na_bins == 0, NA_real_,\n      rowSums(across(all_of(age65_vars)), na.rm = TRUE)\n    )\n  ) %>%\n  select(GEOID, over65)\n\n# Join to tract boundaries\noptions(tigris_progress = FALSE, tigris_use_cache = TRUE)\n\npa_tracts <- tracts(state = \"PA\", year = 2022, cb = TRUE, class = \"sf\")\n\npa_tracts_joined <- pa_tracts %>%\n  left_join(acs_core,   by = \"GEOID\") %>%\n  left_join(acs_65plus, by = \"GEOID\") %>%\n  mutate(\n    over65_share = if_else(!is.na(total_pop) & total_pop > 0, over65 / total_pop, NA_real_)\n  )\n\n## 2) Count the missing data and medium data of income\nincome_na_n   <- sum(is.na(pa_tracts_joined$median_income))\nincome_median_overall <- median(pa_tracts_joined$median_income, na.rm = TRUE)\n\n## 3) Remove missing values\npa_tracts_demo <- pa_tracts_joined %>%\n  filter(!is.na(median_income), !is.na(over65_share))\n```\n:::\n\n\n**Questions to answer:**\n\n- **What year of ACS data are you using?**\n  - 2022\n\n- **How many tracts have missing income data?**\n  - 62. Mostly because household = 0, or household is extremely small.\n\n- **What is the median income across all PA census tracts?**\n  - 70188\n\n---\n\n#### Step 3: Define Vulnerable Populations \n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n1. Low median household income (choose an appropriate threshold)\n2. Significant elderly population (choose an appropriate threshold)\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter for vulnerable tracts based on your criteria\n\n## 1) thresholds\nincome_threshold  <- quantile(pa_tracts_demo$median_income, 0.25, na.rm = TRUE, names = FALSE)\nelderly_q75       <- quantile(pa_tracts_demo$over65_share, 0.75, na.rm = TRUE, names = FALSE)\n\n## 2) flags + vulnerable\npa_tracts_demo <- pa_tracts_demo %>%\n  mutate(\n    low_income   = median_income <= income_threshold,\n    high_elderly = over65_share >= elderly_q75,  \n    vulnerable   = low_income & high_elderly\n  )\n\n## 3) quick outputs\nelderly_q75\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2314351\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(pa_tracts_demo$vulnerable, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 165\n```\n\n\n:::\n\n```{.r .cell-code}\nround(mean(pa_tracts_demo$vulnerable, na.rm = TRUE) * 100, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 4.9\n```\n\n\n:::\n:::\n\n\n**Questions to answer:**\n\n- **What income threshold did you choose and why?**\n  - The low-income threshold = tract median income ≤ state 25th percentile.A percentile-based, within-state threshold is robust to outliers and gives a clear “most disadvantaged” group.\n\n\n- **What elderly population threshold did you choose and why?**\n  - The aging threshold = 65+ share ≥ state 75th percentile.Using percentile cutoffs to identify the “upper tail” aligns with screening practice.Both thresholds follow a percentile-ranking approach widely used by *federal screening tools (SVI/EJScreen)*.\n\n- **How many tracts meet your vulnerability criteria?**\n  - 165\n\n- **What percentage of PA census tracts are considered vulnerable by your definition?**\n  - 4.9%\n\n---\n\n#### Step 4: Calculate Distance to Hospitals \n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Transform to appropriate projected CRS\n\n## 1) Copy and reproject (without modifying the original object)\ndistance_crs <- 5070\npa_tracts_demo_5070 <- st_transform(pa_tracts_demo, distance_crs)\nhospitals_5070 <- st_transform(hospitals, distance_crs)\n\n## 2) Keep only vulnerable tracts\nvuln_5070 <- pa_tracts_demo_5070 %>%\n  dplyr::filter(vulnerable %in% TRUE)\n\nstopifnot(nrow(hospitals_5070) > 0)\nstopifnot(nrow(vuln_5070) > 0)\n\n# Calculate distance from each tract centroid to nearest hospital\n\n## 1) Use an interior representative point\nvuln_pts_5070 <- st_centroid(vuln_5070)\n\n## 2) Pairwise distance matrix (meters)\ndist_mat_m <- st_distance(vuln_pts_5070, hospitals_5070)\n\n## 3) Distance: tract centroid -> nearest hospital\nnearest_idx <- apply(dist_mat_m, 1, function(x) which.min(as.numeric(x)))\nmin_dist_m <- apply(dist_mat_m, 1, function(x) min(as.numeric(x), na.rm = TRUE))\n\n## 4) meters → miles\ndist_mi <- min_dist_m / 1609.344\n\n## 5) Attach back to vulnerable tracts\nvulnerable_tracts_dist_5070 <- vuln_5070 %>%\n  mutate(\n    nearest_hospital_row = nearest_idx,\n    dist_to_hospital_mi  = dist_mi)\n\n\navg_dist_mi  <- mean(vulnerable_tracts_dist_5070$dist_to_hospital_mi, na.rm = TRUE)\nmax_dist_mi  <- max(vulnerable_tracts_dist_5070$dist_to_hospital_mi, na.rm = TRUE)\nover15_count <- sum(vulnerable_tracts_dist_5070$dist_to_hospital_mi > 15, na.rm = TRUE)\n\ncat(\n  \"Average distance to nearest hospital (miles): \", round(avg_dist_mi, 2), \"\\n\",\n  \"Maximum distance (miles): \",                   round(max_dist_mi, 2), \"\\n\",\n  \"Vulnerable tracts > 15 miles: \",               over15_count, \"\\n\",\n  sep = \"\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAverage distance to nearest hospital (miles): 4.75\nMaximum distance (miles): 19.32\nVulnerable tracts > 15 miles: 10\n```\n\n\n:::\n:::\n\n\n**Requirements:**\n\n- **Use an appropriate projected coordinate system for Pennsylvania**\n- **Calculate distances in miles**\n- **Explain why you chose your projection**\n  - I use EPSG:5070 (NAD83 / Conus Albers) because it provides low distortion across the conterminous U.S., so distances computed statewide in Pennsylvania are much more reliable than in Web Mercator (distorts scale) or unprojected WGS84 (degrees). It also uses meters, making distance and area calculations straightforward, and it avoids zone-splitting issues you’d hit with StatePlane or UTM.\n\n**Questions to answer:**\n\n- **What is the average distance to the nearest hospital for vulnerable tracts?**\n  - 4.75\n- **What is the maximum distance?**\n  - 19.32\n- **How many vulnerable tracts are more than 15 miles from the nearest hospital?**\n  - 10\n\n---\n\n#### Step 5: Identify Underserved Areas \n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create underserved variable\n\nvulnerable_tracts_dist_5070 <- vulnerable_tracts_dist_5070 %>%\n  dplyr::mutate(underserved = dist_to_hospital_mi > 15)\n\n\nsum(vulnerable_tracts_dist_5070$underserved, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10\n```\n\n\n:::\n\n```{.r .cell-code}\nround(mean(vulnerable_tracts_dist_5070$underserved, na.rm = TRUE) * 100, 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6.1\n```\n\n\n:::\n:::\n\n\n**Questions to answer:**\n\n- **How many tracts are underserved?**\n  - 10\n\n- **What percentage of vulnerable tracts are underserved?**\n  - 6.1%\n  \n- **Does this surprise you? Why or why not?**\n  - Hospitals cluster in metro areas, so it’s expected that some rural, low-density tracts fall farther from facilities; under my definition, only ~6% of vulnerable tracts are underserved, which suggests overall access is fairly good. That said, pockets of concern remain, and distance alone doesn’t capture barriers like transportation or service capacity.\n\n---\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join tracts to counties\n\npa_counties_5070 <- st_transform(pa_counties, 5070)\n\nvuln_with_county <- vulnerable_tracts_dist_5070 %>%\n  st_join(pa_counties_5070 %>% select(COUNTY_NAM))\n\n# Aggregate statistics by county\n\ncounty_summary <- vuln_with_county %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarise(\n    vulnerable_tracts          = n(),\n    underserved_tracts         = sum(underserved, na.rm = TRUE),\n    pct_underserved            = 100 * underserved_tracts / vulnerable_tracts,\n    avg_dist_mi_vulnerable     = mean(dist_to_hospital_mi, na.rm = TRUE),\n    vulnerable_population      = sum(total_pop, na.rm = TRUE),\n    vulnerable_pop_far_mi15    = sum(ifelse(underserved, total_pop, 0), na.rm = TRUE),\n    .groups = \"drop\")\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_summary %>%\n  arrange(desc(pct_underserved)) %>%\n  select(COUNTY_NAM, vulnerable_tracts, underserved_tracts, pct_underserved) %>%\n  slice_head(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 4\n  COUNTY_NAM vulnerable_tracts underserved_tracts pct_underserved\n  <chr>                  <int>              <int>           <dbl>\n1 BRADFORD                   1                  1             100\n2 COLUMBIA                   1                  1             100\n3 JUNIATA                    1                  1             100\n4 MONROE                     1                  1             100\n5 PERRY                      2                  2             100\n```\n\n\n:::\n\n```{.r .cell-code}\ncounty_summary %>%\n  arrange(desc(vulnerable_pop_far_mi15)) %>%\n  select(COUNTY_NAM, vulnerable_population, vulnerable_pop_far_mi15) %>%\n  slice_head(n = 5) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 3\n  COUNTY_NAM     vulnerable_population vulnerable_pop_far_mi15\n  <chr>                          <dbl>                   <dbl>\n1 PERRY                           5800                    5800\n2 BRADFORD                        5466                    5466\n3 CLEARFIELD                     16232                    5189\n4 DAUPHIN                         8410                    4018\n5 NORTHUMBERLAND                 13105                    4018\n```\n\n\n:::\n:::\n\n\n**Required county-level statistics:**\n\n- Number of vulnerable tracts\n- Number of underserved tracts  \n- Percentage of vulnerable tracts that are underserved\n- Average distance to nearest hospital for vulnerable tracts\n- Total vulnerable population\n\n**Questions to answer:**\n\n- **Which 5 counties have the highest percentage of underserved vulnerable tracts?**\n  - BRADFORD,COLUMBIA,JUNIATA,MONROE,PERRY\n- **Which counties have the most vulnerable people living far from hospitals?**\n  - PERRY(5800),BRADFORD(5466),CLEARFIELD(5189),DAUPHIN(4018),NORTHUMBERLAND(4018)\n- **Are there any patterns in where underserved counties are located?**\n  - Underserved counties tend to cluster in rural and lower-density parts of Pennsylvania, where hospital coverage is sparse and facilities are concentrated in metro hubs. You’ll often see higher shares along the northern/central rural corridor and Appalachian areas, reflecting longer travel distances and thinner provider networks relative to population.\n\n---\n\n#### Step 7: Create Summary Table \n\nCreate a professional table showing the top 10 priority counties for healthcare investment.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create and format priority counties table\n\npriority_tbl <- county_summary %>%\n  mutate(\n    # safety: replace any NAs used in scoring\n    across(c(vulnerable_pop_far_mi15, pct_underserved, avg_dist_mi_vulnerable,\n             vulnerable_population, vulnerable_tracts, underserved_tracts),\n           ~ tidyr::replace_na(., 0)),\n    # Priority metric\n    priority_score = 0.60 * rescale(vulnerable_pop_far_mi15) +\n                     0.25 * rescale(pct_underserved) +\n                     0.15 * rescale(avg_dist_mi_vulnerable)\n  ) %>%\n  arrange(desc(priority_score)) %>%\n  slice_head(n = 10) %>%\n  transmute(\n    County                         = COUNTY_NAM,\n    `Vulnerable tracts`            = vulnerable_tracts,\n    `Underserved tracts`           = underserved_tracts,\n    `% vulnerable underserved`     = percent(pct_underserved / 100, accuracy = 0.1),\n    `Avg distance (mi)`            = number(avg_dist_mi_vulnerable, accuracy = 0.1),\n    `Vulnerable people >15 mi`     = comma(vulnerable_pop_far_mi15),\n    `Priority score`               = number(priority_score, accuracy = 0.01)\n  )\n\n# Nicely formatted table\nknitr::kable(\n  priority_tbl,\n  caption = \"Top 10 Priority Pennsylvania Counties for Healthcare Investment\n  (Priority Score weights: 60% vulnerable people >15 mi, 25% % vulnerable underserved, 15% average distance)\",\n  booktabs = TRUE\n) |>\n  kableExtra::kable_styling(full_width = FALSE, font_size = 12)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"font-size: 12px; width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption style=\"font-size: initial !important;\">Top 10 Priority Pennsylvania Counties for Healthcare Investment\n  (Priority Score weights: 60% vulnerable people &gt;15 mi, 25% % vulnerable underserved, 15% average distance)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> County </th>\n   <th style=\"text-align:right;\"> Vulnerable tracts </th>\n   <th style=\"text-align:right;\"> Underserved tracts </th>\n   <th style=\"text-align:left;\"> % vulnerable underserved </th>\n   <th style=\"text-align:left;\"> Avg distance (mi) </th>\n   <th style=\"text-align:left;\"> Vulnerable people &gt;15 mi </th>\n   <th style=\"text-align:left;\"> Priority score </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> PERRY </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 100.0% </td>\n   <td style=\"text-align:left;\"> 17.7 </td>\n   <td style=\"text-align:left;\"> 5,800 </td>\n   <td style=\"text-align:left;\"> 1.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BRADFORD </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 100.0% </td>\n   <td style=\"text-align:left;\"> 16.7 </td>\n   <td style=\"text-align:left;\"> 5,466 </td>\n   <td style=\"text-align:left;\"> 0.96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> CLEARFIELD </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 40.0% </td>\n   <td style=\"text-align:left;\"> 10.1 </td>\n   <td style=\"text-align:left;\"> 5,189 </td>\n   <td style=\"text-align:left;\"> 0.72 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> DAUPHIN </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 50.0% </td>\n   <td style=\"text-align:left;\"> 10.0 </td>\n   <td style=\"text-align:left;\"> 4,018 </td>\n   <td style=\"text-align:left;\"> 0.62 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> NORTHUMBERLAND </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 20.0% </td>\n   <td style=\"text-align:left;\"> 12.8 </td>\n   <td style=\"text-align:left;\"> 4,018 </td>\n   <td style=\"text-align:left;\"> 0.57 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> JUNIATA </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 100.0% </td>\n   <td style=\"text-align:left;\"> 16.0 </td>\n   <td style=\"text-align:left;\"> 1,782 </td>\n   <td style=\"text-align:left;\"> 0.57 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> MONROE </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 100.0% </td>\n   <td style=\"text-align:left;\"> 17.6 </td>\n   <td style=\"text-align:left;\"> 1,299 </td>\n   <td style=\"text-align:left;\"> 0.53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> FOREST </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 50.0% </td>\n   <td style=\"text-align:left;\"> 15.2 </td>\n   <td style=\"text-align:left;\"> 2,701 </td>\n   <td style=\"text-align:left;\"> 0.53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ELK </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 25.0% </td>\n   <td style=\"text-align:left;\"> 11.0 </td>\n   <td style=\"text-align:left;\"> 3,343 </td>\n   <td style=\"text-align:left;\"> 0.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> COLUMBIA </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 100.0% </td>\n   <td style=\"text-align:left;\"> 16.9 </td>\n   <td style=\"text-align:left;\"> 918 </td>\n   <td style=\"text-align:left;\"> 0.49 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Requirements:**\n- Use `knitr::kable()` or similar for formatting\n- Include descriptive column names\n- Format numbers appropriately (commas for population, percentages, etc.)\n- Add an informative caption\n- Sort by priority (you decide the metric)\n\n---\n\n## Part 2: Comprehensive Visualization \n\nUsing the skills from Week 3 (Data Visualization), create publication-quality maps and charts.\n\n### Map 1: County-Level Choropleth \n\nCreate a choropleth map showing healthcare access challenges at the county level.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create county-level access map\n\n# 1) Reproject display layers to WGS84 (EPSG:4326)\ncrs_display <- 4326\npa_counties_4326 <- st_transform(pa_counties, crs_display)\nhospitals_4326   <- st_transform(hospitals, crs_display)\n\n# 2) Join county stats to county geometries\ncounty_map_4326 <- pa_counties_4326 %>%\n  left_join(\n    county_summary %>%\n      mutate(pct_underserved_prop = pct_underserved / 100), \n    by = \"COUNTY_NAM\"\n  )\n\n# 3) Choropleth (WGS84) + hospital points\nggplot(county_map_4326) +\n  geom_sf(aes(fill = pct_underserved_prop), color = \"white\", linewidth = 0.2) +\n  geom_sf(data = hospitals_4326, shape = 21, fill = \"white\", color = \"black\",\n          size = 1.1, alpha = 0.8, inherit.aes = FALSE) +\n  scale_fill_viridis_c(\n    option = \"cividis\",\n    na.value = \"grey90\",\n    name = \"Underserved share\\n(of vulnerable tracts)\",\n    labels = label_percent(accuracy = 1)\n  ) +\n  labs(\n    title    = \"Healthcare Access Challenges in Pennsylvania\",\n    subtitle = \"Counties filled by % of vulnerable tracts > 15 miles from a hospital\",\n    caption  = \"Sources: ACS 5-year (2022), lecture hospital dataset. Distances computed in EPSG:5070; map shown in WGS84.\"\n  ) +\n  theme_void() +\n  theme(\n    legend.position = \"right\",\n    plot.title      = element_text(face = \"bold\"),\n    plot.caption    = element_text(hjust = 0)\n  )\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/2.1-1.png){width=672}\n:::\n:::\n\n\n**Requirements:**\n- Fill counties by percentage of vulnerable tracts that are underserved\n- Include hospital locations as points\n- Use an appropriate color scheme\n- Include clear title, subtitle, and caption\n- Use `theme_void()` or similar clean theme\n- Add a legend with formatted labels\n\n---\n\n### Map 2: Detailed Vulnerability Map \n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create detailed tract-level map\n\n## 1)Ensure \"underserved\" exists; keep only vulnerable tracts and make a status label\nvuln_dist_4326 <- vulnerable_tracts_dist_5070 %>%\n  mutate(underserved = if (!\"underserved\" %in% names(.)) dist_to_hospital_mi > 15 else underserved) %>%\n  st_transform(crs_display) %>%\n  mutate(\n    status = ifelse(underserved, \"Underserved vulnerable\", \"Other vulnerable\")\n  )\n\n## 2)Map\ntracts_4326 <- sf::st_transform(census_tracts, 4326)\nggplot() +\n  # county boundaries (context; subtle)\n  geom_sf(data = pa_counties_4326, fill = NA, color = \"grey40\", linewidth = 0.3) +\n  \n  # tracts\n  geom_sf(data = tracts_4326, fill = NA, color = \"grey80\", linewidth = 0.05) +\n  \n  # vulnerable tracts\n  geom_sf(data = subset(vuln_dist_4326, status == \"Other vulnerable\"),\n  aes(fill = status), color = \"black\", linewidth = 0.15, alpha = 0.9) +\n  \n  # underserved vulnerable tracts\n  geom_sf(data = subset(vuln_dist_4326, status == \"Underserved vulnerable\"),\n  aes(fill = status), color = \"black\", linewidth = 0.15, alpha = 0.9) +\n  \n  # hospitals (points)\n  geom_sf(\n  data = hospitals_4326,\n  aes(shape = \"Hospitals\"),\n  fill = \"white\", color = \"black\",\n  size = 1.2, alpha = 0.9,\n  inherit.aes = FALSE,\n  show.legend = \"point\"\n) +\n  \n  # fills for tracts\n  scale_fill_manual(\n    name = NULL,\n    values = c(\"Other vulnerable\" = \"#9ecae1\", \"Underserved vulnerable\" = \"#08519c\")\n  ) +\n  # shape for hospitals + legend tweaks\n  scale_shape_manual(name = NULL, values = c(\"Hospitals\" = 21)) +\n  guides(\n    fill  = guide_legend(order = 1, override.aes = list(shape = NA)),\n    shape = guide_legend(order = 2, override.aes = list(fill = \"white\", color = \"black\", size = 2))\n  ) +\n  labs(\n    title    = \"Underserved Vulnerable Census Tracts in Pennsylvania\",\n    subtitle = \"Underserved = vulnerable tracts (>15 miles to nearest hospital); counties and tract grids shown for context\",\n    caption  = \"Sources: ACS 5-year (2022); hospital dataset. Distances: EPSG:5070; map: WGS84.\"\n  ) +\n  theme_void() +\n  theme(legend.position = \"right\", plot.title = element_text(face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/2.2-1.png){width=672}\n:::\n:::\n\n\n**Requirements:**\n\n- Show underserved vulnerable tracts in a contrasting color\n\n- Include county boundaries for context\n\n- Show hospital locations\n\n- Use appropriate visual hierarchy (what should stand out?)\n\n- Include informative title and subtitle\n\n---\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for vulnerable populations.\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create distribution visualization\n\n## A small helper used in captions\nmedian_dist <- median(vulnerable_tracts_dist_5070$dist_to_hospital_mi, na.rm = TRUE)\n\n## 1) People-weighted histogram of distances (highlighting the 15-mile threshold)\nvulnerable_tracts_dist_5070 |> \n  mutate(beyond15 = factor(dist_to_hospital_mi > 15,\n                           levels = c(FALSE, TRUE),\n                           labels = c(\"≤ 15 miles\", \"> 15 miles\"))) |>\n  ggplot(aes(x = dist_to_hospital_mi, weight = total_pop, fill = beyond15)) +\n  geom_histogram(binwidth = 1, boundary = 0, color = \"white\") +\n  scale_fill_manual(values = c(\"≤ 15 miles\" = \"#9ecae1\", \"> 15 miles\" = \"#08519c\"),\n                    name = NULL) +\n  scale_y_continuous(labels = comma) +\n  labs(\n    title = \"How far are vulnerable residents from hospitals?\",\n    x = \"Distance to nearest hospital (miles)\",\n    y = \"Residents (people)\"\n  ) +\n  theme_minimal(base_size = 12) +\n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# 2) Scatter: Distance vs. tract population (vulnerable tracts)\nggplot(vulnerable_tracts_dist_5070,\n       aes(x = dist_to_hospital_mi, y = total_pop, color = underserved)) +\n  geom_point(alpha = 0.7) +\n  scale_y_continuous(labels = comma, trans = \"log10\") +\n  scale_color_manual(values = c(`FALSE` = \"#9ecae1\", `TRUE` = \"#08519c\"),\n                     name = \"Underserved\\n(>15 mi)\") +\n  labs(\n    title = \"Distance vs. population size across vulnerable tracts\",\n    x = \"Distance to nearest hospital (miles)\",\n    y = \"Tract population (people)\"\n  ) +\n  theme_minimal(base_size = 12) +\n  theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/unnamed-chunk-1-2.png){width=672}\n:::\n:::\n\n\n**Suggested chart types:**\n\n- Histogram or density plot of distances\n\n- Box plot comparing distances across regions\n\n- Bar chart of underserved tracts by county\n\n- Scatter plot of distance vs. vulnerable population size\n\n**Requirements:**\n\n- Clear axes labels with units\n\n- Appropriate title\n\n- Professional formatting\n\n- Brief interpretation (1-2 sentences as a caption or in text)\n  - For histogram: Most vulnerable residents live within about %.1f miles; the right tail beyond 15 miles is relatively small.\n  - For scatter plot: Most high-population vulnerable tracts are within ~15 miles; the far-distance outliers tend to be lower-density.\n\n---\n\n## Part 3: Bring Your Own Data Analysis \n\nChoose your own additional spatial dataset and conduct a supplementary analysis.\n\n### Challenge Options\n\nChoose ONE of the following challenge exercises, or propose your own research question using OpenDataPhilly data (https://opendataphilly.org/datasets/). \n\n---\n\n#### Education & Youth Services\n\n**Option A: Educational Desert Analysis**\n- **Data:** Schools, Libraries, Recreation Centers, Census tracts (child population)\n- **Question:** \"Which neighborhoods lack adequate educational infrastructure for children?\"\n- **Operations:** Buffer schools/libraries (0.5 mile walking distance), identify coverage gaps, overlay with child population density\n- **Policy relevance:** School district planning, library placement, after-school program siting\n\n**Option B: School Safety Zones**\n- **Data:** Schools, Crime Incidents, Bike Network\n- **Question:** \"Are school zones safe for walking/biking, or are they crime hotspots?\"\n- **Operations:** Buffer schools (1000ft safety zone),spatial join with crime incidents, assess bike infrastructure coverage\n- **Policy relevance:** Safe Routes to School programs, crossing guard placement\n\n---\n\n#### Environmental Justice\n\n**Option C: Green Space Equity** \n- **Data:** Parks, Street Trees, Census tracts (race/income demographics)\n- **Question:** \"Do low-income and minority neighborhoods have equitable access to green space?\"\n- **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree canopy or park acreage per capita, compare by demographics\n- **Policy relevance:** Climate resilience, environmental justice, urban forestry investment\n---\n\n#### Public Safety & Justice\n\n**Option D: Crime & Community Resources**\n- **Data:** Crime Incidents, Recreation Centers, Libraries, Street Lights\n- **Question:** \"Are high-crime areas underserved by community resources?\"\n- **Operations:** Aggregate crime counts to census tracts or neighborhoods, count community resources per area, spatial correlation analysis\n- **Policy relevance:** Community investment, violence prevention strategies\n---\n\n#### Infrastructure & Services\n\n**Option E: Polling Place Accessibility**\n- **Data:** Polling Places, SEPTA stops, Census tracts (elderly population, disability rates)\n- **Question:** \"Are polling places accessible for elderly and disabled voters?\"\n- **Operations:** Buffer polling places and transit stops, identify vulnerable populations, find areas lacking access\n- **Policy relevance:** Voting rights, election infrastructure, ADA compliance\n\n---\n\n#### Health & Wellness\n\n**Option F: Recreation & Population Health**\n- **Data:** Recreation Centers, Playgrounds, Parks, Census tracts (demographics)\n- **Question:** \"Is lack of recreation access associated with vulnerable populations?\"\n- **Operations:** Calculate recreation facilities per capita by neighborhood, buffer facilities for walking access, overlay with demographic indicators\n- **Policy relevance:** Public health investment, recreation programming, obesity prevention\n\n---\n\n#### Emergency Services\n\n**Option G: EMS Response Coverage**\n- **Data:** Fire Stations, EMS stations, Population density, High-rise buildings\n- **Question:** \"Are population-dense areas adequately covered by emergency services?\"\n- **Operations:** Create service area buffers (5-minute drive = ~2 miles), assess population coverage, identify gaps in high-density areas\n- **Policy relevance:** Emergency preparedness, station siting decisions\n\n---\n\n#### Arts & Culture\n\n**Option H: Cultural Asset Distribution**\n- **Data:** Public Art, Museums, Historic sites/markers, Neighborhoods\n- **Question:** \"Do all neighborhoods have equitable access to cultural amenities?\"\n- **Operations:** Count cultural assets per neighborhood, normalize by population, compare distribution across demographic groups\n- **Policy relevance:** Cultural equity, tourism, quality of life, neighborhood identity\n\n---\n\n### Data Sources\n\n**OpenDataPhilly:** https://opendataphilly.org/datasets/\n- Most datasets available as GeoJSON, Shapefile, or CSV with coordinates\n- Always check the Metadata for a data dictionary of the fields.\n\n**Additional Sources:**\n- **Pennsylvania Open Data:** https://data.pa.gov/\n- **Census Bureau (via tidycensus):** Demographics, economic indicators, commute patterns\n- **TIGER/Line (via tigris):** Geographic boundaries\n\n### Recommended Starting Points\n\n**If you're feeling confident:** Choose an advanced challenge with multiple data layers. \n**If you are a beginner, choose something more manageable that helps you understand the basics**\n\n\n**If you have a different idea:** Propose your own question! Just make sure:\n- You can access the spatial data\n- You can perform at least 2 spatial operations\n\n### My Analysis\n\n**My Task:**\n\n1. **Find and load additional data**\n   - Document your data source\n   - Check and standardize the CRS\n   - Provide basic summary statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load your additional dataset\n\n## 1) Philly tracts\n\noptions(tigris_progress = FALSE, tigris_use_cache = TRUE)\nphl_tracts <- tracts(state = \"PA\", county = \"Philadelphia\", cb = TRUE, year = 2022)\n\nphl_boundary <- counties(state = \"PA\", cb = TRUE, year = 2022) %>%\n  filter(NAME == \"Philadelphia\")\n\n## 2)Reach children data\nphl_children <- get_acs(\n  geography = \"tract\",\n  variables = c(child_pop = \"B09001_001\"),\n  state = \"PA\",\n  county = \"Philadelphia\",\n  year = 2022,\n  output = \"wide\"\n)\n\ntracts_with_children <- phl_tracts %>%\n  left_join(phl_children, by = \"GEOID\")\n\n## 3)Reach POI\n### recreation center raw data(philly)\nPPR_Program_sites <- st_read(\"https://opendata.arcgis.com/api/v3/datasets/9eb26a787a6e448ba426eea7f9f0d93a_0/downloads/data?format=geojson&spatialRefId=4326\", quiet = TRUE)\n\n### schools raw data(philly)\nschools <- st_read(\"https://hub.arcgis.com/api/v3/datasets/d46a7e59e2c246c891fbee778759717e_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1\", quiet = TRUE)\n\n### libraries raw data(global)\nlibraries <- st_read( \"D:/PersonalFiles/MUSA/PPA/portfolio/portfolio-setup-demiyang12/assignments/assignment_2/data/Libraries/Libraries.gpkg\",layer = \"parsed\", quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nInteger64 values larger than 9.0072e+15 lost significance after conversion to double;\nuse argument int64_as_string = TRUE to import them lossless, as character\n```\n\n\n:::\n\n```{.r .cell-code}\n## 4) Check the data\n\nsummary_rows <- tibble::tibble(\n  Dataset = c(\"Census Tracts (phl_tracts)\", \n              \"Children ACS (phl_children)\", \n              \"Schools\", \n              \"Libraries\"),\n  Rows = c(\n    nrow(phl_tracts),\n    nrow(phl_children),\n    nrow(schools),\n    nrow(libraries)\n  )\n)\n\nkable(\n  summary_rows,\n  caption = \"Summary of Raw Datasets Loaded\",\n  align = \"c\"\n) %>%\n  kable_styling(\n    full_width = FALSE,\n    bootstrap_options = c(\"striped\", \"hover\", \"condensed\"),\n    position = \"center\"\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Summary of Raw Datasets Loaded</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> Dataset </th>\n   <th style=\"text-align:center;\"> Rows </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> Census Tracts (phl_tracts) </td>\n   <td style=\"text-align:center;\"> 408 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> Children ACS (phl_children) </td>\n   <td style=\"text-align:center;\"> 408 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> Schools </td>\n   <td style=\"text-align:center;\"> 495 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> Libraries </td>\n   <td style=\"text-align:center;\"> 81082 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Data cleaning\n## 1)Recreation center\nnames(PPR_Program_sites)\n\n### Check the unique values containing \"Recreation\" in the field and see how they are written\nunique(unlist(PPR_Program_sites))\nunique(PPR_Program_sites$FACILITY_TYPE)\n\n### Filter\"Recreation Centers\"\nrecreation_centers <- PPR_Program_sites %>%\n  filter(\n    grepl(\"recreation\", PARK_NAME, ignore.case = TRUE)\n  )\n\n### See results\nnrow(recreation_centers)\nhead(recreation_centers)\n\n## 2)Libraries\n### reproject CRS of libraries to boundary's \nst_crs(libraries)\nst_crs(phl_boundary)\nlibraries <- st_transform(libraries, st_crs(phl_boundary))\n\n### Cut out the libraries within the Philly area\nlibraries_phl <- st_intersection(libraries, phl_boundary)\n\n### See results\nnrow(libraries_phl)\nhead(libraries_phl)\n\n\n## 3)Summary table\nsummary_table <- tibble(\n  Dataset = c(\"Libraries\", \n              \"Schools\", \n              \"Recreation Centers\"),\n  Features = c(nrow(libraries_phl), \n               nrow(schools), \n               nrow(recreation_centers)),\n  CRS = c(st_crs(libraries)$input, \n          st_crs(schools)$input, \n          st_crs(PPR_Program_sites)$input)\n)\n\nkable(summary_table, caption = \"Summary of Datasets Used\")\n```\n:::\n\n\n**Questions to answer:**\n\n- **What dataset did you choose and why?**\n  - I selected three datasets that represent educational and community infrastructure in Philadelphia: Libraries; Schools; Recreation Centers.\n  \n- **What is the data source and date?**\n  - Libraries: Extracted from OpenStreetMap (via global GeoPackage export, likely updated in 2024–2025).\n  - Schools: From OpenDataPhilly(https://opendataphilly.org/datasets/schools/?utm_source=chatgpt.com) – Schools dataset, maintained by the City of Philadelphia.\n  - Recreation Centers: From Philadelphia Parks & Recreation Program Sites dataset, also hosted on OpenDataPhilly.\n  - All datasets were accessed in October. 2025.\n  \n- **How many features does it contain?**\n  - For libraries data, it has 81082 features at beginning, containing the libraries all over the world. After filter the libraries in Philly, the number of features shrinks to 80.\n  - For schools, there are 495 schools(not including universities and colleges) in Philly.\n  - For recreation centers, there are 67 of them in Philly.\n  \n- **What CRS is it in? Did you need to transform it?**\n  - Libraries data is in NAD 83.\n  - Schools data is in WGS 84.\n  - Recreations data is in WGS 84.\n\n---\n\n2. **Pose a research question**\n\n**Write a clear research statement that your analysis will answer.**\n\n- Which neighborhoods in Philadelphia lack adequate educational infrastructure for children?\n\n---\n\n3. **Conduct spatial analysis**\n\nUse at least TWO spatial operations to answer your research question.\n\n**Required operations (choose 2+):**\n- Buffers\n- Spatial joins\n- Spatial filtering with predicates\n- Distance calculations\n- Intersections or unions\n- Point-in-polygon aggregation\n\n**Your Task:**\n\n::: {.cell}\n\n```{.r .cell-code}\n# Unify the coordinates and prepare the buffer\n\n## 1) Reproject all layers to 5070\ncrs_analysis <- 5070\ncrs_map      <- 4326\nhalf_mile_m  <- set_units(0.3, \"mile\") %>% set_units(\"m\") %>% drop_units()\n\nphl_tracts_5070        <- st_transform(phl_tracts, crs_analysis)\nphl_boundary_5070      <- st_transform(phl_boundary, crs_analysis)\nschools_5070           <- st_transform(schools, crs_analysis)\nrecreation_centers_5070<- st_transform(recreation_centers, crs_analysis)\nlibraries_phl_5070     <- st_transform(libraries_phl, crs_analysis)\n\n\n## 2) Create buffer(schools & libraries, recreation centers do sensitivity)\nbuf_schools   <- st_buffer(schools_5070,  dist = half_mile_m)\nbuf_libraries <- st_buffer(libraries_phl_5070, dist = half_mile_m)\n\n## 3) Accessible region\naccess_union_core <- st_union(st_union(buf_schools), st_union(buf_libraries))\n\n## 4) Use recreation center to sensitivity comparison\nbuf_recreation <- st_buffer(recreation_centers_5070, dist = half_mile_m)\naccess_union_all <- st_union(access_union_core, st_union(buf_recreation))\n\n## 5)Check the result\nst_crs(schools_5070)\nst_crs(libraries_phl_5070)\nst_crs(phl_tracts_5070)\n\nggplot() +\n  geom_sf(data = phl_boundary_5070, fill = NA, color = \"black\") +\n  geom_sf(data = buf_schools, fill = \"darkslateblue\", alpha = 0.3) +\n  geom_sf(data = buf_libraries, fill = \"steelblue\", alpha = 0.3) +\n  labs(title = \"0.5-mile Buffers Around Schools and Libraries\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.2-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate the \"education coverage rate\" and \"child density\" of each census tracts\n\n## 1) Area (m²) and child density (per square kilometer)\n\ntracts_metrics <- phl_tracts_5070 %>%\n  mutate(tract_area_m2 = as.numeric(st_area(geometry)),\n         tract_area_km2 = tract_area_m2 / 1e6) %>%\n  left_join(tracts_with_children %>% st_drop_geometry() %>%\n              select(GEOID, child_pop = child_popE), by = \"GEOID\") %>%\n  mutate(child_density = ifelse(tract_area_km2 > 0, child_pop / tract_area_km2, NA_real_))\n\n## 2) Coverage rate = Intersection area between the reachable zone and the census zone (m²)\nintersect_access <- st_intersection(\n  tracts_metrics %>% select(GEOID),\n  st_make_valid(access_union_core)\n) %>%\n  mutate(access_area_m2 = as.numeric(st_area(geometry))) %>%\n  st_drop_geometry() %>%\n  group_by(GEOID) %>%\n  summarize(access_area_m2 = sum(access_area_m2, na.rm = TRUE), .groups = \"drop\")\n\ntracts_metrics <- tracts_metrics %>%\n  left_join(intersect_access, by = \"GEOID\") %>%\n  mutate(access_area_m2 = coalesce(access_area_m2, 0),\n         access_ratio   = pmin(access_area_m2 / tract_area_m2, 1))\n\n## 3)Check the statistical distribution of child_density and access_ratio\nsummary(tracts_metrics[, c(\"child_density\", \"access_ratio\")])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n child_density      access_ratio             geometry  \n Min.   :    0.0   Min.   :0.0000   MULTIPOLYGON :408  \n 1st Qu.:  565.8   1st Qu.:0.5494   epsg:5070    :  0  \n Median : 1276.6   Median :0.8909   +proj=aea ...:  0  \n Mean   : 1495.1   Mean   :0.7438                      \n 3rd Qu.: 2175.0   3rd Qu.:1.0000                      \n Max.   :10064.8   Max.   :1.0000                      \n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(tracts_metrics) +\n  geom_histogram(aes(x = child_density), bins = 30, fill = \"lightblue\", color = \"white\") +\n  labs(title = \"Distribution of Child Density (children/km²)\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(tracts_metrics) +\n  geom_histogram(aes(x = access_ratio), bins = 30, fill = \"darkseagreen3\", color = \"white\") +\n  labs(title = \"Distribution of Access Ratio (coverage rate)\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.3-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = tracts_metrics, aes(fill = child_density), color = NA) +\n  scale_fill_viridis_c(option=\"mako\", direction=-1) +\n  labs(title = \"Child Density by Census Tract\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.3-3.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = tracts_metrics, aes(fill = access_ratio), color = NA) +\n  scale_fill_viridis_c(option=\"mako\", direction=-1) +\n  labs(title = \"Education Access Ratio by Census Tract\")\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.3-4.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define education desert\n\np_target <- 0.25\n\ntracts_metrics <- tracts_metrics %>%\n  mutate(\n    z_child   = as.numeric(scale(child_density)), \n    z_access  = as.numeric(scale(-access_ratio)),\n    score     = 0.5 * z_child + 0.5 * z_access \n  ) %>%\n  mutate(\n    cutoff = quantile(score, 1 - p_target, na.rm = TRUE),\n    vulnerable_local = score >= cutoff\n  )\n\n\ncutoff_value <- unique(tracts_metrics$cutoff)\ncount_table  <- table(tracts_metrics$vulnerable_local)\npercent_vuln <- mean(tracts_metrics$vulnerable_local, na.rm = TRUE)\n\nsummary_vulnerable <- tibble(\n  Metric = c(\"Cutoff Score\", \n             \"Tracts classified as TRUE (Educational Desert)\", \n             \"Tracts classified as FALSE\",\n             \"Share of Desert Tracts\"),\n  Value = c(\n    round(cutoff_value, 3),\n    as.integer(count_table[\"TRUE\"]),\n    as.integer(count_table[\"FALSE\"]),\n    paste0(round(percent_vuln * 100, 1), \"%\")\n  )\n)\n\nkable(summary_vulnerable, caption = \"Summary of Educational Desert Classification\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Summary of Educational Desert Classification\n\n|Metric                                         |Value |\n|:----------------------------------------------|:-----|\n|Cutoff Score                                   |0.352 |\n|Tracts classified as TRUE (Educational Desert) |102   |\n|Tracts classified as FALSE                     |306   |\n|Share of Desert Tracts                         |25%   |\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Draw the map\n\n## 1) Back to WGS84\ntracts_map           <- st_transform(tracts_metrics, crs_map)\nphl_boundary_plot    <- st_transform(phl_boundary_5070, crs_map)\nschools_plot         <- st_transform(schools, crs_map) %>% mutate(Type = \"Schools\")\nlibraries_plot       <- st_transform(libraries_phl, crs_map) %>% mutate(Type = \"Libraries\")\n\nfacilities <- dplyr::bind_rows(\n  dplyr::select(schools_plot,  Type),\n  dplyr::select(libraries_plot, Type)\n)\n\n## 2) map\nggplot() +\n  geom_sf(\n    data = tracts_map, \n    aes(fill = vulnerable_local), \n    color = \"grey20\", size = 0.15\n  ) +\n  geom_sf(\n    data = phl_boundary_plot, \n    fill = NA, color = \"black\", linewidth = 0.4\n  ) +\n  geom_sf(\n    data = facilities,\n    aes(color = Type),\n    shape = 16,\n    size = 1,\n    alpha = 0.3,\n    show.legend = TRUE\n  ) +\n  scale_fill_manual(\n    values = c(\"FALSE\" = \"whitesmoke\", \"TRUE\" = \"wheat\"),\n    name = \"Educational desert\",\n    labels = c(\"False\", \"True\")\n  ) +\n  scale_color_manual(\n    name = \"Facilities\",\n    values = c(\"Schools\" = \"sienna\", \"Libraries\" = \"cornsilk4\", alpha = 0.3)\n  ) +\n  guides(\n    color = guide_legend(override.aes = list(shape = 16, size = 3, alpha = 1))\n  ) +\n  labs(\n    title = \"Educational Desert in Philadelphia\",\n    subtitle = \"Areas with high child density and low coverage of schools & libraries\",\n    caption = \"CRS for map = WGS84\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"right\",\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nlegend_table <- tibble(\n  Category = c(\"Educational Desert\", \"Schools\", \"Libraries\"),\n  Meaning = c(\"High child density, low access\", \n              \"Education facilities\", \n              \"Public libraries providing learning access\")\n)\nkable(legend_table, caption = \"Legend Explanation\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Legend Explanation\n\n|Category           |Meaning                                    |\n|:------------------|:------------------------------------------|\n|Educational Desert |High child density, low access             |\n|Schools            |Education facilities                       |\n|Libraries          |Public libraries providing learning access |\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sensitivity test (add Recreation Centers)\n\n## 1) Calculate the coverage rate after adding recreation centers\"\nintersect_access_all <- st_intersection(\n  tracts_metrics %>% select(GEOID),\n  st_make_valid(access_union_all) \n) %>%\n  mutate(access_area_m2_all = as.numeric(st_area(geometry))) %>%\n  st_drop_geometry() %>%\n  group_by(GEOID) %>%\n  summarize(access_area_m2_all = sum(access_area_m2_all, na.rm = TRUE), .groups = \"drop\")\n\ntracts_metrics_all <- tracts_metrics %>%\n  left_join(intersect_access_all, by = \"GEOID\") %>%\n  mutate(\n    access_area_m2_all = coalesce(access_area_m2_all, 0),\n    access_ratio_all   = pmin(access_area_m2_all / tract_area_m2, 1),\n    z_access_all       = as.numeric(scale(-access_ratio_all)),\n\n    score_all          = 0.5 * z_child + 0.5 * z_access_all\n  ) %>%\n  mutate(\n    cutoff_all = quantile(score_all, 1 - p_target, na.rm = TRUE),\n    vulnerable_all = score_all >= cutoff_all\n  )\n\n## 2) Compare with the previous results\nsens_compare <- tracts_metrics_all %>%\n  st_drop_geometry() %>%\n  select(GEOID, vulnerable_core = vulnerable_local, vulnerable_all)\n\nsens_compare <- sens_compare %>%\n  mutate(\n    status = dplyr::case_when(\n      vulnerable_core &  vulnerable_all  ~ \"Stable: Desert\",\n      !vulnerable_core & !vulnerable_all ~ \"Stable: Not Desert\",\n      vulnerable_core & !vulnerable_all  ~ \"Flipped: Rescued by Rec\", \n      !vulnerable_core &  vulnerable_all ~ \"Flipped: Newly Desert\", \n      TRUE ~ \"Other\"\n    )\n  )\n\n## 3) Summary table for sensitivity\ntotal_tracts <- nrow(sens_compare)\nsens_table <- sens_compare %>%\n  count(status, name = \"Count\") %>%\n  mutate(Share = paste0(round(100 * Count / total_tracts, 1), \"%\")) %>%\n  arrange(desc(Count))\n\n## 4) The degree of overlap between two sets of \"deserts\"\njaccard <- with(sens_compare, sum(vulnerable_core & vulnerable_all, na.rm = TRUE) /\n                  sum(vulnerable_core | vulnerable_all, na.rm = TRUE))\n\n\nkable(\n  bind_rows(\n    sens_table,\n    tibble(\n      status = \"Jaccard (core vs all)\",\n      Count  = NA_integer_,\n      Share  = paste0(round(jaccard * 100, 1), \"%\")\n    )\n  ),\n  caption = \"Sensitivity: Effect of Adding Recreation Centers on 'Educational Desert' Classification\"\n)\n```\n\n::: {.cell-output-display}\n\n\nTable: Sensitivity: Effect of Adding Recreation Centers on 'Educational Desert' Classification\n\n|status                  | Count|Share |\n|:-----------------------|-----:|:-----|\n|Stable: Not Desert      |   297|72.8% |\n|Stable: Desert          |    93|22.8% |\n|Flipped: Newly Desert   |     9|2.2%  |\n|Flipped: Rescued by Rec |     9|2.2%  |\n|Jaccard (core vs all)   |    NA|83.8% |\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Map the \"flipped\" tracts\n\n## 1) reproject CRS to WGS 84\ntracts_status_map <- tracts_metrics %>%\n  select(GEOID, geometry) %>%\n  left_join(sens_compare %>% select(GEOID, status), by = \"GEOID\") %>%\n  st_transform(crs_map)\n\nggplot() +\n  geom_sf(data = tracts_status_map, aes(fill = status), color = \"grey30\") +\n  geom_sf(data = phl_boundary_plot, fill = NA, color = \"black\", linewidth = 0.4) +\n\n  scale_fill_manual(\n    name = \"Classification change\",\n    values = c(\n      \"Stable: Desert\"        = \"wheat\",\n      \"Stable: Not Desert\"    = \"#f7f7f7\",\n      \"Flipped: Rescued by Rec\" = \"olivedrab\",\n      \"Flipped: Newly Desert\" = \"#377eb8\"\n    )\n  ) +\n  scale_color_manual(\n    name = \"Facilities\",\n    values = c(\"Schools\" = \"mistyrose3\", \"Libraries\" = \"cornsilk4\")\n  ) +\n  guides(\n    color = guide_legend(override.aes = list(shape = 16, size = 3, alpha = 1))\n  ) +\n  labs(\n    title = \"Sensitivity Map: Tracts That Flip When Adding Recreation Centers\",\n    subtitle = \"‘Rescued by Rec’ = Desert under core (schools+libraries) but NOT under all (including recreation)\",\n    caption = \"CRS = WGS84\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"right\",\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](assignment2_SpatialAnalysisAndVisualization_files/figure-html/3.7-1.png){width=672}\n:::\n:::\n\n\n**Analysis requirements:**\n\n- Clear code comments explaining each step\n\n- Appropriate CRS transformations\n\n- Summary statistics or counts\n\n- At least one map showing your findings\n- Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\n\n- Child density is strongly **right-skewed**. Most tracts have low values with a few high outliers, so when combined with low access these tails tend to rank into the highest scores.\n\n- Access ratio **piles up at 1.0**. Many tracts are fully covered; most variation lives on partially covered edge tracts.\n\n- Hotspots for children vs. coverage **do not fully coincide**, creating cross-areas of **\"high need × low access\"** that rise in the composite score.\n\n- Sensitivity shows stability with some churn. Stable desert 93; stable non-desert 297; flipped both ways 9 each; Jaccard overlap 83.8%. Recreation centers shift rankings mainly around the threshold.\n\n- Overall, educational accessibility in Philadelphia is **quite strong**. The histogram of access ratios shows a heavy spike at 1.0, indicating that most tracts are fully covered by at least one school or library within a 0.5-mile radius. Spatially, only a few **peripheral or industrial tracts** exhibit low accessibility, suggesting an overall well-distributed and accessible educational infrastructure.\n\nHowever, when overlaid with child population density, a few neighborhoods—particularly parts of **North Philadelphia and the southwest low-income areas**-emerge as pockets of high need but low access, forming the city’s main \"educational desert\" zones.\n\n**Limitations:**\n- The “desert” share is **fixed at 25%**, meaning results indicate relative prioritization, not the true shortage of facilities. Even if new schools are added, there will always be a top 25%.\n\n- Access is purely spatial—distance-based—without accounting for **facility capacity, quality, or transportation barriers**. It measures potential accessibility, not real educational equity.\n\n- Equal weights (0.5/0.5) are simple but subjective; weights should ideally reflect policy priorities or empirical evidence.\n\n## Finally - A few comments about your incorporation of feedback!\n\n- To make sure that I can take responsibilities to my codes, I added comment lines everywhere I might need.\n\n- To make sure the tables are readable for both readers and me, I visualized important results of every chunk in part 3.\n\n---\n\n## Submission Requirements\n\n**What to submit:**\n\n1. **Rendered HTML document posted to your course portfolio** with all code, outputs, maps, and text\n   - Use `embed-resources: true` in YAML so it's a single file\n   - All code should run without errors\n   - All maps and charts should display correctly\n\n**File naming:** `LastName_FirstName_Assignment2.html` and `LastName_FirstName_Assignment2.qmd`\n\n---\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}