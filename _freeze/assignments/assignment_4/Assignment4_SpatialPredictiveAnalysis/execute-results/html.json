{
  "hash": "0452f8de8f7cb3bf92d837b88f07be4d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Predictive Policing - Technical Implementation\"\nsubtitle: \"Exploring Burglaries Patterns in Chicago and Predictive Modeling with 311 Data\"\nauthor: \"Yuqing(Demi) Yang\"\ndate: today\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n## Assignment Overview\n\nIn this lab, you will apply the spatial predictive modeling techniques demonstrated in the class exercise to a 311 service request type of your choice. You will build a complete spatial predictive model, document your process, and interpret your results.\n\n### Timeline & Deliverables\n\n**Due Date:** November 17, 2025, 10:00AM\n\n**Deliverable:** One rendered document, posted to your portfolio website.\n\n### Learning Goals\n\nBy completing this assignment, you will demonstrate your ability to:\n\n-   Adapt example code to analyze a new dataset\n-   Build spatial features for predictive modeling\n-   Apply count regression techniques to spatial data\n-   Implement spatial cross-validation\n-   Interpret and communicate model results\n-   Critically evaluate model performance\n\n------------------------------------------------------------------------\n\n# Step 0: Set Up\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(tidyverse)      # Data manipulation\nlibrary(sf)             # Spatial operations\nlibrary(here)           # Relative file paths\nlibrary(viridis)        # Color scales\nlibrary(terra)          # Raster operations (replaces 'raster')\nlibrary(spdep)          # Spatial dependence\nlibrary(FNN)            # Fast nearest neighbors\nlibrary(MASS)           # Negative binomial regression\nlibrary(patchwork)      # Plot composition (replaces grid/gridExtra)\nlibrary(knitr)          # Tables\nlibrary(kableExtra)     # Table formatting\nlibrary(classInt)       # Classification intervals\nlibrary(here)\n\n# Spatstat split into sub-packages\nlibrary(spatstat.geom)    # Spatial geometries\nlibrary(spatstat.explore) # Spatial exploration/KDE\n\n# Set options\noptions(scipen = 999)  # No scientific notation\nset.seed(5080)         # Reproducibility\n\n# Create consistent theme for visualizations\ntheme_default <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n\n# Set as default\ntheme_set(theme_default())\n\ncat(\"✓ All packages loaded successfully!\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ All packages loaded successfully!\n```\n\n\n:::\n:::\n\n\n# Step 1: Getting the Data\n\n## 1.1 Load Chicago Spatial Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load police districts (used for spatial cross-validation)\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n\n# Load police beats (smaller administrative units)\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") %>%\n  st_transform('ESRI:102271')\n\ncat(\"  - Police districts:\", nrow(policeDistricts), \"\\n\")\ncat(\"  - Police beats:\", nrow(policeBeats), \"\\n\")\n```\n:::\n\n\n## 1.2 Load 311 Rodent Baiting Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrb <- read_csv(\"data/311_Service_Requests_-_Rodent_Baiting_-_Historical_20251114.csv\")\nhead(rb)\n\nrb_sf <- rb %>%\n  filter(!is.na(Latitude), !is.na(Longitude)) %>% \n  st_as_sf(coords = c(\"Longitude\", \"Latitude\"), crs = 4326) %>% \n  st_transform(\"ESRI:102271\")  \n\nrb_sf <- rb_sf %>% \n  filter(st_within(., chicagoBoundary, sparse = FALSE))\n\n# filter 2017 data\nrb_sf$CreationDate <- as.Date(rb_sf$`Creation Date`, format = \"%m/%d/%Y\")\nrb_sf_2017 <- rb_sf %>% \n  filter(format(CreationDate, \"%Y\") == \"2017\")\n```\n:::\n\n\n## 1.3 Load Burglary Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load from provided data file (downloaded from Chicago open data portal)\nburglaries <- st_read(\"data/burglaries.shp\") %>% \n  st_transform('ESRI:102271')\n\n# Check the data\ncat(\"  - Number of burglaries:\", nrow(burglaries), \"\\n\")\ncat(\"  - CRS:\", st_crs(burglaries)$input, \"\\n\")\n```\n:::\n\n\n## 1.4 Visualize Point Data\n\n### 1.4.1 Rodent Baiting Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map for Rodent Baiting\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = rb_sf_2017, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Rodent Baiting 311 Service Requests\",\n    subtitle = paste0(\"Chicago, n = \", nrow(rb_sf_2017))\n  )\n\n# Density surface using 311 Rodent Baiting data\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(rb_sf_2017)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation of Rodent Baiting Requests\"\n  )\n\n# Combine plots using patchwork\np1 + p2 + \n  plot_annotation(\n    title = \"Spatial Distribution of Rodent Baiting 311 Requests in Chicago\",\n    tag_levels = \"A\"\n  )\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-5-1.png){width=960}\n:::\n:::\n\n\n-   The maps above show the spatial distribution of Rodent Baiting 311 requests across Chicago.\\\n-   The point map on the left illustrates the raw locations of all reported rodent issues. The large number of points makes the overall pattern dense, but we can still see clear clusters in the northern and western parts of the city.\\\n-   The density map on the right provides a smoother view of these patterns. Several strong hotspots emerge, especially in the Northwest Side and Near North areas. In contrast, the southern and far southwestern parts of Chicago show much lower intensity.\n\n## 1.4.2 Burgalaries Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map for Burglaries (P3)\np3 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = burglaries, color = \"#003f5c\", size = 0.15, alpha = 0.5) +\n  labs(\n    title = \"Residential Burglaries\",\n    subtitle = paste0(\"Chicago, n = \", nrow(burglaries))\n  )\n\n# Density surface for Burglaries (P4)\np4 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(burglaries)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation of Residential Burglaries\"\n  )\n\n# Combine P3 & P4\np3 + p4 +\n  plot_annotation(\n    title = \"Spatial Distribution of Residential Burglaries in Chicago\",\n    tag_levels = \"A\"\n  )\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n# Step 2: Fishnet Grid Creation\n\n## 2.1 Create Fishnet Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create 500m x 500m grid\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,  # 500 meters per cell\n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number())\n\n# Keep only cells that intersect Chicago\nfishnet <- fishnet[chicagoBoundary, ]\n\n# View basic info\ncat(\"  - Number of cells:\", nrow(fishnet), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of cells: 2458 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cell size:\", 500, \"x\", 500, \"meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cell size: 500 x 500 meters\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cell area:\", round(st_area(fishnet[1,])), \"square meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cell area: 250000 square meters\n```\n\n\n:::\n:::\n\n\n## 2.2 Aggregate data to Grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join: which cell contains each rodent baiting request/burglaries?\n\nrodent_fishnet <- st_join(rb_sf_2017, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarise(countRodent = n(), .groups = \"drop\")\n\nburglary_fishnet <- st_join(burglaries, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarise(countBurglaries = n(), .groups = \"drop\")\n\n# Join back to fishnet (cells with 0 requests will be NA)\n\nfishnet <- fishnet %>%\n  left_join(rodent_fishnet,   by = \"uniqueID\") %>%\n  left_join(burglary_fishnet, by = \"uniqueID\") %>%\n  mutate(\n    countRodent     = tidyr::replace_na(countRodent, 0),\n    countBurglaries = tidyr::replace_na(countBurglaries, 0)\n  )\n```\n:::\n\n\n-   Summary statistics for Rodent baiting request\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(summary(fishnet$countRodent))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.00    2.00   11.00   20.68   30.00  180.00 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCells with zero rodent requests:\",\n    sum(fishnet$countRodent == 0), \"/\",\n    nrow(fishnet), \"(\",\n    round(100 * sum(fishnet$countRodent == 0) / nrow(fishnet), 1), \"% )\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCells with zero rodent requests: 500 / 2458 ( 20.3 % )\n```\n\n\n:::\n:::\n\n\n-   Summary statistics for Burglary\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(summary(fishnet$countBurglaries))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  0.000   0.000   2.000   3.042   5.000  40.000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCells with zero burglaries:\",\n    sum(fishnet$countBurglaries == 0), \"/\",\n    nrow(fishnet), \"(\",\n    round(100 * sum(fishnet$countBurglaries == 0) / nrow(fishnet), 1), \"% )\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCells with zero burglaries: 781 / 2458 ( 31.8 % )\n```\n\n\n:::\n:::\n\n\n## 2.3 Visualize Rodent Baiting with fishnet\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = countRodent), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name   = \"Rodent Baiting Requests\",\n    option = \"plasma\",\n    trans  = \"sqrt\",\n    breaks = c(0, 5, 10, 20, 40, 80, 180),\n    limits = c(0, 180), \n    oob    = scales::squish\n  ) +\n  labs(\n    title = \"Rodent Baiting 311 Requests by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago,2017\"\n  ) +\n  theme_default()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\nquant_rb <- tibble(\n  Percentile = c(\"0%\", \"10%\", \"20%\", \"30%\", \"40%\", \"50%\", \"60%\", \"70%\", \"80%\", \"90%\", \"100%\"),\n  Value = quantile(fishnet$countRodent, probs = seq(0,1,0.1))\n)\n\nknitr::kable(\n  quant_rb,\n  caption = \"Quantile Distribution of Rodent Baiting 311 Request Counts\"\n)\n```\n\n::: {.cell-output-display}\n\n\nTable: Quantile Distribution of Rodent Baiting 311 Request Counts\n\n|Percentile | Value|\n|:----------|-----:|\n|0%         |     0|\n|10%        |     0|\n|20%        |     0|\n|30%        |     3|\n|40%        |     7|\n|50%        |    11|\n|60%        |    17|\n|70%        |    24|\n|80%        |    36|\n|90%        |    56|\n|100%       |   180|\n\n\n:::\n:::\n\n\n-   Most grid cells have very low request counts. According to the quantile table, 30% of the cells have 3 or fewer requests, and 50% have 11 or fewer.\\\n-   This pattern shows a strong **right-skewed distribution**, where a small number of hotspots generate many more requests than the rest of the city.\\\n-   On the map, hotspots appear mainly in the **central and north neighborhoods**, forming clear clusters of higher counts, and suggesting strong spatial heterogeneity.\n\n## 2.4 Visualize Burgalaries with fishnet\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Burglary 500m x 500m grid map\nggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name   = \"Residential Burglaries\",\n    option = \"plasma\",\n    trans  = \"sqrt\",\n    breaks = c(0, 1, 2, 3, 5, 8, 40),\n    limits = c(0, 40),\n    oob    = scales::squish\n  ) +\n  labs(\n    title = \"Residential Burglaries by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago, 2017\"\n  ) +\n  theme_default()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\nquant_burglary <- tibble(\n  Percentile = c(\"0%\", \"10%\", \"20%\", \"30%\", \"40%\", \"50%\", \"60%\", \"70%\", \"80%\", \"90%\", \"100%\"),\n  Value = quantile(fishnet$countBurglaries, probs = seq(0, 1, 0.1), na.rm = TRUE)\n)\n\nknitr::kable(\n  quant_burglary,\n  caption = \"Quantile Distribution of Residential Burglary Counts\"\n)\n```\n\n::: {.cell-output-display}\n\n\nTable: Quantile Distribution of Residential Burglary Counts\n\n|Percentile | Value|\n|:----------|-----:|\n|0%         |     0|\n|10%        |     0|\n|20%        |     0|\n|30%        |     0|\n|40%        |     1|\n|50%        |     2|\n|60%        |     3|\n|70%        |     4|\n|80%        |     5|\n|90%        |     8|\n|100%       |    40|\n\n\n:::\n:::\n\n\n# Step 3: Spatial Features\n\n## 3.1 k-nearest neighbor\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Get centroid coordinates\nfishnet_coords <- st_coordinates(st_centroid(fishnet))\n\n# 2. Compute nearest 8 neighbors (to other grid cells)\nknn_result <- get.knn(fishnet_coords, k = 8)\n\n# 3. Add KNN features to fishnet\nfishnet <- fishnet %>%\n  mutate(\n    knn_mean = rowMeans(matrix(countRodent[knn_result$nn.index], nrow = nrow(fishnet))),\n    knn_sum  = rowSums(matrix(countRodent[knn_result$nn.index],  nrow = nrow(fishnet)))\n  )\n\nsummary(fishnet$knn_mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  0.000   6.281  15.562  20.992  31.500 112.125 \n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fishnet$knn_sum)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.00   50.25  124.50  167.94  252.00  897.00 \n```\n\n\n:::\n:::\n\n\n-   I calculated the **summary and mean values of neighboring grid cells** instead of the distance nearest event points. This method captures spatial spillover between neighborhoods better, providing stronger and more reliable predictive power.\n\n## 3.2 Distance to Hot Spots\n\n### 3.2.1 Perform Local Moran's I analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function to calculate Local Moran's I\ncalculate_local_morans <- function(data, variable, k = 5) {\n  \n  # Create spatial weights based on k-nearest neighbors\n  coords <- st_coordinates(st_centroid(data))\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = TRUE)\n  \n  # Calculate Local Moran's I\n  local_moran <- localmoran(data[[variable]], weights)\n  \n  # Classify clusters\n  mean_val <- mean(data[[variable]], na.rm = TRUE)\n  \n  data %>%\n    mutate(\n      local_i = local_moran[, 1],\n      p_value = local_moran[, 5],\n      is_significant = p_value < 0.05,\n      \n      moran_class = case_when(\n        !is_significant ~ \"Not Significant\",\n        local_i > 0 & .data[[variable]] > mean_val ~ \"High-High\",\n        local_i > 0 & .data[[variable]] <= mean_val ~ \"Low-Low\",\n        local_i < 0 & .data[[variable]] > mean_val ~ \"High-Low\",\n        local_i < 0 & .data[[variable]] <= mean_val ~ \"Low-High\",\n        TRUE ~ \"Not Significant\"\n      )\n    )\n}\n\n# Apply to rodent baiting counts\nfishnet <- calculate_local_morans(fishnet, \"countRodent\", k = 5)\n```\n:::\n\n\n### 3.2.2 Visualize Morans\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| fig-width: 8\n#| fig-height: 6\n\n# Visualize Local Moran's I clusters for rodent baiting\nggplot() +\n  geom_sf(\n    data = fishnet, \n    aes(fill = moran_class), \n    color = NA\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\"       = \"#d7191c\",  # hotspots\n      \"High-Low\"        = \"#fdae61\",\n      \"Low-High\"        = \"#abd9e9\",\n      \"Low-Low\"         = \"#2c7bb6\",  # cold spots\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran's I: Rodent Baiting Clusters\",\n    subtitle = \"High-High = Hot spots of rodent activity\"\n  ) +\n  theme_default()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n-   **Why there is no \"Low-Low\" and \"High-Low\" clusters?**\n    -   The data shows a highly right-skewed distribution.\\\n    -   When high-value areas are clustered together, they are very likely to be identified as High-High (hotspot).\\\n    -   Low-value areas are everywhere, so \"low + low + low\" is too \"normal\" for the tests. As a result, it will not be marked as significantly \"Low-Low\", but rather \"Not Significant\".\n    -   In the reality, rodent activity is concentrated in a small number of hotspots, while low counts are widespread across the city.\n\n### 3.2.3 Distance to Hotspots\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get centroids of \"High-High\" cells (rodent hotspots)\nhotspots <- fishnet %>%\n  filter(moran_class == \"High-High\") %>%\n  st_centroid()\n\n# Calculate distance from each cell to nearest rodent hotspot\nif (nrow(hotspots) > 0) {\n  fishnet <- fishnet %>%\n    mutate(\n      dist_to_hotspot = as.numeric(\n        st_distance(st_centroid(fishnet), hotspots %>% st_union())\n      )\n    )\n  \n\n  cat(\"  - Number of hot spot cells:\", nrow(hotspots), \"\\n\")\n} else {\n  fishnet <- fishnet %>%\n    mutate(dist_to_hotspot = 0)\n  cat(\"⚠ No significant rodent baiting hot spots found\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of hot spot cells: 304 \n```\n\n\n:::\n:::\n\n\n## 3.3 Building Age\n\n### 3.3.1 Building Age Feature\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read building data\n\nbuildings_sf <- st_read(\n  \"https://data.cityofchicago.org/resource/syp8-uezg.geojson\",\n  quiet = TRUE\n) %>%\n\n\n# Clean and calculate the building years of 2017\n filter(!is.na(year_built)) %>%\n  mutate(year_built = as.numeric(year_built)) %>%\n  filter(year_built > 0, year_built <= 2017) %>%\n  mutate(bldg_age_2017 = 2017 - year_built) %>%\n  st_transform('ESRI:102271')\n\nbuildings_raw <- buildings_sf\n\nbldg_by_grid <- st_join(fishnet, buildings_sf, join = st_intersects) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(\n    n_buildings     = sum(!is.na(bldg_age_2017)),\n    mean_bldg_age   = ifelse(\n      n_buildings == 0, NA_real_,\n      mean(bldg_age_2017, na.rm = TRUE)\n    ),\n    median_bldg_age = ifelse(\n      n_buildings == 0, NA_real_,\n      median(bldg_age_2017, na.rm = TRUE)\n    ),\n    .groups = \"drop\"\n  )\n\nfishnet <- fishnet %>%\n  left_join(bldg_by_grid, by = \"uniqueID\")\n```\n:::\n\n\n### 3.3.2 Visualize Building Age\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = mean_bldg_age), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name   = \"Mean building age (years)\",\n    option = \"magma\",\n    direction = -1 ,\n    na.value = \"grey90\"\n  ) +\n  labs(\n    title    = \"Average Building Age by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago, 2017\"\n  ) +\n  theme_default()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-18-1.png){width=768}\n:::\n:::\n\n\n## 3.4 Land Use\n\n### 3.4.1 Land Use Feature\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the zoning data\n\nzoning_sf <- st_read(\n  \"https://data.cityofchicago.org/resource/dj47-wfun.geojson\",\n  quiet = TRUE\n)\n\n# Extract the letter parts of the first three characters from ZONE_CLASS\nzoning_sf <- zoning_sf %>%\n  mutate(\n    zone_prefix = substr(zone_class, 1, 3),\n    zone_prefix = gsub(\"[^A-Za-z]\", \"\", zone_prefix)\n  ) %>%\n  filter(zone_prefix != \"\") %>%\n  mutate(\n    zone_code = dplyr::recode(\n      zone_prefix,\n      \"RS\"  = \"1\",\n      \"RT\"  = \"2\",\n      \"RM\"  = \"3\",\n      \"B\"   = \"4\",\n      \"C\"   = \"5\",\n      \"DC\"  = \"6\",\n      \"DR\"  = \"7\",\n      \"DS\"  = \"8\",\n      \"DX\"  = \"9\",\n      \"M\"   = \"10\",\n      \"PMD\" = \"11\",\n      \"PD\"  = \"12\",\n      \"T\"   = \"13\",\n      \"POS\" = \"14\",\n      .default = NA_character_\n    )\n  ) %>%\n  filter(!is.na(zone_code)) %>%\n  \n  st_transform(\"ESRI:102271\")\n\nzoning_sf$zone_code <- as.integer(zoning_sf$zone_code)\n\n# Calculate the mode\nmode_first <- function(x) {\n  x <- x[!is.na(x)]\n  if (length(x) == 0) return(NA)\n  ux <- unique(x)\n  ux[which.max(tabulate(match(x, ux)))]\n}\n\n# Aggregate to fishnet: One zoning type for each grid\nzoning_by_grid <- st_join(fishnet, zoning_sf, join = st_intersects) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(\n    zone_prefix_dom = mode_first(zone_prefix), \n    zone_code_dom   = mode_first(zone_code),\n    .groups = \"drop\"\n  )\n\n# join the zoning variable back to fishnet\nfishnet <- fishnet %>%\n  left_join(zoning_by_grid, by = \"uniqueID\")\n```\n:::\n\n\n### 3.4.2 Visualize Land Use\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a zoning classification with complete instructions\nfishnet <- fishnet %>%\n  mutate(\n    zone_cat = factor(\n      zone_prefix_dom,\n      levels = c(\"RS\", \"RT\", \"RM\", \"B\",  \"C\",  \"DC\", \"DR\", \"DS\", \"DX\",\n                 \"M\",  \"PMD\", \"PD\", \"T\", \"POS\"),\n      labels = c(\n        \"RS = Residential Single-Unit District\",\n        \"RT = Residential Two-Flat, Townhouse and Multi-Unit District\",\n        \"RM = Residential Multi-Unit District\",\n        \"B = Business\",\n        \"C = Commercial\",\n        \"DC = Downtown Core District\",\n        \"DR = Downtown Residential District\",\n        \"DS = Downtown Service District\",\n        \"DX = Downtown Mixed-Use District\",\n        \"M = Manufacturing\",\n        \"PMD = Planned Manufacturing Districts\",\n        \"PD = Planned Development\",\n        \"T = Transportation\",\n        \"POS = Parks and Open Space\"\n      )\n    )\n  )\n\n#| fig-width: 8\n#| fig-height: 6\n\nggplot() +\n  geom_sf(data = fishnet, aes(fill = zone_cat), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_d(\n    name   = \"Zoning (dominant class)\",\n    option = \"turbo\", \n    na.value = \"grey90\"\n  ) +\n  labs(\n    title    = \"Dominant Zoning Category by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago\"\n  ) +\n  theme_default() +\n  theme(\n    legend.key.height = unit(0.6, \"cm\"),\n    legend.key.width  = unit(0.6, \"cm\")\n  )\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n# Step 4: Count Regression Models\n\n## 4.1 Poisson regression\n\n### 4.1.1 Fit Poisson regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| label: poisson-reg\n#| message: false\n#| warning: false\n#| results: hide\n\nfishnet$zone_code_dom <- as.factor(fishnet$zone_code_dom)\n\npois_model <- glm(\n  countBurglaries ~ mean_bldg_age + zone_code_dom + dist_to_hotspot + knn_mean,\n  data = fishnet,\n  family = \"poisson\"\n)\n\nsummary(pois_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countBurglaries ~ mean_bldg_age + zone_code_dom + \n    dist_to_hotspot + knn_mean, family = \"poisson\", data = fishnet)\n\nCoefficients:\n                   Estimate  Std. Error z value      Pr(>|z|)    \n(Intercept)      0.23516297  0.17168406   1.370      0.170767    \nmean_bldg_age    0.00878290  0.00140693   6.243 0.00000000043 ***\nzone_code_dom2   0.23090856  0.10126582   2.280      0.022595 *  \nzone_code_dom3   0.50129662  0.13644679   3.674      0.000239 ***\nzone_code_dom4  -0.17321380  0.09533582  -1.817      0.069235 .  \nzone_code_dom5   0.22685205  0.11129124   2.038      0.041514 *  \nzone_code_dom8   0.98538480  0.41862926   2.354      0.018581 *  \nzone_code_dom9   0.26024628  0.38452477   0.677      0.498533    \nzone_code_dom10 -0.21097811  0.27140335  -0.777      0.436946    \nzone_code_dom11 -1.42842357  0.53013046  -2.694      0.007050 ** \nzone_code_dom12 -0.53938007  0.29835147  -1.808      0.070627 .  \nzone_code_dom14  0.28534367  0.18769642   1.520      0.128451    \ndist_to_hotspot  0.00002847  0.00002283   1.247      0.212444    \nknn_mean         0.00863745  0.00211382   4.086 0.00004385131 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 676.45  on 204  degrees of freedom\nResidual deviance: 544.90  on 191  degrees of freedom\n  (2253 observations deleted due to missingness)\nAIC: 1168\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n### 4.1.2 Check for Overdispersion\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| label: poisson-dispersion-check\n#| message: false\n#| warning: false\n\ndispersion_rb <- sum(residuals(pois_model, type = \"pearson\")^2) /\n                 pois_model$df.residual\n\ncat(\"Dispersion parameter for rodent baiting Poisson model:\",\n    round(dispersion_rb, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDispersion parameter for rodent baiting Poisson model: 2.96 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Rule of thumb: values > 1.5 indicate overdispersion.\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRule of thumb: values > 1.5 indicate overdispersion.\n```\n\n\n:::\n\n```{.r .cell-code}\nif (dispersion_rb > 1.5) {\n  cat(\"⚠ Overdispersion detected for rodent baiting counts.\\n\")\n  cat(\"  The Poisson model is likely too restrictive.\\n\")\n  cat(\"  A Negative Binomial model is more appropriate.\\n\")\n} else {\n  cat(\"✓ Dispersion looks acceptable.\\n\")\n  cat(\"  The Poisson model may be adequate for these counts.\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n⚠ Overdispersion detected for rodent baiting counts.\n  The Poisson model is likely too restrictive.\n  A Negative Binomial model is more appropriate.\n```\n\n\n:::\n:::\n\n\n## 4.2 Fit Negative Binomial regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnb_model <- glm.nb(\n  countBurglaries ~ mean_bldg_age + zone_prefix_dom + dist_to_hotspot + knn_mean,\n  data = fishnet\n)\n\nsummary(nb_model)\n```\n:::\n\n\n## 4.3 Compare model fit (AIC)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_compare <- data.frame(\n  Model = c(\"Poisson\", \"Negative Binomial\"),\n  AIC   = c(AIC(pois_model), AIC(nb_model))\n)\n\nknitr::kable(model_compare, caption = \"Model Comparison: Poisson vs. NB\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Model Comparison: Poisson vs. NB\n\n|Model             |      AIC|\n|:-----------------|--------:|\n|Poisson           | 1168.033|\n|Negative Binomial | 1032.645|\n\n\n:::\n:::\n\n\n-   Poisson model has an **AIC of about 11869**, while the Negative Binomial model has an **AIC of about 9842**. A lower AIC means a better fit, so the **Negative Binomial model** performs much better.\\\n-   This big gap suggests that the rodent baiting counts have **strong overdispersion**, meaning the variance is much higher than the mean. The Poisson model cannot handle this pattern, but the Negative Binomial model can.\n\n# Step 5: Spatial Cross-Validation\n\n## 5.1 Leave-One-Group-Out cross-validation on 2017 data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate which police district the centroid of the grid falls in\nfishnet_centroids <- st_centroid(fishnet) %>%\n  st_join(policeDistricts, join = st_within) %>%\n  st_drop_geometry() %>%\n  dplyr::select(uniqueID, District)\n\n# Construct a dataset for cross-validation\nfishnet_model <- fishnet %>%\n  left_join(fishnet_centroids, by = \"uniqueID\") %>%\n  filter(!is.na(District)) %>%\n  mutate(\n    District      = as.factor(District),\n    zone_code_dom = as.factor(zone_code_dom)\n  ) %>%\n  filter(\n    !is.na(countRodent),\n    !is.na(mean_bldg_age),\n    !is.na(zone_code_dom),\n    !is.na(knn_mean),\n    !is.na(dist_to_hotspot)\n  )\n\n# LOGO CV\ndistricts  <- unique(fishnet_model$District)\ncv_results <- tibble()\n\nfor (i in seq_along(districts)) {\n  \n  test_district <- districts[i]\n  \n  # Divide the training set/test set\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data  <- fishnet_model %>% filter(District == test_district)\n  \n  train_data <- train_data %>%\n    mutate(zone_code_dom = factor(zone_code_dom))\n  \n  test_data <- test_data %>%\n    mutate(zone_code_dom = factor(zone_code_dom,\n           levels = levels(train_data$zone_code_dom)))\n  \n  # Fit the NB model\nmodel_cv <- MASS::glm.nb(\n    countBurglaries ~ mean_bldg_age + zone_code_dom + dist_to_hotspot + knn_mean,\n    data = train_data\n  )\n  \n  # Make predictions on the test police district\n test_data <- test_data %>%\n    mutate(\n      prediction = predict(model_cv, newdata = ., type = \"response\"),\n      abs_error  = abs(countRodent - prediction),\n      sq_error   = (countRodent - prediction)^2\n    )\n \n   test_eval <- test_data %>% filter(!is.na(prediction))\n  \n mae  <- mean(test_eval$abs_error, na.rm = TRUE)\n rmse <- sqrt(mean(test_eval$sq_error, na.rm = TRUE))\n  \n  # Save the result\ncv_results <- bind_rows(\n    cv_results,\n    tibble(\n      fold          = i,\n      test_district = as.character(test_district),\n      n_test        = nrow(test_eval),\n      mae           = mae,\n      rmse          = rmse\n    )\n  )\n  \ncat(\"  Fold\", i, \"/\", length(districts),\n      \"- District\", as.character(test_district),\n      \"- n_test:\", nrow(test_eval),\n      \"- MAE:\", round(mae, 2),\n      \"- RMSE:\", round(rmse, 2), \"\\n\")\n}\n```\n:::\n\n\n## 5.2 Calculate and report error metrics (MAE, RMSE)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_sorted <- cv_results %>%\n  arrange(fold)\n\n# Table 1: local MAE and RMSE\ncv_sorted %>%\n  knitr::kable(\n    digits  = 2,\n    caption = \"Leave-One-District-Out CV Results (per district)\"\n  ) %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Leave-One-District-Out CV Results (per district)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> fold </th>\n   <th style=\"text-align:left;\"> test_district </th>\n   <th style=\"text-align:right;\"> n_test </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 12.53 </td>\n   <td style=\"text-align:right;\"> 13.87 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 22 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 7.40 </td>\n   <td style=\"text-align:right;\"> 11.45 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 6.05 </td>\n   <td style=\"text-align:right;\"> 8.61 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 16.06 </td>\n   <td style=\"text-align:right;\"> 18.50 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:right;\"> 38.67 </td>\n   <td style=\"text-align:right;\"> 56.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7.11 </td>\n   <td style=\"text-align:right;\"> 8.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 24.54 </td>\n   <td style=\"text-align:right;\"> 30.82 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:right;\"> 10.31 </td>\n   <td style=\"text-align:right;\"> 17.54 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:right;\"> 28.73 </td>\n   <td style=\"text-align:right;\"> 42.20 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:right;\"> 28.26 </td>\n   <td style=\"text-align:right;\"> 36.39 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:right;\"> 55.36 </td>\n   <td style=\"text-align:right;\"> 62.40 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> NaN </td>\n   <td style=\"text-align:right;\"> NaN </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 13 </td>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 32.34 </td>\n   <td style=\"text-align:right;\"> 33.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 1.24 </td>\n   <td style=\"text-align:right;\"> 1.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:left;\"> 18 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 53.49 </td>\n   <td style=\"text-align:right;\"> 59.70 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:right;\"> 50.86 </td>\n   <td style=\"text-align:right;\"> 54.81 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:left;\"> 25 </td>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:right;\"> 34.60 </td>\n   <td style=\"text-align:right;\"> 39.55 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:left;\"> 19 </td>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:right;\"> 46.41 </td>\n   <td style=\"text-align:right;\"> 63.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:right;\"> 20.20 </td>\n   <td style=\"text-align:right;\"> 24.51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:left;\"> 17 </td>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:right;\"> 54.17 </td>\n   <td style=\"text-align:right;\"> 60.96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:left;\"> 20 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 22.28 </td>\n   <td style=\"text-align:right;\"> 22.35 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:left;\"> 24 </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:right;\"> 62.59 </td>\n   <td style=\"text-align:right;\"> 71.16 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\n# Table 2: Average MAE and RMSe\ncv_summary <- cv_sorted %>%\n  summarise(\n    mean_MAE  = mean(mae,  na.rm = TRUE),\n    mean_RMSE = mean(rmse, na.rm = TRUE),\n    n_folds   = dplyr::n()\n  )\n\ncv_summary %>%\n  knitr::kable(\n    digits  = 2,\n    caption = \"Average MAE and RMSE across all districts (LOGO CV)\"\n  ) %>%\n  kableExtra::kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Average MAE and RMSE across all districts (LOGO CV)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> mean_MAE </th>\n   <th style=\"text-align:right;\"> mean_RMSE </th>\n   <th style=\"text-align:right;\"> n_folds </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 29.2 </td>\n   <td style=\"text-align:right;\"> 35.07 </td>\n   <td style=\"text-align:right;\"> 22 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## 5.3 Visualize error metrics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_by_district <- cv_results %>%\n  group_by(test_district) %>%\n  summarise(\n    mae  = mean(mae,  na.rm = TRUE),\n    rmse = mean(rmse, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\n# Merge with the police district base map\npolice_cv <- policeDistricts %>%\n  mutate(District = as.character(District)) %>%\n  left_join(cv_by_district, by = c(\"District\" = \"test_district\"))\n\n# RMSE spatial distribution\nggplot(police_cv) +\n  geom_sf(aes(fill = rmse)) +\n  labs(\n    title = \"LOGO CV RMSE by Police District\",\n    fill  = \"RMSE\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# MAE spatial distribution\nggplot(police_cv) +\n  geom_sf(aes(fill = mae)) +\n  labs(\n    title = \"LOGO CV MAE by Police District\",\n    fill  = \"MAE\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-25-2.png){width=672}\n:::\n:::\n\n\n# Step 6: Model Evaluation\n\n### 6.1 KDE baseline\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Extract XY coordinates of burglary points\nbur_xy <- st_coordinates(burglaries)\n\n# 2. Create a bounding window from the Chicago boundary\nwin_bbox <- spatstat.geom::owin(\n  xrange = st_bbox(chicagoBoundary)[c(\"xmin\", \"xmax\")],\n  yrange = st_bbox(chicagoBoundary)[c(\"ymin\", \"ymax\")]\n)\n\n# 3. Create a ppp object (point pattern) for burglaries\nbur_ppp <- spatstat.geom::ppp(\n  x      = bur_xy[, 1],\n  y      = bur_xy[, 2],\n  window = win_bbox\n)\n\n# 4. Kernel density estimate for the point pattern\n#    IMPORTANT: call density.ppp(bur_ppp, ...) — no \"X =\"\nbur_kde <- spatstat.explore::density.ppp(\n  bur_ppp,\n  sigma = 1000   # bandwidth in meters\n)\n\n# 5. Convert KDE to raster and extract values at grid centroids\nbur_kde_raster <- raster::raster(bur_kde)\nfishnet_centroids <- st_coordinates(st_centroid(fishnet))\n\nfishnet$kde_value <- raster::extract(\n  bur_kde_raster,\n  fishnet_centroids\n)\n\n# 6. Replace NA values (outside the KDE window) with 0\nfishnet$kde_value[is.na(fishnet$kde_value)] <- 0\n```\n:::\n\n\n## 6.2 Final model + predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit the final NB model using all available training cells\nfinal_model <- glm.nb(\n  countBurglaries ~ mean_bldg_age + knn_mean + dist_to_hotspot + zone_prefix_dom,\n  data = fishnet_model\n)\n\n# Add NB predictions back to fishnet (matched by uniqueID)\nfishnet <- fishnet %>%\n  mutate(\n    prediction_nb = predict(\n      final_model,\n      newdata = fishnet_model,\n      type = \"response\"\n    )[match(uniqueID, fishnet_model$uniqueID)]\n  )\n\n# Normalize KDE predictions to total burglary count\nkde_sum   <- sum(fishnet$kde_value,       na.rm = TRUE)\ncount_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)\n\nfishnet <- fishnet %>%\n  mutate(\n    prediction_kde = (kde_value / kde_sum) * count_sum\n  )\n\nfishnet <- fishnet %>%\n  mutate(\n    error_nb      = countBurglaries - prediction_nb,\n    abs_error_nb  = abs(error_nb),\n    error_kde     = countBurglaries - prediction_kde,\n    abs_error_kde = abs(error_kde)\n  )\n```\n:::\n\n\n## 6.3 Compare Actual vs NB vs KDE\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| fig-width: 12\n#| fig-height: 4\n\n# Actual counts\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Count\", option = \"plasma\", limits = c(0, 15)\n  ) +\n  labs(title = \"Actual Burglaries (2017)\") +\n  theme_default()\n\n# Negative Binomial predictions\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Predicted\", option = \"plasma\", limits = c(0, 15)\n  ) +\n  labs(title = \"NB Model Predictions\") +\n  theme_default()\n\n# KDE baseline predictions\np3 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Predicted\", option = \"plasma\", limits = c(0, 15)\n  ) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_default()\n\n# Combine the three maps\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs Predicted Burglaries\",\n    subtitle = \"Comparing NB Model and KDE Baseline\"\n  )\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n## 6.4 Model performance comparison (MAE / RMSE)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate MAE and RMSE for NB model and KDE baseline\ncomparison <- fishnet %>%\n  st_drop_geometry() %>%\n  filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%\n  summarize(\n    model_mae  = mean(abs(countBurglaries - prediction_nb)),\n    model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),\n    kde_mae    = mean(abs(countBurglaries - prediction_kde)),\n    kde_rmse   = sqrt(mean((countBurglaries - prediction_kde)^2))\n  )\n\n# Reshape and print the table\ncomparison %>%\n  pivot_longer(\n    everything(), names_to = \"metric\", values_to = \"value\"\n  ) %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance: NB vs KDE\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model Performance: NB vs KDE</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> approach </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> model </td>\n   <td style=\"text-align:right;\"> 2.68 </td>\n   <td style=\"text-align:right;\"> 3.59 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kde </td>\n   <td style=\"text-align:right;\"> 2.15 </td>\n   <td style=\"text-align:right;\"> 3.09 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## 6.5 Spatial Distribution of Prediction Errors\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Signed error (NB)\np_nb_err <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name     = \"Error\",\n    low      = \"#2166ac\",\n    mid      = \"white\",\n    high     = \"#b2182b\",\n    midpoint = 0,\n    limits   = c(-10, 10)\n  ) +\n  labs(title = \"NB Model: Signed Error\") +\n  theme_default()\n\n# Absolute error (NB)\np_nb_abs <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(\n    name   = \"Abs. Error\",\n    option = \"magma\"\n  ) +\n  labs(title = \"NB Model: Absolute Error\") +\n  theme_default()\n\n# Signed error (KDE)\np_kde_err <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = error_kde), color = NA) +\n  scale_fill_gradient2(\n    name     = \"Error\",\n    low      = \"#2166ac\",\n    mid      = \"white\",\n    high     = \"#b2182b\",\n    midpoint = 0,\n    limits   = c(-10, 10)\n  ) +\n  labs(title = \"KDE Baseline: Signed Error\") +\n  theme_default()\n\n# Absolute error (KDE)\np_kde_abs <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abs_error_kde), color = NA) +\n  scale_fill_viridis_c(\n    name   = \"Abs. Error\",\n    option = \"magma\"\n  ) +\n  labs(title = \"KDE Baseline: Absolute Error\") +\n  theme_default()\n\n# Combine 4 plots in 2×2 layout\n(p_nb_err + p_nb_abs) /\n(p_kde_err + p_kde_abs)\n```\n\n::: {.cell-output-display}\n![](Assignment4_SpatialPredictiveAnalysis_files/figure-html/unnamed-chunk-30-1.png){width=1152}\n:::\n:::\n\n\n# Step7: Summary Statistics and Tables\n\n## 7.1 Model Summary Table\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Lookup full zoning labels\nzoning_labels <- c(\n  \"RS\"  = \"Residential Single-Unit District\",\n  \"RT\"  = \"Residential Two-Flat, Townhouse and Multi-Unit District\",\n  \"RM\"  = \"Residential Multi-Unit District\",\n  \"B\"   = \"Business\",\n  \"C\"   = \"Commercial\",\n  \"DC\"  = \"Downtown Core District\",\n  \"DR\"  = \"Downtown Residential District\",\n  \"DS\"  = \"Downtown Service District\",\n  \"DX\"  = \"Downtown Mixed-Use District\",\n  \"M\"   = \"Manufacturing\",\n  \"PMD\" = \"Planned Manufacturing Districts\",\n  \"PD\"  = \"Planned Development\",\n  \"T\"   = \"Transportation\",\n  \"POS\" = \"Parks and Open Space\"\n)\n\nmodel_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%\n  mutate(\n    term = dplyr::case_when(\n      term == \"(Intercept)\"      ~ \"Intercept\",\n      term == \"mean_bldg_age\"    ~ \"Mean building age\",\n      term == \"knn_mean\"         ~ \"KNN mean burglaries (neighboring cells)\",\n      term == \"dist_to_hotspot\"  ~ \"Distance to rodent hotspot\",\n\n      # Zoning coefficients: zone_prefix_domRS, zone_prefix_domRT\n      \n      grepl(\"^zone_prefix_dom\", term) ~ paste0(\n        \"Zoning: \",\n        sub(\"zone_prefix_dom\", \"\", term), \n        \" (\",\n        zoning_labels[sub(\"zone_prefix_dom\", \"\", term)],\n        \")\"\n      ),\n\n      TRUE ~ term\n    ),\n    # Round all numeric columns\n    dplyr::across(where(is.numeric), ~round(.x, 3))\n  )\n\nmodel_summary %>%\n  kable(\n    caption   = \"Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)\",\n    col.names = c(\"Variable\", \"Rate Ratio\", \"Std. Error\", \"Z\", \"P-Value\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  footnote(\n    general = paste(\n      \"Rate ratios > 1 indicate a positive association with burglary counts,\",\n      \"while rate ratios < 1 indicate a negative association.\",\n      \"Zoning (land use) is a categorical variable; each zoning category is interpreted\",\n      \"relative to the reference category (the omitted baseline level of zone_prefix_dom).\"\n    )\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;border-bottom: 0;\">\n<caption>Final Negative Binomial Model Coefficients (Exponentiated Rate Ratios)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Variable </th>\n   <th style=\"text-align:right;\"> Rate Ratio </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Intercept </td>\n   <td style=\"text-align:right;\"> 1.193 </td>\n   <td style=\"text-align:right;\"> 0.293 </td>\n   <td style=\"text-align:right;\"> 0.603 </td>\n   <td style=\"text-align:right;\"> 0.547 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Mean building age </td>\n   <td style=\"text-align:right;\"> 1.008 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> 3.631 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> KNN mean burglaries (neighboring cells) </td>\n   <td style=\"text-align:right;\"> 1.009 </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n   <td style=\"text-align:right;\"> 2.366 </td>\n   <td style=\"text-align:right;\"> 0.018 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Distance to rodent hotspot </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 0.541 </td>\n   <td style=\"text-align:right;\"> 0.589 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: C (Commercial) </td>\n   <td style=\"text-align:right;\"> 1.476 </td>\n   <td style=\"text-align:right;\"> 0.212 </td>\n   <td style=\"text-align:right;\"> 1.833 </td>\n   <td style=\"text-align:right;\"> 0.067 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: DS (Downtown Service District) </td>\n   <td style=\"text-align:right;\"> 3.036 </td>\n   <td style=\"text-align:right;\"> 0.768 </td>\n   <td style=\"text-align:right;\"> 1.445 </td>\n   <td style=\"text-align:right;\"> 0.148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: DX (Downtown Mixed-Use District) </td>\n   <td style=\"text-align:right;\"> 1.539 </td>\n   <td style=\"text-align:right;\"> 0.743 </td>\n   <td style=\"text-align:right;\"> 0.580 </td>\n   <td style=\"text-align:right;\"> 0.562 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: M (Manufacturing) </td>\n   <td style=\"text-align:right;\"> 1.020 </td>\n   <td style=\"text-align:right;\"> 0.430 </td>\n   <td style=\"text-align:right;\"> 0.046 </td>\n   <td style=\"text-align:right;\"> 0.963 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: PD (Planned Development) </td>\n   <td style=\"text-align:right;\"> 0.704 </td>\n   <td style=\"text-align:right;\"> 0.448 </td>\n   <td style=\"text-align:right;\"> -0.784 </td>\n   <td style=\"text-align:right;\"> 0.433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: PMD (Planned Manufacturing Districts) </td>\n   <td style=\"text-align:right;\"> 0.316 </td>\n   <td style=\"text-align:right;\"> 0.659 </td>\n   <td style=\"text-align:right;\"> -1.752 </td>\n   <td style=\"text-align:right;\"> 0.080 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: POS (Parks and Open Space) </td>\n   <td style=\"text-align:right;\"> 1.556 </td>\n   <td style=\"text-align:right;\"> 0.334 </td>\n   <td style=\"text-align:right;\"> 1.323 </td>\n   <td style=\"text-align:right;\"> 0.186 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: RM (Residential Multi-Unit District) </td>\n   <td style=\"text-align:right;\"> 1.832 </td>\n   <td style=\"text-align:right;\"> 0.268 </td>\n   <td style=\"text-align:right;\"> 2.259 </td>\n   <td style=\"text-align:right;\"> 0.024 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: RS (Residential Single-Unit District) </td>\n   <td style=\"text-align:right;\"> 1.123 </td>\n   <td style=\"text-align:right;\"> 0.152 </td>\n   <td style=\"text-align:right;\"> 0.763 </td>\n   <td style=\"text-align:right;\"> 0.446 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Zoning: RT (Residential Two-Flat, Townhouse and Multi-Unit District) </td>\n   <td style=\"text-align:right;\"> 1.538 </td>\n   <td style=\"text-align:right;\"> 0.195 </td>\n   <td style=\"text-align:right;\"> 2.209 </td>\n   <td style=\"text-align:right;\"> 0.027 </td>\n  </tr>\n</tbody>\n<tfoot>\n<tr><td style=\"padding: 0; \" colspan=\"100%\"><span style=\"font-style: italic;\">Note: </span></td></tr>\n<tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Rate ratios &gt; 1 indicate a positive association with burglary counts, while rate ratios &lt; 1 indicate a negative association. Zoning (land use) is a categorical variable; each zoning category is interpreted relative to the reference category (the omitted baseline level of zone_prefix_dom).</td></tr>\n</tfoot>\n</table>\n\n`````\n:::\n:::\n\n\n## Step 3: Write Your Analysis\n\n### Critical Requirement: Explain Each Step\n\n**For each major section, you must explain in your own words:**\n\n-   **What** you are doing in that step\n-   **Why** this step is important for the analysis\n-   **What** you found or learned from the results\n\nDo not simply copy text from the example or from your AI friend. Think about the purpose of each technique and articulate it in your own words.\n\n------------------------------------------------------------------------\n\n## Step 4: Format Your Document\n\n### Formatting Requirements\n\nYour knitted HTML document should be **professional and easy to read**:\n\n#### ✓ Clean Code\n\n-   Remove unnecessary code, comments, or debugging lines\n-   Keep only essential code chunks\n-   Use `code-fold: show` in your YAML header\n\n#### ✓ Clear Structure\n\n-   Use headers to organize sections\n-   Include a table of contents\n-   Add your name and date\n\n#### ✓ Readable Text\n\n-   Ensure all text renders properly (no broken markdown)\n-   Check that headers appear as headers (not plain text)\n-   Use proper markdown formatting\n\n#### ✓ Quality Visualizations\n\n-   All plots should have titles and labels\n-   Maps should be readable\n-   Use consistent color schemes\n\n#### ✓ Professional Presentation\n\n-   Proofread for typos\n-   Remove any \"Your answer here\" placeholders\n-   Make sure all code runs without errors\n-   Make IT NEAT. WE GOTTA LOOK GOOD HERE.\n\n------------------------------------------------------------------------\n\n## Submission Checklist\n\nBefore you submit, verify that your document includes:\n\n### Required Components\n\n-   [ ] **Introduction**: Brief description of your chosen 311 violation type and why you selected it\n-   [ ] **Data Exploration**: Maps and summary statistics of your violation data\n-   [ ] **Fishnet Grid**: Successfully created and visualized grid with aggregated counts\n-   [ ] **Spatial Features**: At least 2-3 spatial features calculated (k-NN, distance measures, etc.)\n-   [ ] **Local Moran's I**: Spatial autocorrelation analysis with interpretation\n-   [ ] **Count Regression**: Both Poisson and Negative Binomial models with comparison\n-   [ ] **Spatial Cross-Validation**: LOGO CV implemented on 2017 data with reported metrics\n-   [ ] **Temporal Validation**: 2018 data aggregated and tested with 2017 model(OPTIONAL.)\n-   [ ] **Validation Comparison**: Comparison of spatial vs. temporal validation performance\n-   [ ] **Model Comparison**: Your model vs. KDE baseline for 2018 predictions\n-   [ ] **Error Analysis**: Maps and discussion of where model performs well/poorly\n-   [ ] **Written Explanations**: Your own words explaining each step\n\n### Technical Requirements\n\n-   [ ] Document knits to HTML without errors\n-   [ ] Code is clean and well-organized\n-   [ ] All visualizations display properly\n-   [ ] Headers and formatting render correctly\n-   [ ] File is named successfully posted to your website\n\n------------------------------------------------------------------------\n",
    "supporting": [
      "Assignment4_SpatialPredictiveAnalysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}