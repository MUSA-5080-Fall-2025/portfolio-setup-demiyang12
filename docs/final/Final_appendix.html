<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Xinyuan Cui, Yuqing Yang, Jinyang Xu">

<title>Safe Passage: Modeling Crime Risk around SEPTA Bus Stops – Demi_Yang - MUSA 5080 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Demi_Yang - MUSA 5080 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Weekly notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-weekly-notes">    
        <li>
    <a class="dropdown-item" href="../weekly-notes/">
 <span class="dropdown-text">All notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-01-notes.html">
 <span class="dropdown-text">Week 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-02-notes.html">
 <span class="dropdown-text">Week 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-03-notes.html">
 <span class="dropdown-text">Week 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../weekly-notes/week-04-notes.html">
 <span class="dropdown-text">Week 4</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../labs/lab_0/lab0_template.html">
 <span class="dropdown-text">Lab 0: dplyr Basics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignments" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assignments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assignments">    
        <li>
    <a class="dropdown-item" href="../assignments/assignment_1/assignment1_CensusDataExploration.html">
 <span class="dropdown-text">Assignment 1: Census Data Explorations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/assignment_2/assignment2_SpatialAnalysisAndVisualization.html">
 <span class="dropdown-text">Assignment 2: Spatial Analysis and Visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/assignment_4/Assignment4_SpatialPredictiveAnalysis.html">
 <span class="dropdown-text">Assignment 4: Spatial Predictive Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assignments/assignment_5/Assignment5_SpaceTimePrediction.html">
 <span class="dropdown-text">Assignment 5: Space Time Prediction</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mid-term" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Mid-term</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mid-term">    
        <li>
    <a class="dropdown-item" href="../midterm/appendix/Yuqing_Yang_appendix.html">
 <span class="dropdown-text">Appendix: Residential Sale Price Prediction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../midterm/slides/Yuqing_Yang_Presentation.html">
 <span class="dropdown-text">Slides: Residential Sale Price Prediction</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-final" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Final</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-final">    
        <li>
    <a class="dropdown-item" href="../final/Final_appendix.html">
 <span class="dropdown-text">Appendix: Crime Count Prediction</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#phase-1-data-preparation" id="toc-phase-1-data-preparation" class="nav-link active" data-scroll-target="#phase-1-data-preparation">Phase 1: Data Preparation</a>
  <ul class="collapse">
  <li><a href="#complete-data-cleaning-code" id="toc-complete-data-cleaning-code" class="nav-link" data-scroll-target="#complete-data-cleaning-code">1.0 Complete data cleaning code</a></li>
  <li><a href="#load-and-clean-bus-stop-ridership-data" id="toc-load-and-clean-bus-stop-ridership-data" class="nav-link" data-scroll-target="#load-and-clean-bus-stop-ridership-data"><strong>1.1 Load and clean bus stop ridership data:</strong></a>
  <ul class="collapse">
  <li><a href="#load-bus-stop-ridership-data" id="toc-load-bus-stop-ridership-data" class="nav-link" data-scroll-target="#load-bus-stop-ridership-data">1.1.1 Load bus stop ridership data</a></li>
  <li><a href="#clean" id="toc-clean" class="nav-link" data-scroll-target="#clean">1.1.2 Clean</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">1.1.3 Visualization</a></li>
  </ul></li>
  <li><a href="#load-and-clean-secondary-dataset" id="toc-load-and-clean-secondary-dataset" class="nav-link" data-scroll-target="#load-and-clean-secondary-dataset"><strong>1.2 Load and clean secondary dataset:</strong></a>
  <ul class="collapse">
  <li><a href="#crime-data" id="toc-crime-data" class="nav-link" data-scroll-target="#crime-data">1.2.1 Crime data:</a></li>
  <li><a href="#census-data-tidycensus" id="toc-census-data-tidycensus" class="nav-link" data-scroll-target="#census-data-tidycensus">1.2.2 Census data (tidycensus):</a></li>
  <li><a href="#spatial-amenities" id="toc-spatial-amenities" class="nav-link" data-scroll-target="#spatial-amenities">1.2.3 Spatial amenities</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#phase-2-feature-engineering" id="toc-phase-2-feature-engineering" class="nav-link" data-scroll-target="#phase-2-feature-engineering">Phase 2: Feature Engineering</a>
  <ul class="collapse">
  <li><a href="#buffer-creation" id="toc-buffer-creation" class="nav-link" data-scroll-target="#buffer-creation"><strong>2.1 Buffer creation:</strong></a>
  <ul class="collapse">
  <li><a href="#公交站400m-buffer" id="toc-公交站400m-buffer" class="nav-link" data-scroll-target="#公交站400m-buffer">2.1.1 公交站400m buffer</a></li>
  <li><a href="#crime-numbers" id="toc-crime-numbers" class="nav-link" data-scroll-target="#crime-numbers">2.1.2 Crime numbers</a></li>
  <li><a href="#spatial-feature" id="toc-spatial-feature" class="nav-link" data-scroll-target="#spatial-feature">2.1.3 Spatial Feature</a></li>
  <li><a href="#poi-numbers酒类销售点" id="toc-poi-numbers酒类销售点" class="nav-link" data-scroll-target="#poi-numbers酒类销售点">2.1.3 POI Numbers（酒类销售点）</a></li>
  <li><a href="#infrastructure-numbers路灯密度" id="toc-infrastructure-numbers路灯密度" class="nav-link" data-scroll-target="#infrastructure-numbers路灯密度">2.1.4 Infrastructure Numbers（路灯密度）</a></li>
  <li><a href="#census-demographics" id="toc-census-demographics" class="nav-link" data-scroll-target="#census-demographics">2.1.5 Census Demographics</a></li>
  </ul></li>
  <li><a href="#k-nearest-neighbor-features" id="toc-k-nearest-neighbor-features" class="nav-link" data-scroll-target="#k-nearest-neighbor-features"><strong>2.2 k-Nearest Neighbor features:</strong></a>
  <ul class="collapse">
  <li><a href="#police-station-knn-1" id="toc-police-station-knn-1" class="nav-link" data-scroll-target="#police-station-knn-1">2.2.1 Police station (KNN-1)</a></li>
  </ul></li>
  <li><a href="#get-police-service-area-psa-id-for-fixed-effects" id="toc-get-police-service-area-psa-id-for-fixed-effects" class="nav-link" data-scroll-target="#get-police-service-area-psa-id-for-fixed-effects">2.3 Get Police Service Area (PSA) ID for Fixed Effects</a></li>
  <li><a href="#merge-features-into-master-dataset" id="toc-merge-features-into-master-dataset" class="nav-link" data-scroll-target="#merge-features-into-master-dataset">2.4 Merge Features into Master Dataset</a></li>
  <li><a href="#检查psa数据密度" id="toc-检查psa数据密度" class="nav-link" data-scroll-target="#检查psa数据密度">2.5 检查PSA数据密度</a></li>
  </ul></li>
  <li><a href="#phase-3-exploratory-data-analysis" id="toc-phase-3-exploratory-data-analysis" class="nav-link" data-scroll-target="#phase-3-exploratory-data-analysis">Phase 3: Exploratory Data Analysis</a>
  <ul class="collapse">
  <li><a href="#distribution-of-crime-and-bus-stop-ridership-histogram" id="toc-distribution-of-crime-and-bus-stop-ridership-histogram" class="nav-link" data-scroll-target="#distribution-of-crime-and-bus-stop-ridership-histogram">3.1 Distribution of Crime and Bus Stop Ridership (histogram)</a></li>
  <li><a href="#spatial-distribution-of-crime-and-bus-stop-ridershipmap" id="toc-spatial-distribution-of-crime-and-bus-stop-ridershipmap" class="nav-link" data-scroll-target="#spatial-distribution-of-crime-and-bus-stop-ridershipmap">3.2 Spatial distribution of crime and Bus Stop Ridership(map)</a></li>
  <li><a href="#crime-vs.-bus-stop-ridership-scatter-plots" id="toc-crime-vs.-bus-stop-ridership-scatter-plots" class="nav-link" data-scroll-target="#crime-vs.-bus-stop-ridership-scatter-plots">3.3 Crime vs.&nbsp;Bus Stop Ridership (scatter plots)</a></li>
  <li><a href="#crime-vs.-spatial-social-features-scatter-plots" id="toc-crime-vs.-spatial-social-features-scatter-plots" class="nav-link" data-scroll-target="#crime-vs.-spatial-social-features-scatter-plots">3.4 Crime vs.&nbsp;Spatial &amp; Social features (scatter plots)</a></li>
  <li><a href="#correlation-matrix-of-features-for-all-features" id="toc-correlation-matrix-of-features-for-all-features" class="nav-link" data-scroll-target="#correlation-matrix-of-features-for-all-features">3.5 Correlation Matrix of Features for all Features</a></li>
  <li><a href="#crime-distribution-in-weekdays-and-weekends" id="toc-crime-distribution-in-weekdays-and-weekends" class="nav-link" data-scroll-target="#crime-distribution-in-weekdays-and-weekends">3.6 Crime distribution in weekdays and weekends</a></li>
  </ul></li>
  <li><a href="#phase-4-model-building负二项式" id="toc-phase-4-model-building负二项式" class="nav-link" data-scroll-target="#phase-4-model-building负二项式">Phase 4: Model Building(负二项式)</a>
  <ul class="collapse">
  <li><a href="#ridership-only" id="toc-ridership-only" class="nav-link" data-scroll-target="#ridership-only"><strong>4.1 Ridership only:</strong></a></li>
  <li><a href="#the-interaction-核心假设" id="toc-the-interaction-核心假设" class="nav-link" data-scroll-target="#the-interaction-核心假设">**4.2 The Interaction (核心假设)</a></li>
  <li><a href="#built-environment-and-demographics-features加入环境控制" id="toc-built-environment-and-demographics-features加入环境控制" class="nav-link" data-scroll-target="#built-environment-and-demographics-features加入环境控制"><strong>4.3 Built Environment and Demographics features:</strong>(加入环境控制)</a></li>
  <li><a href="#空间固定效应" id="toc-空间固定效应" class="nav-link" data-scroll-target="#空间固定效应"><strong>4.4 空间固定效应:</strong></a></li>
  <li><a href="#model-5-crime-temporal-lag" id="toc-model-5-crime-temporal-lag" class="nav-link" data-scroll-target="#model-5-crime-temporal-lag">Model 5 crime temporal lag</a></li>
  <li><a href="#model6-比model5减去income" id="toc-model6-比model5减去income" class="nav-link" data-scroll-target="#model6-比model5减去income">Model6 比model5减去income</a></li>
  <li><a href="#输出对比表格" id="toc-输出对比表格" class="nav-link" data-scroll-target="#输出对比表格"><strong>4.5 输出对比表格</strong></a></li>
  </ul></li>
  <li><a href="#phase-5-model-validation" id="toc-phase-5-model-validation" class="nav-link" data-scroll-target="#phase-5-model-validation">Phase 5: Model Validation</a>
  <ul class="collapse">
  <li><a href="#compare-all-5-models" id="toc-compare-all-5-models" class="nav-link" data-scroll-target="#compare-all-5-models"><strong>5.1 Compare all 5 models:</strong></a>
  <ul class="collapse">
  <li><a href="#create-predicted-vs.-actual-plot" id="toc-create-predicted-vs.-actual-plot" class="nav-link" data-scroll-target="#create-predicted-vs.-actual-plot">5.1.1 Create predicted vs.&nbsp;actual plot</a></li>
  <li><a href="#report-and-compare-rmse-mae-r²" id="toc-report-and-compare-rmse-mae-r²" class="nav-link" data-scroll-target="#report-and-compare-rmse-mae-r²">5.1.2 Report and Compare RMSE, MAE, R²</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#phase-6-model-diagnostics" id="toc-phase-6-model-diagnostics" class="nav-link" data-scroll-target="#phase-6-model-diagnostics">Phase 6: Model Diagnostics</a>
  <ul class="collapse">
  <li><a href="#check-assumptions-for-best-model" id="toc-check-assumptions-for-best-model" class="nav-link" data-scroll-target="#check-assumptions-for-best-model">Check assumptions for best model:</a></li>
  <li><a href="#spatial-autocorrelation-of-residuals-morans-i" id="toc-spatial-autocorrelation-of-residuals-morans-i" class="nav-link" data-scroll-target="#spatial-autocorrelation-of-residuals-morans-i"><strong>6.1 Spatial Autocorrelation of Residuals (Moran’s I)</strong></a></li>
  <li><a href="#residual-plot找实际犯罪预测" id="toc-residual-plot找实际犯罪预测" class="nav-link" data-scroll-target="#residual-plot找实际犯罪预测"><strong>6.1 Residual plot:（找实际犯罪&gt;预测）</strong></a></li>
  <li><a href="#q-q-plot" id="toc-q-q-plot" class="nav-link" data-scroll-target="#q-q-plot"><strong>6.2 Q-Q plot:</strong></a></li>
  <li><a href="#top-50-风险站点地图" id="toc-top-50-风险站点地图" class="nav-link" data-scroll-target="#top-50-风险站点地图"><strong>6.3</strong> Top 50 风险站点地图<strong>:</strong></a></li>
  </ul></li>
  <li><a href="#phase-7-conclusions" id="toc-phase-7-conclusions" class="nav-link" data-scroll-target="#phase-7-conclusions">Phase 7: Conclusions</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">7.1 Results:</a></li>
  <li><a href="#the-action-plan" id="toc-the-action-plan" class="nav-link" data-scroll-target="#the-action-plan">7.2 The Action Plan:</a></li>
  <li><a href="#equity-concerns" id="toc-equity-concerns" class="nav-link" data-scroll-target="#equity-concerns"><strong>7.3 Equity concerns</strong></a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Safe Passage: Modeling Crime Risk around SEPTA Bus Stops</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Xinyuan Cui, Yuqing Yang, Jinyang Xu </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>预测“<strong>客流带来的社会影响 (公共安全)</strong>”，“<strong>帮助警察部门救命</strong>”。Shark Tank 的评委（通常是政府官员）会对“安全”话题极其敏感。</p>
<p>核心问题： 客流大到底是带来了“街道眼 (Eyes on the Street)”从而抑制了犯罪，还是带来了更多的“潜在受害者 (Targets)”从而吸引了扒窃？</p>
<p>政策目标： 帮助 SEPTA 警察部门 (Transit Police) 预测哪些站点周边是犯罪高风险区，从而优化巡逻警力部署。</p>
<p>选题：做 <strong>“Bus Ridership -&gt; Crime”</strong> 模型</p>
<p><strong>因变量</strong> (预测目标): 站点周边 400米内的犯罪数量 (Crime Incidents Count)</p>
<p><strong>自变量</strong>: Regional Rail Ridership: 使用你的 Regional_Rail_Station_Summary.csv。</p>
<p>其他自变量: 人口统计 (Census): 贫困率、年轻男性比例。建成环境 (Built Env): 路灯密度 (Street Light Locations)、空置地块 (Vacant Land)。时间特征: 如果你做面板数据，可以加入周末/工作日。“诱发因子” ：<strong>酒类销售点 (Alcohol Outlets):</strong><em>数据源:</em> OpenDataPhilly (Liquor Licenses).+<strong>商业密度 (Commercial Density):</strong><em>数据源:</em> Land Use (Zoning) 或 OSM。<strong>房屋空置率 (Vacancy Rate) / 311 投诉:</strong><em>数据源:</em> OpenDataPhilly。<strong>距离最近警局的距离 (Dist to Police Station):</strong> <em>数据源:</em> OpenDataPhilly (Police Stations)。</p>
<p>模型方法: Negative Binomial Regression (负二项回归): 犯罪数据也是计数数据，且离散度极高（很多地方没犯罪，少数地方特别多）。</p>
<p>Local Spatial Regression (GWR): 探索客流对犯罪的影响在不同社区是否不同？</p>
<p>Shark Tank Pitch: “SEPTA 的首要任务是安全。我们的模型不预测有多少人坐车，而是预测哪里最需要警察。我们利用客流数据作为核心指标，识别出那些‘高客流但高犯罪’的异常站点，建议在此增加监控和巡逻。”</p>
<section id="phase-1-data-preparation" class="level1">
<h1>Phase 1: Data Preparation</h1>
<p>The primary dataset we use is 2025summer Septa bus ridership data.The validity of any predictive model rests on the quality of its underlying data. In this initial phase, we focus strictly on data preparation and exploratory visualization. We load and clean the raw ridership, crime dataset and other datasets to handle missing values and outliers. Through initial descriptive analytics and visualization, we assess the statistical properties of our datasets.</p>
<section id="complete-data-cleaning-code" class="level2">
<h2 class="anchored" data-anchor-id="complete-data-cleaning-code">1.0 Complete data cleaning code</h2>
<p><strong><em>Load necessary libraries</em></strong></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>, <span class="at">tigris_class =</span> <span class="st">"sf"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nngeo)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tigris_progress =</span> <span class="cn">FALSE</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong><em>Define themes</em></strong></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plotTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"#D0D0D0"</span>, <span class="at">size =</span> <span class="fl">0.2</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'transparent'</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'cm'</span>),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>palette5 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#eff3ff"</span>, <span class="st">"#bdd7e7"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#3182bd"</span>, <span class="st">"#08519c"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-and-clean-bus-stop-ridership-data" class="level2">
<h2 class="anchored" data-anchor-id="load-and-clean-bus-stop-ridership-data"><strong>1.1 Load and clean bus stop ridership data:</strong></h2>
<section id="load-bus-stop-ridership-data" class="level3">
<h3 class="anchored" data-anchor-id="load-bus-stop-ridership-data">1.1.1 Load bus stop ridership data</h3>
<p><a href="https://opendataphilly.org/datasets/septa-ridership-statistics/">2025 summer SEPTA bus ridership data</a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Load Bus Data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>bus_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/Summer_2025_Stop_Summary_(Bus).csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="clean" class="level3">
<h3 class="anchored" data-anchor-id="clean">1.1.2 Clean</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get Philadelphia Boundary</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>philly_boundary <span class="ot">&lt;-</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">"PA"</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>, <span class="at">class =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Philadelphia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In preparing the ridership data, we performed two critical structural transformations to align with our research goals.<br>
First, we <strong>aggregated bidirectional stops</strong> sharing the same location (including opposite sides of a street) into single spatial units. This prevents spatial autocorrelation and ensures our 400m buffers capture a unique street environment.<br>
Second, we <strong>restructured the dataset into a ‘long format’ (panel data)</strong>, distinguishing between Weekday and Weekend ridership. This temporal split is vital, as it allows our model to capture the distinct behavioral patterns of both commuters and potential offenders during different times of the week.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Process Ridership: Create Long Format (Aggregated + Weekday vs Weekend)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>bus_long <span class="ot">&lt;-</span> bus_raw <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A. 基础清洗</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(Lon)) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B. 预计算每个物理站牌的客流 (Pre-calculate per stop_code)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Raw_Weekday =</span> Weekdays_O <span class="sc">+</span> Weekdays_1,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weekend average = (Sat total + Sun total) / 2</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Raw_Weekend =</span> (Saturdays_ <span class="sc">+</span> Saturdays1 <span class="sc">+</span> Sundays_On <span class="sc">+</span> Sundays_Of) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># C. [新增步骤] 聚合双向站点 (Aggregation by Stop Name)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 这一步把同名的站点（比如 "Broad St &amp; Walnut St" 的双向）合二为一</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop) <span class="sc">%&gt;%</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 两个方向的客流相加</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ridership_Weekday =</span> <span class="fu">sum</span>(Raw_Weekday, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ridership_Weekend =</span> <span class="fu">sum</span>(Raw_Weekend, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 坐标取平均值</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lat =</span> <span class="fu">mean</span>(Lat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> <span class="fu">mean</span>(Lon, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 保留一个 Stop_Code 作为 ID</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">Stop_Code =</span> <span class="fu">first</span>(Stop_Code),</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># D. Pivot to Long Format (把宽数据变长数据)</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 现在每个站点会变成两行：一行 Weekday，一行 Weekend</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Ridership_Weekday, Ridership_Weekend),</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Time_Type"</span>,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Ridership"</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E. Create Dummy Variable &amp; Clean up</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> <span class="fu">if_else</span>(Time_Type <span class="sc">==</span> <span class="st">"Ridership_Weekend"</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time_Category =</span> <span class="fu">if_else</span>(is_weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># F. Convert to SF &amp; Clip</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(philly_boundary) <span class="sc">%&gt;%</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Stop_Code, Stop, Ridership, is_weekend, Time_Category, geometry)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total Aggregated Stops (Unique Locations):"</span>, <span class="fu">nrow</span>(bus_long) <span class="sc">/</span> <span class="dv">2</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total Aggregated Stops (Unique Locations): 5884 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total Observation Rows (Panel Data):"</span>, <span class="fu">nrow</span>(bus_long), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total Observation Rows (Panel Data): 11768 </code></pre>
</div>
</div>
</section>
<section id="visualization" class="level3">
<h3 class="anchored" data-anchor-id="visualization">1.1.3 Visualization</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Prepare Base Map (Philly Boundary)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保之前已经加载了 tigris 包并获取了边界</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># philly_boundary &lt;- counties(state = "PA", cb = TRUE, class = "sf") %&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(NAME == "Philadelphia") %&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   st_transform(2272)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Plot the Map</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A. Base Layer: Philadelphia County Background</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"grey98"</span>, </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"grey50"</span>, </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B. Station Layer: Simple Points</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># [修改点] 只筛选 Weekday 的行来画图，避免每个点画两次导致重叠</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> bus_long <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_weekend <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"#3182bd"</span>,  <span class="co"># SEPTA Blue</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.1</span>,         <span class="co"># Small dots to avoid clutter</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span>      <span class="co"># Slight transparency</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># C. Styling</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spatial Coverage of SEPTA Bus Network"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># [修改点] 修正 nrow 除法的语法</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Total Aggregated Stops: "</span>, <span class="fu">nrow</span>(bus_long) <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: SEPTA Summer 2025 Stop Summary"</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span> <span class="co"># Clean look</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">"cm"</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/map_stations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure illustrates the extensive spatial coverage of the SEPTA bus network within Philadelphia. After aggregating bidirectional stops, our study includes <strong>5,884 unique locations</strong>.<br>
The distribution reveals <strong>a high density in the Center City</strong> and <strong>a grid-like arterial pattern extending into residential neighborhoods</strong>. This comprehensive coverage ensures that our analysis captures a diverse range of built environments, from dense commercial districts to suburban residential areas.</p>
</section>
</section>
<section id="load-and-clean-secondary-dataset" class="level2">
<h2 class="anchored" data-anchor-id="load-and-clean-secondary-dataset"><strong>1.2 Load and clean secondary dataset:</strong></h2>
<section id="crime-data" class="level3">
<h3 class="anchored" data-anchor-id="crime-data">1.2.1 Crime data:</h3>
<p><a href="https://opendataphilly.org/datasets/crime-incidents/">Crime Incidents from 2024</a></p>
<p>We excluded domestic disputes or indoor financial crimes because SEPTA Transit Police cannot police inside people’s homes. Instead, we selected these specific crime types because they occur in the public right-of-way and directly impact a rider’s decision to use public transit.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 1.2.1 Crime data:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义“街头犯罪”列表 (排除室内/家庭纠纷/非蓄意犯罪)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># target_crime_types &lt;- c(</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Robbery Firearm",</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Robbery No Firearm",</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Aggravated Assault Firearm",</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Aggravated Assault No Firearm",</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Homicide - Criminal",</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Rape",</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Other Sex Offenses (Not Commercialized)",</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Weapon Violations",</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Narcotic / Drug Law Violations",</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Vandalism/Criminal Mischief",</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Prostitution and Commercialized Vice",</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   "Public Drunkenness"</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>crime_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/crime2024.csv"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter &amp; Transform</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>crime_raw <span class="ot">&lt;-</span> crime_raw <span class="sc">%&gt;%</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(lng))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 单独保存 1–3 月的数据</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>crime_q1 <span class="ot">&lt;-</span> crime_raw <span class="sc">%&gt;%</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lubridate<span class="sc">::</span><span class="fu">month</span>(dispatch_date) <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_date =</span> <span class="fu">as.Date</span>(dispatch_date), </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(crime_date), <span class="co"># 1 is Sunday, 7 is Saturday</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_crime_weekend =</span> <span class="fu">if_else</span>(day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lng"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)  </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a> <span class="co"># 1. 筛选 4–6 月</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>crime_sf <span class="ot">&lt;-</span> crime_raw <span class="sc">%&gt;%</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lubridate<span class="sc">::</span><span class="fu">month</span>(dispatch_date) <span class="sc">%in%</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)<span class="sc">%&gt;%</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. 筛选：只保留列表中的犯罪类型</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">#filter(text_general_code %in% target_crime_types) %&gt;%</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. 时间特征处理</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_date =</span> <span class="fu">as.Date</span>(dispatch_date), </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(crime_date), <span class="co"># 1 is Sunday, 7 is Saturday</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_crime_weekend =</span> <span class="fu">if_else</span>(day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lng"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印检查</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total Selected Crimes (Count):"</span>, <span class="fu">nrow</span>(crime_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total Selected Crimes (Count): 24184 </code></pre>
</div>
</div>
</section>
<section id="census-data-tidycensus" class="level3">
<h3 class="anchored" data-anchor-id="census-data-tidycensus">1.2.2 Census data (tidycensus):</h3>
<p>To isolate the true impact of transit ridership on crime, we must first account for the socio-economic context of the neighborhood. A bus stop in a distressed area faces different risks than one in a wealthy suburb.<br>
By integrating 2023 ACS Census data, we control for structural disadvantages—such as poverty rates, unemployment, and housing vacancy.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(<span class="st">"42bf8a20a3df1def380f330cf7edad0dd5842ce6"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">install =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Census data for Philadelphia tracts</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>philly_census <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="fu">c</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_pop =</span> <span class="st">"B01003_001"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">poverty_pop =</span> <span class="st">"B17001_002"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">med_income =</span> <span class="st">"B19013_001"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ba_degree =</span> <span class="st">"B15003_022"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_edu =</span> <span class="st">"B15003_001"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">labor_force =</span> <span class="st">"B23025_003"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">unemployed =</span> <span class="st">"B23025_005"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_housing =</span> <span class="st">"B25002_001"</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">vacant_housing =</span> <span class="st">"B25002_003"</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2023</span>, </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">"PA"</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">county =</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"wide"</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 注意：所有变量名后面都要加 "E"</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">Poverty_Rate =</span> poverty_popE <span class="sc">/</span> total_popE,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Income =</span> med_incomeE,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 修正部分：加上 E</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">ba_rate =</span> <span class="dv">100</span> <span class="sc">*</span> ba_degreeE <span class="sc">/</span> total_eduE,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">unemployment_rate =</span> <span class="dv">100</span> <span class="sc">*</span> unemployedE <span class="sc">/</span> labor_forceE,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">vacancy_rate =</span> <span class="dv">100</span> <span class="sc">*</span> vacant_housingE <span class="sc">/</span> total_housingE</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(GEOID, Poverty_Rate, Med_Income, ba_rate, unemployment_rate, vacancy_rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="spatial-amenities" class="level3">
<h3 class="anchored" data-anchor-id="spatial-amenities">1.2.3 Spatial amenities</h3>
<p>We ingest data from OpenDataPhilly to capture the built environment’s impact on safety. This includes <code>Alcohol Outlets</code> (potential crime generators), <code>Street Lights</code> (natural surveillance/visibility) and <code>Police Stations</code> (formal guardianship/deterrence).</p>
<ul>
<li><p><a href="https://github.com/mafichman/cpln_6890/blob/main/plcb_licenses/PHL_PLCB_geocoded.csv">Alcohol Outlets</a></p></li>
<li><p><a href="https://opendataphilly.org/datasets/street-poles/">Street Poles</a></p></li>
<li><p><a href="https://opendataphilly.org/datasets/police-stations/">Police Stations</a></p></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A. Alcohol Outlets (Crime Generators)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>alcohol_sf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/PHL_PLCB_geocoded.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lon) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(lat)) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># B. Street Lights (Guardianship)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>lights_sf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/Street_Poles.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(X) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(Y)) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 修正：原始坐标是 EPSG:3857 (Web Mercator)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">3857</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 然后再转为费城投影</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Proximity to police stations acts as a proxy for formal guardianship. We load these coordinates to later calculate the distance-based deterrence effect.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># C. Police Stations (Guardianship) </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 直接读取包含坐标的 GeoJSON 文件</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>police_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/Police_Stations.geojson"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>) <span class="co"># 统一转为 PA State Plane</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total Police Stations:"</span>, <span class="fu">nrow</span>(police_sf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total Police Stations: 20</code></pre>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="phase-2-feature-engineering" class="level1">
<h1>Phase 2: Feature Engineering</h1>
<p>Phase 2 transforms our raw spatial data into analytical features. A bus stop is not just a point on a map; it is the center of a dynamic micro-environment. To capture this, we employ a <strong>400-meter buffer</strong> approach—roughly equivalent to a <strong>5-minute walk</strong>, defining the ‘catchment area’ for each station.</p>
<p>After that, we shift our focus to investigating the aggregate relationships between our independent variables (e.g., ridership, built environment) and the dependent variable (crime counts). This exploratory analysis allows us to observe baseline correlations and structural patterns, providing the necessary empirical support for our subsequent <strong>Negative Binomial modeling</strong>.</p>
<section id="buffer-creation" class="level2">
<h2 class="anchored" data-anchor-id="buffer-creation"><strong>2.1 Buffer creation:</strong></h2>
<section id="公交站400m-buffer" class="level3">
<h3 class="anchored" data-anchor-id="公交站400m-buffer">2.1.1 公交站400m buffer</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Buffer(400m)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>bus_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(bus_long, <span class="dv">1312</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="crime-numbers" class="level3">
<h3 class="anchored" data-anchor-id="crime-numbers">2.1.2 Crime numbers</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 2.1.2 Crime numbers (Corrected with Normalization)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 计算数据集中包含的“总天数” (Exposure)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 这一步会自动计算你的 crime_sf 数据里涵盖了多少个工作日，多少个周末</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>day_counts <span class="ot">&lt;-</span> crime_sf <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(is_crime_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_days =</span> <span class="fu">n_distinct</span>(crime_date)) <span class="co"># 统计有多少个不重复的日期</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印天数检查 (你会发现 Weekday 天数大约是 Weekend 的 2.5 倍)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(day_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  is_crime_weekend n_days
             &lt;dbl&gt;  &lt;int&gt;
1                0     65
2                1     26</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 关联并计算日均犯罪 (Rate)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>crime_agg <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_buffer, crime_sf, <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_weekend <span class="sc">==</span> is_crime_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop_Code, is_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Total_Count =</span> <span class="fu">n</span>() <span class="co"># 原始总数 (用于模型)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 把天数信息 join 进来</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(day_counts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"is_weekend"</span> <span class="ot">=</span> <span class="st">"is_crime_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 关键修正：计算日均犯罪量</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Daily_Rate =</span> Crime_Total_Count <span class="sc">/</span> n_days,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 同时也保留 n_days，因为负二项回归模型需要它作为 offset</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Exposure_Days =</span> n_days</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 检查结果</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(crime_agg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
# Groups:   Stop_Code [3]
  Stop_Code is_weekend Crime_Total_Count n_days Crime_Daily_Rate Exposure_Days
      &lt;dbl&gt;      &lt;dbl&gt;             &lt;int&gt;  &lt;int&gt;            &lt;dbl&gt;         &lt;int&gt;
1         2          0                11     65           0.169             65
2         2          1                 2     26           0.0769            26
3         4          0                70     65           1.08              65
4         4          1                26     26           1                 26
5         5          0               102     65           1.57              65
6         5          1                34     26           1.31              26</code></pre>
</div>
</div>
</section>
<section id="spatial-feature" class="level3">
<h3 class="anchored" data-anchor-id="spatial-feature">2.1.3 Spatial Feature</h3>
<p>We know that a dangerous corner doesn’t become safe overnight. To make our model fair, we must acknowledge that some stops have a history of trouble.</p>
<p>We calculated the crime counts for each stop <strong>from the previous season (Q1)</strong>. We try to explain: ‘Given how dangerous this spot usually is, does adding more bus riders make it safer or worse?’</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 2.1.2 Lag Crime numbers (Corrected with Normalization)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 计算 Q1 数据集中包含的“总天数” (Exposure)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>day_counts_q1 <span class="ot">&lt;-</span> crime_q1 <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(is_crime_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_days_lag =</span> <span class="fu">n_distinct</span>(crime_date)) </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印天数检查</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(day_counts_q1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  is_crime_weekend n_days_lag
             &lt;dbl&gt;      &lt;int&gt;
1                0         65
2                1         26</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 关联并计算日均犯罪 (Rate) —— 完全复制你的 Q2 逻辑</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>crime_lag_q1 <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_buffer, crime_q1, <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_weekend <span class="sc">==</span> is_crime_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop_Code, is_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Total_Count_lag =</span> <span class="fu">n</span>()   <span class="co"># lag 原始总数</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(day_counts_q1, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"is_weekend"</span> <span class="ot">=</span> <span class="st">"is_crime_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Daily_Rate_lag =</span> Crime_Total_Count_lag <span class="sc">/</span> n_days_lag,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Exposure_Days_lag    =</span> n_days_lag</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 检查结果</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(crime_lag_q1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
# Groups:   Stop_Code [3]
  Stop_Code is_weekend Crime_Total_Count_lag n_days_lag Crime_Daily_Rate_lag
      &lt;dbl&gt;      &lt;dbl&gt;                 &lt;int&gt;      &lt;int&gt;                &lt;dbl&gt;
1         2          0                     5         65               0.0769
2         2          1                     2         26               0.0769
3         4          0                    63         65               0.969 
4         4          1                    26         26               1     
5         5          0                    52         65               0.8   
6         5          1                    27         26               1.04  
# ℹ 1 more variable: Exposure_Days_lag &lt;int&gt;</code></pre>
</div>
</div>
</section>
<section id="poi-numbers酒类销售点" class="level3">
<h3 class="anchored" data-anchor-id="poi-numbers酒类销售点">2.1.3 POI Numbers（酒类销售点）</h3>
<p>Alcohol outlets are established ‘crime generators.’ We load their locations to model areas with higher potential for intoxication-related conflicts.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Count Alcohol Outlets</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>alcohol_agg <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_buffer, alcohol_sf, <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 按 Stop 和 时间类型分组，这样每一行都会得到计数</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop_Code, is_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Alcohol_Count =</span> <span class="fu">n</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Subtract 1 because st_join is left join (self-intersection NA check)</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="infrastructure-numbers路灯密度" class="level3">
<h3 class="anchored" data-anchor-id="infrastructure-numbers路灯密度">2.1.4 Infrastructure Numbers（路灯密度）</h3>
<p>Street lighting is a key component of CPTED (Crime Prevention Through Environmental Design). We process the location of street poles to estimate visibility and natural surveillance levels.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Count Street Lights</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>light_agg <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_buffer, lights_sf, <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop_Code, is_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Light_Count =</span> <span class="fu">n</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="census-demographics" class="level3">
<h3 class="anchored" data-anchor-id="census-demographics">2.1.5 Census Demographics</h3>
<p>To control for neighborhood context, we calculated the average:<br>
- <code>Avg_Poverty</code>: Rate of economic deprivation.<br>
- <code>Avg_Income</code>: Proxy for local wealth and resources.<br>
- <code>Avg_BA</code>: Educational attainment.<br>
- <code>Avg_Unemployment</code>: Measure of labor market instability.<br>
- <code>Avg_Vacancy</code>: Indicator of physical disorder.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Average Census Demographics</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>census_agg <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_buffer, philly_census, <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Stop_Code, is_weekend) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Poverty =</span> <span class="fu">mean</span>(Poverty_Rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Income =</span> <span class="fu">mean</span>(Med_Income, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_BA =</span> <span class="fu">mean</span>(ba_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Unemployment =</span> <span class="fu">mean</span>(unemployment_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Vacancy =</span> <span class="fu">mean</span>(vacancy_rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="k-nearest-neighbor-features" class="level2">
<h2 class="anchored" data-anchor-id="k-nearest-neighbor-features"><strong>2.2 k-Nearest Neighbor features:</strong></h2>
<section id="police-station-knn-1" class="level3">
<h3 class="anchored" data-anchor-id="police-station-knn-1">2.2.1 Police station (KNN-1)</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate distance to nearest police station</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(bus_long, police_sf)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 取每一行的最小值，并换算成英里</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>bus_long<span class="sc">$</span>Dist_Police <span class="ot">&lt;-</span> <span class="fu">apply</span>(dist_matrix, <span class="dv">1</span>, min) <span class="sc">/</span> <span class="dv">5280</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="get-police-service-area-psa-id-for-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="get-police-service-area-psa-id-for-fixed-effects">2.3 Get Police Service Area (PSA) ID for Fixed Effects</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 加载 PSA 边界数据</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 请确保文件名跟你下载的一致</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>psa_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/Boundaries_PSA.geojson"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>) <span class="sc">%&gt;%</span> <span class="co"># 统一坐标系</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 费城 PSA 数据中，唯一的 ID 通常叫 "PSA_NUM" 或 "PSA_NAME"</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 我们这里假设它叫 "PSA_NUM" (例如 241, 143 等)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 如果你的列名不一样，请运行 names(psa_sf) 检查并修改下面这一行</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">PSA_ID =</span> PSA_NUM) </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 空间匹配：判断每个公交站属于哪个 PSA</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 注意：只取 weekday=0 的数据来做空间匹配，避免重复计算</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>stop_psa_mapping <span class="ot">&lt;-</span> bus_long <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_weekend <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(psa_sf) <span class="sc">%&gt;%</span> <span class="co"># 空间连接：点找面</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Stop_Code, PSA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 以防万一某个点在边界上匹配到了两个区，去重保留第一个</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(Stop_Code, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"PSA mapping created for"</span>, <span class="fu">nrow</span>(stop_psa_mapping), <span class="st">"stops.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>PSA mapping created for 5884 stops.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印一下看看长什么样，确保 ID 是存在的</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stop_psa_mapping)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  Stop_Code PSA_ID
      &lt;dbl&gt; &lt;chr&gt; 
1       759 033   
2     16397 251   
3     17921 351   
4     16054 352   
5     16102 221   
6     16104 221   </code></pre>
</div>
</div>
</section>
<section id="merge-features-into-master-dataset" class="level2">
<h2 class="anchored" data-anchor-id="merge-features-into-master-dataset">2.4 Merge Features into Master Dataset</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> bus_long <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join all aggregated tables</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(crime_agg,     <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop_Code"</span>, <span class="st">"is_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(crime_lag_q1,  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop_Code"</span>, <span class="st">"is_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(alcohol_agg,   <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop_Code"</span>, <span class="st">"is_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(light_agg,     <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop_Code"</span>, <span class="st">"is_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(census_agg,    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Stop_Code"</span>, <span class="st">"is_weekend"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- [修改点] Join PSA ID (原为 GEOID) ---</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(stop_psa_mapping, <span class="at">by =</span> <span class="st">"Stop_Code"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Handle NAs for Counts</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Total_Count =</span> <span class="fu">replace_na</span>(Crime_Total_Count, <span class="dv">0</span>),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Daily_Rate  =</span> <span class="fu">replace_na</span>(Crime_Daily_Rate, <span class="dv">0</span>),</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ⭐ 处理 lag crime 的 NA（如果某站点 Q1 没犯罪）</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Total_Count_lag =</span> <span class="fu">replace_na</span>(Crime_Total_Count_lag, <span class="dv">0</span>),</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Crime_Daily_Rate_lag  =</span> <span class="fu">replace_na</span>(Crime_Daily_Rate_lag, <span class="dv">0</span>),</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Alcohol_Count =</span> <span class="fu">replace_na</span>(Alcohol_Count, <span class="dv">0</span>),</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Light_Count   =</span> <span class="fu">replace_na</span>(Light_Count, <span class="dv">0</span>),</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Log transform Ridership</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">Log_Ridership =</span> <span class="fu">log</span>(Ridership <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Create Factor for Interaction Term</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend_factor =</span> <span class="fu">factor</span>(is_weekend, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>                               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span>, <span class="st">"Weekend"</span>)),</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Clean up</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># [修改点] 过滤掉没有匹配到 PSA 的站点 (原为 !is.na(GEOID))</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PSA_ID)) <span class="sc">%&gt;%</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() </span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final Panel Dataset Rows:"</span>, <span class="fu">nrow</span>(final_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Panel Dataset Rows: 11066</code></pre>
</div>
</div>
</section>
<section id="检查psa数据密度" class="level2">
<h2 class="anchored" data-anchor-id="检查psa数据密度">2.5 检查PSA数据密度</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 统计每个 PSA 有多少个样本 (Panel Data Rows)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>psa_counts <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PSA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_observations =</span> <span class="fu">n</span>(),              <span class="co"># 总行数 (weekday + weekend)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stops =</span> <span class="fu">n_distinct</span>(Stop_Code)    <span class="co"># 物理站点数</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(n_observations)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 打印最少样本的 10 个 PSA</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(psa_counts, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 10 features and 3 fields
Geometry type: MULTIPOINT
Dimension:     XY
Bounding box:  xmin: 2669882 ymin: 215531.6 xmax: 2715062 ymax: 279357.4
Projected CRS: NAD83 / Pennsylvania South (ftUS)
# A tibble: 10 × 4
   PSA_ID n_observations n_stops                                        geometry
   &lt;chr&gt;           &lt;int&gt;   &lt;int&gt;                   &lt;MULTIPOINT [US_survey_foot]&gt;
 1 122                32      16 ((2670537 223892.4), (2670585 223932.8), (2670…
 2 124                58      29 ((2671643 232878.2), (2672084 233106.1), (2672…
 3 053                68      42 ((2670063 279330.9), (2670112 279357.4), (2670…
 4 012                83      44 ((2685082 218564.9), (2685568 218997.3), (2686…
 5 224                86      43 ((2686092 246848.8), (2686176 246409.7), (2686…
 6 393                90      45 ((2688934 252812), (2688968 253070.2), (268922…
 7 181                96      48 ((2669882 237256), (2669902 237214.7), (266998…
 8 243                96      49 ((2706035 247307.4), (2706350 248302.6), (2706…
 9 242                98      49 ((2702265 250424.1), (2702297 250520.3), (2702…
10 052                99      50 ((2671211 266842), (2671303 266812.6), (267140…</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 这里的判断标准：</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果 n_observations 最小的值都 &gt; 5，恭喜你，CV 问题基本解决！</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果还是有 1 或 2，那 CV 依然可能会报错，但概率比 Tract 小多了。</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="phase-3-exploratory-data-analysis" class="level1">
<h1>Phase 3: Exploratory Data Analysis</h1>
<section id="distribution-of-crime-and-bus-stop-ridership-histogram" class="level2">
<h2 class="anchored" data-anchor-id="distribution-of-crime-and-bus-stop-ridership-histogram">3.1 Distribution of Crime and Bus Stop Ridership (histogram)</h2>
<p>Does ridership follow a normal distribution? No.&nbsp;That’s why we need Negative Binomial.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(final_data, <span class="fu">aes</span>(<span class="at">x =</span> Ridership)) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"#3182bd"</span>, <span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Ridership"</span>, <span class="at">x =</span> <span class="st">"Daily Boardings"</span>) <span class="sc">+</span> plotTheme</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(final_data, <span class="fu">aes</span>(<span class="at">x =</span> Crime_Total_Count)) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">fill =</span> <span class="st">"#de2d26"</span>, <span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Crime"</span>, <span class="at">x =</span> <span class="st">"Crime Count (400m)"</span>) <span class="sc">+</span> plotTheme</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The histograms reveal that both Ridership (Left) and Crime Counts (Right) follow <strong>a highly right-skewed, ‘long-tail’ distribution</strong>, rather than a normal bell curve. This extreme skewness mathematically confirm that a standard OLS Linear Regression would be biased.</p>
<p>This visual evidence creates a compelling mandate for using <strong>Negative Binomial Regression</strong>, which is specifically designed to handle such skewed count data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检查均值和方差</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>mean_crime <span class="ot">&lt;-</span> <span class="fu">mean</span>(final_data<span class="sc">$</span>Crime_Total_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>var_crime <span class="ot">&lt;-</span> <span class="fu">var</span>(final_data<span class="sc">$</span>Crime_Total_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean:"</span>, mean_crime, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean: 30.91478 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Variance:"</span>, var_crime, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Variance: 1190.485 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Ratio (Var/Mean):"</span>, var_crime <span class="sc">/</span> mean_crime, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ratio (Var/Mean): 38.50861 </code></pre>
</div>
</div>
<p>While many bus stops have zero incidents, a few ‘hotspots’ have very high counts. This causes <strong>the variance to be much larger than the mean</strong>. To address this overdispersion，which violates the core assumption of Poisson regression， we employed a <strong>Negative Binomial model</strong>. This approach allows us to model the data more accurately without inflating the significance of our findings.</p>
</section>
<section id="spatial-distribution-of-crime-and-bus-stop-ridershipmap" class="level2">
<h2 class="anchored" data-anchor-id="spatial-distribution-of-crime-and-bus-stop-ridershipmap">3.2 Spatial distribution of crime and Bus Stop Ridership(map)</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 需要先加载 patchwork 包，如果前面没加载，这里补充一下</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># library(patchwork) </span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. 准备绘图数据 (Extract Coordinates) ---</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># A. 处理公交数据：只取工作日数据以避免重复，并提取坐标</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>bus_plot_data <span class="ot">&lt;-</span> bus_long <span class="sc">%&gt;%</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_weekend <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span>   <span class="co"># 仅使用工作日数据代表典型客流</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="dv">1</span>],</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="dv">2</span>]</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="co"># 移除几何列，方便 stat_density_2d 使用</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co"># B. 处理犯罪数据：提取坐标</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>crime_plot_data <span class="ot">&lt;-</span> crime_sf <span class="sc">%&gt;%</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="dv">1</span>],</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="dv">2</span>]</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. 绘制图形 (Create Maps) ---</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 左图：客流热力图 (Ridership Density)</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 注意：aes(weight = Ridership) 是关键，让热力图基于客流量而不是站点数量</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>p_ridership <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 底图：费城轮廓</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"#f5f5f5"</span>, <span class="at">color =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 热力层</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_2d</span>(</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> bus_plot_data, </span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y, <span class="at">fill =</span> ..level.., <span class="at">weight =</span> Ridership), </span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"polygon"</span>, </span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 配色：蓝色系 (代表正常活动)</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Blues"</span>, <span class="at">direction =</span> <span class="dv">1</span>, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Weekday Ridership Hotspots"</span>, </span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"High Transit Activity Zones"</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>  mapTheme</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 右图：犯罪热力图 (Crime Density)</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>p_crime_map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 底图</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"#f5f5f5"</span>, <span class="at">color =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 热力层 (修改部分)</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density_2d</span>(</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> crime_plot_data, </span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y, <span class="at">fill =</span> ..level..), </span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"polygon"</span>, </span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.4</span>,       <span class="co"># 1. 调低透明度，减少"硬边"的感觉</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">30</span>,         <span class="co"># 2. 增加层数，让过渡更平滑 (原来默认很少)</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">adjust =</span> <span class="fl">0.5</span>       <span class="co"># 3. 调低带宽 (0.5), 让热力点收缩，更聚焦局部热点</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 配色</span></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Reds"</span>, <span class="at">direction =</span> <span class="dv">1</span>, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Crime Hotspots"</span>, </span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"High Incident Zones"</span></span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>  mapTheme</span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. 组合展示 (Combine Side-by-Side) ---</span></span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 patchwork 进行拼接</span></span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>combined_map <span class="ot">&lt;-</span> p_ridership <span class="sc">+</span> p_crime_map <span class="sc">+</span></span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spatial Mismatch Analysis: Eyes on the Street vs. Targets?"</span>,</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Left: Where people are (Ridership) | Right: Where crimes happen"</span>,</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">color =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出图形</span></span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>combined_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Transit activity is <strong>anchored in Center City</strong> and <strong>radiates outward along the major arterials</strong> (Broad St.and Market St.). However, crime exhibits a <strong>polycentric distribution</strong>. Beyond the city center, we observe significant high-crime clusters in North and West Philadelphia (Kensington/Allegheny).</p>
<p>This spatial mismatch suggests that <strong>ridership volume alone cannot explain crime risk</strong>. While the downtown core attracts crime due to sheer foot traffic (‘Targets’), the peripheral hotspots are likely driven by other environmental factors—such as socioeconomic disadvantage or the presence of crime generators (e.g., alcohol outlets)—rather than transit volume alone.</p>
</section>
<section id="crime-vs.-bus-stop-ridership-scatter-plots" class="level2">
<h2 class="anchored" data-anchor-id="crime-vs.-bus-stop-ridership-scatter-plots">3.3 Crime vs.&nbsp;Bus Stop Ridership (scatter plots)</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. 准备绘图数据 ---</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们需要计算“日均”数值，以保证公平比较 (因为工作日有5天，周末只有2天，不能比总数)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>bar_plot_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="co"># 移除空间属性，加快处理</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(is_weekend_factor) <span class="sc">%&gt;%</span> <span class="co"># 按 Weekday/Weekend 分组</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算平均每个站点的日均客流</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 如果原数据是 Log，记得还原，或者直接用原始 Ridership 列</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算平均每个站点的日均犯罪</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Crime_count =</span> <span class="fu">mean</span>(Crime_Daily_Rate, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#以此转换为长数据，方便 ggplot 分面画图</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(Avg_Ridership, Avg_Crime_count),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Metric"</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Value"</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 修改标签名，让图表更好看</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Metric_Label =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>      Metric <span class="sc">==</span> <span class="st">"Avg_Ridership"</span> <span class="sc">~</span> <span class="st">"Average Ridership"</span>,</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>      Metric <span class="sc">==</span> <span class="st">"Avg_Crime_count"</span> <span class="sc">~</span> <span class="st">"Average Crime Count"</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. 绘制图形 ---</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bar_plot_data, <span class="fu">aes</span>(<span class="at">x =</span> is_weekend_factor, <span class="at">y =</span> Value, <span class="at">fill =</span> is_weekend_factor)) <span class="sc">+</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Metric_Label, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#de2d26"</span>)) <span class="sc">+</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 标签和主题</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Volume vs. Risk: Weekday vs. Weekend"</span>,</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of Average  Ridership and Crime per Stop"</span>,</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">""</span>, </span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Count"</span>,</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Time Period"</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"grey40"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>), <span class="co"># 分面标题字体</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span> <span class="co"># </span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crime vs. Ridership (Interaction Plot)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 这是一个非常关键的图，用于验证你的核心假设：周末的客流影响是否不同？</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_data, <span class="fu">aes</span>(<span class="at">x =</span> Log_Ridership, <span class="at">y =</span> Crime_Daily_Rate, <span class="at">color =</span> is_weekend_factor)) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">family =</span> <span class="st">"quasipoisson"</span>), <span class="at">se =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#de2d26"</span>)) <span class="sc">+</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Does Ridership impact Crime differently on Weekends?"</span>,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Interaction Effect (Normalized by Number of Days)"</span>,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Log(Daily Ridership)"</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Daily Crime Count (per 400m)"</span>, <span class="co"># 修改 Y 轴标签</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Time Period"</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/eda_interaction-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p><strong>Crime Follows the Crowd (Bar Chart):</strong><br>
The left bar charts show that crime volume drops significantly on weekends, mirroring the drop in ridership shown in the right chart. This confirms that crime is likely driven by opportunity—fewer people on the street simply means fewer targets and fewer conflicts.</p></li>
<li><p><strong>The Risk “Conversion Rate” is Constant (Scatter Plot):</strong><br>
The interaction plot reveals <strong>a consistent positive correlation</strong> between ridership and crime counts across both weekdays and weekends. While the slopes exhibit only minor differences, the methodological value of this split is significant. By comparing the same bus stops during different time periods (Weekday vs.&nbsp;Weekend), we <strong>inherently control for static environmental factors</strong>, such as poverty rates, street lighting, and proximity to alcohol outlets, which remain constant regardless of the day.<br>
Consequently, this acts as a quasi-experimental control: since the physical environment is fixed, the persistent upward trend suggests that <strong>ridership itself is a direct driver of crime risk</strong>. This supports the ‘Targets’ hypothesis over the ‘Eyes on the Street’ theory, indicating that higher passenger volumes attract opportunistic crime regardless of the temporal context.</p></li>
</ul>
</section>
<section id="crime-vs.-spatial-social-features-scatter-plots" class="level2">
<h2 class="anchored" data-anchor-id="crime-vs.-spatial-social-features-scatter-plots">3.4 Crime vs.&nbsp;Spatial &amp; Social features (scatter plots)</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 为了可视化清晰，我们先创建一个带有 log(crime) 的临时绘图数据</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_crime =</span> <span class="fu">log</span>(Crime_Daily_Rate <span class="sc">+</span> <span class="fl">0.01</span>), <span class="co"># +1 避免 log(0)</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 给 Income 取个 log 看看是否更线性，很多经济学变量 log 后效果更好</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_income =</span> <span class="fu">log</span>(Avg_Income <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. POI &amp; Infrastructure (Built Environment) ---</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="co"># A. Alcohol Outlets (线性还是指数增加？)</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Alcohol_Count, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#6A1B9A"</span>) <span class="sc">+</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Alcohol Outlets"</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Check for diminishing returns"</span>,</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Count of Alcohol Outlets"</span>, <span class="at">y =</span> <span class="st">"Log(Crime Count)"</span>) <span class="sc">+</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="co"># B. Street Lights (路灯越多越安全？还是路灯只出现在繁华区？)</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Light_Count, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#6A1B9A"</span>) <span class="sc">+</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Street Lights"</span>,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Is the relationship linear?"</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Count of Street Lights"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="co"># C. Distance to Police (离警局越远越危险？)</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Dist_Police, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#6A1B9A"</span>) <span class="sc">+</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Dist to Police"</span>,</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Check for U-shape or threshold"</span>,</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Distance to Station (Miles)"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Demographics (Census) ---</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="co"># D. Poverty Rate (贫困率与犯罪)</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Avg_Poverty, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Poverty Rate"</span>,</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Poverty Rate"</span>, <span class="at">y =</span> <span class="st">"Log(Crime Count)"</span>) <span class="sc">+</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="co"># E. Median Income (收入与犯罪 - 这是一个典型的可能需要 log 的变量)</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Avg_Income, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Median Income"</span>,</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Does wealth shield against crime?"</span>,</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Median Household Income"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="co"># F. Vacancy Rate (空置率/破窗理论)</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Avg_Vacancy, <span class="at">y =</span> log_crime)) <span class="sc">+</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log(Crime) vs. Vacancy Rate"</span>,</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Housing Vacancy Rate"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Combine Plots ---</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">|</span> p2 <span class="sc">|</span> p3) <span class="sc">/</span> (p4 <span class="sc">|</span> p5 <span class="sc">|</span> p6) <span class="sc">+</span></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Exploratory Analysis: Variable Functional Forms"</span>,</span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red Line = Loess Smoother (Non-linear trend)"</span>,</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/3.4_scatter_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Before finalizing our model, we conducted an extensive exploratory analysis, testing relationships across multiple potential independent variables and their non-linear transformations. While we only present the variables with the most significant statistical relationships and policy implications here, this rigorous process of trial and error was essential to ensure the robustness of our final model. The charts above represent the distilled ‘risk signals’ identified from this comprehensive screening.</p>
</section>
<section id="correlation-matrix-of-features-for-all-features" class="level2">
<h2 class="anchored" data-anchor-id="correlation-matrix-of-features-for-all-features">3.5 Correlation Matrix of Features for all Features</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 选择数值型变量</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    Crime_Daily_Rate, </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    Ridership, </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    Alcohol_Count, </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    Light_Count, </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    Dist_Police, </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    Avg_Poverty, </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    Avg_Income, </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    Avg_Unemployment,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    Avg_Vacancy</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 计算相关系数矩阵</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(numeric_vars, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 绘图</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcorrplot</span>(</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>  corr_matrix, </span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"square"</span>, </span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"lower"</span>, </span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">lab =</span> <span class="cn">TRUE</span>, </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">lab_size =</span> <span class="dv">3</span>, </span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"#6D9EC1"</span>, <span class="st">"white"</span>, <span class="st">"#E46726"</span>), </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Correlation Matrix of Features"</span>,</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>如果矩阵显示它们的相关系数超过 0.7，不要把它们都放进模型！所以可以说这里没有超过0.7的，可以都放？ 另外如果后面监测到多重共线性，可以用这个矩阵决定怎么处理数据</p>
</section>
<section id="crime-distribution-in-weekdays-and-weekends" class="level2">
<h2 class="anchored" data-anchor-id="crime-distribution-in-weekdays-and-weekends">3.6 Crime distribution in weekdays and weekends</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="do">### 3.5 Weekend Effect Boxplot</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_data, <span class="fu">aes</span>(<span class="at">x =</span> is_weekend_factor, <span class="at">y =</span> Crime_Daily_Rate, <span class="at">fill =</span> is_weekend_factor)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 加上均值点</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">23</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 限制 Y 轴范围 (注意：现在的单位是“每天”，数值会很小，比如 0.05)</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 使用 quantile 自动截断极端值</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">quantile</span>(final_data<span class="sc">$</span>Crime_Daily_Rate, <span class="fl">0.95</span>))) <span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#de2d26"</span>)) <span class="sc">+</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Daily Crime Risk: Weekday vs. Weekend"</span>,</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of Average Daily Crime Counts per Stop"</span>,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time Period"</span>,</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Daily Crime Count (per 400m)"</span>, <span class="co"># 修改标签</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Note: Values represent daily averages to account for fewer weekend days per year."</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>坏了。。。。</p>
<p><strong>Key Findings:</strong></p>
<ul>
<li><p><strong>Spatial Variation in Property Values:</strong> The average sale price per square foot shows significant geographic clustering across census tracts, with distinct high-value areas concentrated in specific neighborhoods. This indicates strong spatial autocorrelation in housing prices, where adjacent tracts tend to have similar price levels.</p></li>
<li><p><strong>Correlation Between Property Condition and Location:</strong> Better average interior conditions are systematically concentrated in particular geographic areas, suggesting that housing maintenance and quality are not randomly distributed but follow spatial patterns that may correlate with neighborhood characteristics and property values.</p></li>
<li><p><strong>Heterogeneous Distribution of Housing Size:</strong> The average livable area varies substantially across census tracts, with larger properties clustered in specific regions. This spatial patterning of housing size complements the price distribution, indicating that both property characteristics and location factors contribute to the overall housing market structure in Philadelphia.</p></li>
</ul>
<hr>
</section>
</section>
<section id="phase-4-model-building负二项式" class="level1">
<h1>Phase 4: Model Building(负二项式)</h1>
<section id="ridership-only" class="level2">
<h2 class="anchored" data-anchor-id="ridership-only"><strong>4.1 Ridership only:</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>model_1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>                    Log_Ridership <span class="sc">+</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> final_data)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership + offset(log(Exposure_Days)), 
    data = final_data, init.theta = 1.962937689, link = log)

Coefficients:
               Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.328484   0.018925  -70.20   &lt;2e-16 ***
Log_Ridership  0.243197   0.004944   49.19   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.9629) family taken to be 1)

    Null deviance: 14335  on 11065  degrees of freedom
Residual deviance: 11852  on 11064  degrees of freedom
AIC: 92538

Number of Fisher Scoring iterations: 1

              Theta:  1.9629 
          Std. Err.:  0.0274 

 2 x log-likelihood:  -92531.6570 </code></pre>
</div>
</div>
<p><strong>Coefficient Interpretation:</strong></p>
</section>
<section id="the-interaction-核心假设" class="level2">
<h2 class="anchored" data-anchor-id="the-interaction-核心假设">**4.2 The Interaction (核心假设)</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>model_2 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                    Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> final_data) </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership * is_weekend_factor + 
    offset(log(Exposure_Days)), data = final_data, init.theta = 1.968491375, 
    link = log)

Coefficients:
                                        Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                            -1.434242   0.027417 -52.311  &lt; 2e-16
Log_Ridership                           0.263192   0.006798  38.716  &lt; 2e-16
is_weekend_factorWeekend                0.186359   0.038085   4.893 9.92e-07
Log_Ridership:is_weekend_factorWeekend -0.034408   0.010040  -3.427  0.00061
                                          
(Intercept)                            ***
Log_Ridership                          ***
is_weekend_factorWeekend               ***
Log_Ridership:is_weekend_factorWeekend ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.9685) family taken to be 1)

    Null deviance: 14371  on 11065  degrees of freedom
Residual deviance: 11849  on 11062  degrees of freedom
AIC: 92509

Number of Fisher Scoring iterations: 1

              Theta:  1.9685 
          Std. Err.:  0.0275 

 2 x log-likelihood:  -92498.9340 </code></pre>
</div>
</div>
<p><strong>Coefficient Interpretation:</strong></p>
<ul>
<li><p>Coefficient Evolution (vs.&nbsp;Model 1):</p></li>
<li><p>New Variable Interpretation:</p></li>
</ul>
</section>
<section id="built-environment-and-demographics-features加入环境控制" class="level2">
<h2 class="anchored" data-anchor-id="built-environment-and-demographics-features加入环境控制"><strong>4.3 Built Environment and Demographics features:</strong>(加入环境控制)</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>model_3 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                    Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span>        <span class="co"># 诱发因子</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 预防因子</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                    Avg_Poverty <span class="sc">+</span>          <span class="co"># 社会结构</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>                    Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 破窗效应</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                    Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>                    Avg_Unemployment <span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                    Dist_Police <span class="sc">+</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> final_data)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership * is_weekend_factor + 
    log(Alcohol_Count + 1) + poly(Light_Count, 2) + Avg_Poverty + 
    Avg_Vacancy + I(Avg_Vacancy^2) + Avg_Income + I(Avg_Income^2) + 
    Avg_Unemployment + Dist_Police + offset(log(Exposure_Days)), 
    data = final_data, init.theta = 3.809131636, link = log)

Coefficients:
                                         Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                            -8.603e-01  8.710e-02  -9.877  &lt; 2e-16
Log_Ridership                           1.102e-01  5.485e-03  20.086  &lt; 2e-16
is_weekend_factorWeekend                4.330e-02  2.965e-02   1.460  0.14416
log(Alcohol_Count + 1)                  2.836e-01  7.490e-03  37.869  &lt; 2e-16
poly(Light_Count, 2)1                   2.074e+01  9.830e-01  21.094  &lt; 2e-16
poly(Light_Count, 2)2                  -2.401e+00  6.208e-01  -3.867  0.00011
Avg_Poverty                             1.310e+00  1.157e-01  11.325  &lt; 2e-16
Avg_Vacancy                             5.836e-03  3.003e-03   1.943  0.05197
I(Avg_Vacancy^2)                       -1.034e-04  8.434e-05  -1.226  0.22030
Avg_Income                             -1.162e-05  1.435e-06  -8.097 5.64e-16
I(Avg_Income^2)                         5.343e-11  7.797e-12   6.852 7.27e-12
Avg_Unemployment                       -1.235e-02  1.879e-03  -6.575 4.87e-11
Dist_Police                            -1.986e-01  1.149e-02 -17.278  &lt; 2e-16
Log_Ridership:is_weekend_factorWeekend -2.319e-02  7.718e-03  -3.004  0.00266
                                          
(Intercept)                            ***
Log_Ridership                          ***
is_weekend_factorWeekend                  
log(Alcohol_Count + 1)                 ***
poly(Light_Count, 2)1                  ***
poly(Light_Count, 2)2                  ***
Avg_Poverty                            ***
Avg_Vacancy                            .  
I(Avg_Vacancy^2)                          
Avg_Income                             ***
I(Avg_Income^2)                        ***
Avg_Unemployment                       ***
Dist_Police                            ***
Log_Ridership:is_weekend_factorWeekend ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(3.8091) family taken to be 1)

    Null deviance: 25397  on 11065  degrees of freedom
Residual deviance: 11556  on 11052  degrees of freedom
AIC: 85737

Number of Fisher Scoring iterations: 1

              Theta:  3.8091 
          Std. Err.:  0.0607 

 2 x log-likelihood:  -85706.8380 </code></pre>
</div>
</div>
<p><strong>Coefficient Interpretation:</strong></p>
<ul>
<li><p>Coefficient Evolution (vs.&nbsp;Model 2):</p></li>
<li><p>New Variable (Spatial) Interpretation:</p></li>
</ul>
</section>
<section id="空间固定效应" class="level2">
<h2 class="anchored" data-anchor-id="空间固定效应"><strong>4.4 空间固定效应:</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加入 'GEOID' (Census Tract) 作为固定效应</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 这相当于为费城每一个普查区都加了一个“基准拦截”，控制了所有观测不到的社区特征</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>model_4 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                    Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span>        <span class="co"># 诱发因子</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 预防因子</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                    Avg_Poverty <span class="sc">+</span>          <span class="co"># 社会结构</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                    Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 破窗效应</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                    Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                    Avg_Unemployment <span class="sc">+</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                    Dist_Police <span class="sc">+</span>          <span class="co"># 政策变量：警力可达性</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span>      <span class="co"># &lt;--- 如果模型跑不动(不收敛)，注释掉这一行</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> final_data,</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">100</span>)) <span class="co"># 增加迭代次数以防不收敛</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership * is_weekend_factor + 
    log(Alcohol_Count + 1) + poly(Light_Count, 2) + Avg_Poverty + 
    Avg_Vacancy + I(Avg_Vacancy^2) + Avg_Income + I(Avg_Income^2) + 
    Avg_Unemployment + Dist_Police + factor(PSA_ID) + offset(log(Exposure_Days)), 
    data = final_data, control = glm.control(maxit = 100), init.theta = 4.730969316, 
    link = log)

Coefficients:
                                         Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                            -4.058e-01  1.071e-01  -3.789 0.000151
Log_Ridership                           9.525e-02  5.201e-03  18.314  &lt; 2e-16
is_weekend_factorWeekend                2.432e-05  2.758e-02   0.001 0.999296
log(Alcohol_Count + 1)                  2.423e-01  8.067e-03  30.036  &lt; 2e-16
poly(Light_Count, 2)1                   2.468e+01  1.203e+00  20.510  &lt; 2e-16
poly(Light_Count, 2)2                  -5.178e+00  7.333e-01  -7.062 1.64e-12
Avg_Poverty                             8.036e-01  1.364e-01   5.891 3.83e-09
Avg_Vacancy                             9.710e-03  4.093e-03   2.372 0.017672
I(Avg_Vacancy^2)                       -1.480e-04  9.976e-05  -1.484 0.137899
Avg_Income                             -1.750e-05  1.684e-06 -10.396  &lt; 2e-16
I(Avg_Income^2)                         8.873e-11  8.819e-12  10.061  &lt; 2e-16
Avg_Unemployment                       -1.928e-02  2.160e-03  -8.924  &lt; 2e-16
Dist_Police                            -2.755e-01  1.534e-02 -17.954  &lt; 2e-16
factor(PSA_ID)012                       3.774e-02  7.062e-02   0.534 0.593118
factor(PSA_ID)021                       5.770e-01  5.888e-02   9.800  &lt; 2e-16
factor(PSA_ID)022                       4.204e-01  6.138e-02   6.848 7.49e-12
factor(PSA_ID)023                       2.167e-01  5.230e-02   4.144 3.42e-05
factor(PSA_ID)031                      -2.512e-01  5.587e-02  -4.496 6.92e-06
factor(PSA_ID)032                       1.861e-01  5.190e-02   3.586 0.000336
factor(PSA_ID)033                      -1.804e-01  4.656e-02  -3.874 0.000107
factor(PSA_ID)051                      -1.158e-01  6.476e-02  -1.788 0.073805
factor(PSA_ID)052                      -3.001e-01  7.173e-02  -4.184 2.87e-05
factor(PSA_ID)053                      -3.824e-01  8.832e-02  -4.330 1.49e-05
factor(PSA_ID)071                       3.128e-01  6.760e-02   4.627 3.71e-06
factor(PSA_ID)072                      -2.708e-01  6.293e-02  -4.303 1.69e-05
factor(PSA_ID)073                      -3.697e-01  6.517e-02  -5.672 1.41e-08
factor(PSA_ID)081                       4.798e-01  6.006e-02   7.989 1.36e-15
factor(PSA_ID)082                      -1.388e-01  5.780e-02  -2.402 0.016302
factor(PSA_ID)083                      -4.606e-03  6.210e-02  -0.074 0.940871
factor(PSA_ID)091                       1.973e-01  5.179e-02   3.811 0.000139
factor(PSA_ID)092                       1.249e-01  5.629e-02   2.219 0.026498
factor(PSA_ID)093                      -2.243e-02  5.251e-02  -0.427 0.669180
factor(PSA_ID)094                       4.995e-01  5.413e-02   9.229  &lt; 2e-16
factor(PSA_ID)095                      -1.978e-01  5.810e-02  -3.404 0.000663
factor(PSA_ID)121                       4.666e-01  6.270e-02   7.443 9.85e-14
factor(PSA_ID)122                      -1.427e-01  1.038e-01  -1.375 0.169163
factor(PSA_ID)123                       8.914e-02  6.188e-02   1.441 0.149665
factor(PSA_ID)124                       2.368e-01  7.720e-02   3.067 0.002159
factor(PSA_ID)141                      -3.889e-02  5.571e-02  -0.698 0.485112
factor(PSA_ID)142                      -1.625e-01  6.301e-02  -2.579 0.009916
factor(PSA_ID)143                       1.960e-01  5.740e-02   3.415 0.000637
factor(PSA_ID)144                      -1.241e-02  6.515e-02  -0.190 0.848975
factor(PSA_ID)151                       1.524e-01  5.272e-02   2.891 0.003845
factor(PSA_ID)152                       4.628e-01  5.253e-02   8.810  &lt; 2e-16
factor(PSA_ID)153                       5.232e-01  5.387e-02   9.713  &lt; 2e-16
factor(PSA_ID)161                      -3.663e-02  5.725e-02  -0.640 0.522209
factor(PSA_ID)162                      -5.668e-02  5.983e-02  -0.947 0.343485
factor(PSA_ID)171                      -1.610e-01  5.428e-02  -2.965 0.003022
factor(PSA_ID)172                      -5.680e-01  6.898e-02  -8.234  &lt; 2e-16
factor(PSA_ID)173                      -3.975e-01  5.909e-02  -6.727 1.73e-11
factor(PSA_ID)181                      -1.636e-01  6.676e-02  -2.451 0.014265
factor(PSA_ID)182                       3.990e-02  5.880e-02   0.679 0.497423
factor(PSA_ID)183                      -1.393e-01  5.350e-02  -2.603 0.009229
factor(PSA_ID)191                       1.965e-01  5.347e-02   3.674 0.000238
factor(PSA_ID)192                       1.749e-02  5.921e-02   0.295 0.767637
factor(PSA_ID)193                       2.983e-01  5.720e-02   5.215 1.84e-07
factor(PSA_ID)221                       2.063e-01  5.666e-02   3.642 0.000271
factor(PSA_ID)222                      -1.035e-02  6.510e-02  -0.159 0.873735
factor(PSA_ID)223                       2.647e-01  5.970e-02   4.434 9.23e-06
factor(PSA_ID)224                       1.685e-01  6.918e-02   2.435 0.014876
factor(PSA_ID)241                       1.121e-01  6.299e-02   1.780 0.075073
factor(PSA_ID)242                       3.243e-01  6.764e-02   4.795 1.63e-06
factor(PSA_ID)243                       8.122e-02  6.635e-02   1.224 0.220954
factor(PSA_ID)251                       1.819e-01  6.727e-02   2.704 0.006846
factor(PSA_ID)252                      -2.377e-01  6.457e-02  -3.682 0.000232
factor(PSA_ID)253                      -3.656e-01  6.789e-02  -5.385 7.25e-08
factor(PSA_ID)254                      -5.605e-02  6.495e-02  -0.863 0.388107
factor(PSA_ID)261                      -1.929e-01  6.498e-02  -2.969 0.002990
factor(PSA_ID)262                       1.561e-01  5.853e-02   2.667 0.007655
factor(PSA_ID)263                      -9.630e-02  5.027e-02  -1.916 0.055399
factor(PSA_ID)351                      -3.793e-02  5.096e-02  -0.744 0.456679
factor(PSA_ID)352                       6.887e-02  5.383e-02   1.279 0.200771
factor(PSA_ID)353                      -2.201e-02  5.796e-02  -0.380 0.704186
factor(PSA_ID)391                       1.119e-02  5.277e-02   0.212 0.832001
factor(PSA_ID)392                      -1.532e-01  5.705e-02  -2.686 0.007233
factor(PSA_ID)393                       1.888e-01  6.928e-02   2.725 0.006431
Log_Ridership:is_weekend_factorWeekend -1.720e-02  7.148e-03  -2.406 0.016114
                                          
(Intercept)                            ***
Log_Ridership                          ***
is_weekend_factorWeekend                  
log(Alcohol_Count + 1)                 ***
poly(Light_Count, 2)1                  ***
poly(Light_Count, 2)2                  ***
Avg_Poverty                            ***
Avg_Vacancy                            *  
I(Avg_Vacancy^2)                          
Avg_Income                             ***
I(Avg_Income^2)                        ***
Avg_Unemployment                       ***
Dist_Police                            ***
factor(PSA_ID)012                         
factor(PSA_ID)021                      ***
factor(PSA_ID)022                      ***
factor(PSA_ID)023                      ***
factor(PSA_ID)031                      ***
factor(PSA_ID)032                      ***
factor(PSA_ID)033                      ***
factor(PSA_ID)051                      .  
factor(PSA_ID)052                      ***
factor(PSA_ID)053                      ***
factor(PSA_ID)071                      ***
factor(PSA_ID)072                      ***
factor(PSA_ID)073                      ***
factor(PSA_ID)081                      ***
factor(PSA_ID)082                      *  
factor(PSA_ID)083                         
factor(PSA_ID)091                      ***
factor(PSA_ID)092                      *  
factor(PSA_ID)093                         
factor(PSA_ID)094                      ***
factor(PSA_ID)095                      ***
factor(PSA_ID)121                      ***
factor(PSA_ID)122                         
factor(PSA_ID)123                         
factor(PSA_ID)124                      ** 
factor(PSA_ID)141                         
factor(PSA_ID)142                      ** 
factor(PSA_ID)143                      ***
factor(PSA_ID)144                         
factor(PSA_ID)151                      ** 
factor(PSA_ID)152                      ***
factor(PSA_ID)153                      ***
factor(PSA_ID)161                         
factor(PSA_ID)162                         
factor(PSA_ID)171                      ** 
factor(PSA_ID)172                      ***
factor(PSA_ID)173                      ***
factor(PSA_ID)181                      *  
factor(PSA_ID)182                         
factor(PSA_ID)183                      ** 
factor(PSA_ID)191                      ***
factor(PSA_ID)192                         
factor(PSA_ID)193                      ***
factor(PSA_ID)221                      ***
factor(PSA_ID)222                         
factor(PSA_ID)223                      ***
factor(PSA_ID)224                      *  
factor(PSA_ID)241                      .  
factor(PSA_ID)242                      ***
factor(PSA_ID)243                         
factor(PSA_ID)251                      ** 
factor(PSA_ID)252                      ***
factor(PSA_ID)253                      ***
factor(PSA_ID)254                         
factor(PSA_ID)261                      ** 
factor(PSA_ID)262                      ** 
factor(PSA_ID)263                      .  
factor(PSA_ID)351                         
factor(PSA_ID)352                         
factor(PSA_ID)353                         
factor(PSA_ID)391                         
factor(PSA_ID)392                      ** 
factor(PSA_ID)393                      ** 
Log_Ridership:is_weekend_factorWeekend *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(4.731) family taken to be 1)

    Null deviance: 30304  on 11065  degrees of freedom
Residual deviance: 11532  on 10989  degrees of freedom
AIC: 83893

Number of Fisher Scoring iterations: 1

              Theta:  4.7310 
          Std. Err.:  0.0792 

 2 x log-likelihood:  -83736.6850 </code></pre>
</div>
</div>
</section>
<section id="model-5-crime-temporal-lag" class="level2">
<h2 class="anchored" data-anchor-id="model-5-crime-temporal-lag">Model 5 crime temporal lag</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加入警局距离，并加入 'GEOID' (Census Tract) 作为固定效应</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 这相当于为费城每一个普查区都加了一个“基准拦截”，控制了所有观测不到的社区特征</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>model_5 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                    Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span>        <span class="co"># 诱发因子</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 预防因子</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                    Avg_Poverty <span class="sc">+</span>          <span class="co"># 社会结构</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                    Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span>          <span class="co"># 破窗效应</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                    Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                    Avg_Unemployment <span class="sc">+</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                    Dist_Police <span class="sc">+</span>          <span class="co"># 政策变量：警力可达性</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span> </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">log</span>(Crime_Daily_Rate_lag <span class="sc">+</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> final_data,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">100</span>)) <span class="co"># 增加迭代次数以防不收敛</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership * is_weekend_factor + 
    log(Alcohol_Count + 1) + poly(Light_Count, 2) + Avg_Poverty + 
    Avg_Vacancy + I(Avg_Vacancy^2) + Avg_Income + I(Avg_Income^2) + 
    Avg_Unemployment + Dist_Police + factor(PSA_ID) + log(Crime_Daily_Rate_lag + 
    0.001) + offset(log(Exposure_Days)), data = final_data, control = glm.control(maxit = 100), 
    init.theta = 13.48398402, link = log)

Coefficients:
                                         Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                             2.557e-01  7.508e-02   3.405 0.000661
Log_Ridership                           3.097e-02  3.559e-03   8.701  &lt; 2e-16
is_weekend_factorWeekend                7.513e-03  1.983e-02   0.379 0.704750
log(Alcohol_Count + 1)                  6.111e-02  5.773e-03  10.587  &lt; 2e-16
poly(Light_Count, 2)1                   3.775e+00  8.603e-01   4.388 1.14e-05
poly(Light_Count, 2)2                  -8.197e-01  4.967e-01  -1.650 0.098911
Avg_Poverty                             1.727e-01  9.536e-02   1.811 0.070160
Avg_Vacancy                            -8.960e-03  2.840e-03  -3.155 0.001604
I(Avg_Vacancy^2)                        2.615e-04  6.921e-05   3.779 0.000158
Avg_Income                             -8.633e-06  1.166e-06  -7.405 1.31e-13
I(Avg_Income^2)                         4.994e-11  6.027e-12   8.286  &lt; 2e-16
Avg_Unemployment                       -1.039e-02  1.539e-03  -6.750 1.48e-11
Dist_Police                            -9.557e-02  1.108e-02  -8.629  &lt; 2e-16
factor(PSA_ID)012                      -1.441e-01  5.067e-02  -2.844 0.004459
factor(PSA_ID)021                       1.421e-01  3.993e-02   3.558 0.000373
factor(PSA_ID)022                       6.487e-02  4.244e-02   1.529 0.126353
factor(PSA_ID)023                       5.092e-02  3.636e-02   1.400 0.161366
factor(PSA_ID)031                      -2.420e-02  3.758e-02  -0.644 0.519537
factor(PSA_ID)032                       3.348e-02  3.519e-02   0.951 0.341369
factor(PSA_ID)033                      -7.734e-02  3.133e-02  -2.469 0.013559
factor(PSA_ID)051                       5.406e-02  4.560e-02   1.186 0.235803
factor(PSA_ID)052                      -1.807e-01  5.194e-02  -3.479 0.000504
factor(PSA_ID)053                      -3.275e-01  6.822e-02  -4.801 1.58e-06
factor(PSA_ID)071                       2.336e-01  4.844e-02   4.822 1.42e-06
factor(PSA_ID)072                      -2.252e-01  4.649e-02  -4.845 1.27e-06
factor(PSA_ID)073                      -1.690e-01  4.871e-02  -3.469 0.000521
factor(PSA_ID)081                       1.977e-01  4.246e-02   4.655 3.23e-06
factor(PSA_ID)082                      -2.421e-01  4.216e-02  -5.742 9.34e-09
factor(PSA_ID)083                      -9.608e-02  4.610e-02  -2.084 0.037172
factor(PSA_ID)091                      -1.083e-01  3.486e-02  -3.108 0.001886
factor(PSA_ID)092                       8.268e-02  3.771e-02   2.193 0.028343
factor(PSA_ID)093                       3.994e-02  3.498e-02   1.142 0.253427
factor(PSA_ID)094                       2.249e-01  3.584e-02   6.276 3.47e-10
factor(PSA_ID)095                      -1.073e-01  3.890e-02  -2.758 0.005810
factor(PSA_ID)121                       4.142e-01  4.334e-02   9.557  &lt; 2e-16
factor(PSA_ID)122                      -1.703e-01  7.205e-02  -2.363 0.018121
factor(PSA_ID)123                      -1.704e-01  4.189e-02  -4.067 4.75e-05
factor(PSA_ID)124                       2.026e-01  5.139e-02   3.943 8.05e-05
factor(PSA_ID)141                      -1.294e-01  3.887e-02  -3.330 0.000868
factor(PSA_ID)142                      -1.265e-01  4.355e-02  -2.905 0.003670
factor(PSA_ID)143                      -1.477e-03  4.006e-02  -0.037 0.970583
factor(PSA_ID)144                      -8.455e-02  4.711e-02  -1.795 0.072659
factor(PSA_ID)151                       1.626e-02  3.617e-02   0.450 0.652963
factor(PSA_ID)152                       1.268e-01  3.589e-02   3.532 0.000412
factor(PSA_ID)153                       2.305e-01  3.677e-02   6.269 3.62e-10
factor(PSA_ID)161                       1.339e-01  3.881e-02   3.449 0.000562
factor(PSA_ID)162                       1.178e-01  4.045e-02   2.913 0.003581
factor(PSA_ID)171                      -6.720e-02  3.659e-02  -1.836 0.066302
factor(PSA_ID)172                      -4.248e-01  4.869e-02  -8.724  &lt; 2e-16
factor(PSA_ID)173                      -2.044e-01  3.989e-02  -5.124 2.99e-07
factor(PSA_ID)181                      -1.544e-01  4.483e-02  -3.445 0.000572
factor(PSA_ID)182                       1.001e-01  3.898e-02   2.569 0.010197
factor(PSA_ID)183                      -8.624e-02  3.617e-02  -2.384 0.017118
factor(PSA_ID)191                       2.030e-01  3.696e-02   5.493 3.94e-08
factor(PSA_ID)192                       6.114e-02  3.944e-02   1.550 0.121118
factor(PSA_ID)193                       2.517e-01  3.986e-02   6.315 2.71e-10
factor(PSA_ID)221                       6.874e-02  3.797e-02   1.811 0.070214
factor(PSA_ID)222                       7.326e-03  4.428e-02   0.165 0.868600
factor(PSA_ID)223                      -6.076e-02  3.978e-02  -1.528 0.126626
factor(PSA_ID)224                      -1.448e-01  4.634e-02  -3.124 0.001781
factor(PSA_ID)241                      -4.814e-02  4.310e-02  -1.117 0.264063
factor(PSA_ID)242                      -7.662e-03  4.520e-02  -0.169 0.865409
factor(PSA_ID)243                       1.327e-01  4.562e-02   2.908 0.003640
factor(PSA_ID)251                       1.919e-01  4.508e-02   4.256 2.08e-05
factor(PSA_ID)252                      -4.972e-02  4.469e-02  -1.113 0.265880
factor(PSA_ID)253                      -2.549e-01  4.660e-02  -5.469 4.52e-08
factor(PSA_ID)254                       4.112e-02  4.372e-02   0.941 0.346951
factor(PSA_ID)261                      -7.614e-02  4.393e-02  -1.733 0.083059
factor(PSA_ID)262                       5.008e-02  3.908e-02   1.282 0.199990
factor(PSA_ID)263                      -6.978e-02  3.389e-02  -2.059 0.039467
factor(PSA_ID)351                      -9.185e-02  3.527e-02  -2.604 0.009201
factor(PSA_ID)352                       7.575e-02  3.668e-02   2.065 0.038890
factor(PSA_ID)353                      -1.149e-01  3.954e-02  -2.905 0.003667
factor(PSA_ID)391                      -8.094e-02  3.676e-02  -2.202 0.027682
factor(PSA_ID)392                      -7.300e-02  3.878e-02  -1.883 0.059766
factor(PSA_ID)393                       4.386e-02  4.647e-02   0.944 0.345290
log(Crime_Daily_Rate_lag + 0.001)       7.084e-01  6.903e-03 102.622  &lt; 2e-16
Log_Ridership:is_weekend_factorWeekend -8.622e-03  5.060e-03  -1.704 0.088411
                                          
(Intercept)                            ***
Log_Ridership                          ***
is_weekend_factorWeekend                  
log(Alcohol_Count + 1)                 ***
poly(Light_Count, 2)1                  ***
poly(Light_Count, 2)2                  .  
Avg_Poverty                            .  
Avg_Vacancy                            ** 
I(Avg_Vacancy^2)                       ***
Avg_Income                             ***
I(Avg_Income^2)                        ***
Avg_Unemployment                       ***
Dist_Police                            ***
factor(PSA_ID)012                      ** 
factor(PSA_ID)021                      ***
factor(PSA_ID)022                         
factor(PSA_ID)023                         
factor(PSA_ID)031                         
factor(PSA_ID)032                         
factor(PSA_ID)033                      *  
factor(PSA_ID)051                         
factor(PSA_ID)052                      ***
factor(PSA_ID)053                      ***
factor(PSA_ID)071                      ***
factor(PSA_ID)072                      ***
factor(PSA_ID)073                      ***
factor(PSA_ID)081                      ***
factor(PSA_ID)082                      ***
factor(PSA_ID)083                      *  
factor(PSA_ID)091                      ** 
factor(PSA_ID)092                      *  
factor(PSA_ID)093                         
factor(PSA_ID)094                      ***
factor(PSA_ID)095                      ** 
factor(PSA_ID)121                      ***
factor(PSA_ID)122                      *  
factor(PSA_ID)123                      ***
factor(PSA_ID)124                      ***
factor(PSA_ID)141                      ***
factor(PSA_ID)142                      ** 
factor(PSA_ID)143                         
factor(PSA_ID)144                      .  
factor(PSA_ID)151                         
factor(PSA_ID)152                      ***
factor(PSA_ID)153                      ***
factor(PSA_ID)161                      ***
factor(PSA_ID)162                      ** 
factor(PSA_ID)171                      .  
factor(PSA_ID)172                      ***
factor(PSA_ID)173                      ***
factor(PSA_ID)181                      ***
factor(PSA_ID)182                      *  
factor(PSA_ID)183                      *  
factor(PSA_ID)191                      ***
factor(PSA_ID)192                         
factor(PSA_ID)193                      ***
factor(PSA_ID)221                      .  
factor(PSA_ID)222                         
factor(PSA_ID)223                         
factor(PSA_ID)224                      ** 
factor(PSA_ID)241                         
factor(PSA_ID)242                         
factor(PSA_ID)243                      ** 
factor(PSA_ID)251                      ***
factor(PSA_ID)252                         
factor(PSA_ID)253                      ***
factor(PSA_ID)254                         
factor(PSA_ID)261                      .  
factor(PSA_ID)262                         
factor(PSA_ID)263                      *  
factor(PSA_ID)351                      ** 
factor(PSA_ID)352                      *  
factor(PSA_ID)353                      ** 
factor(PSA_ID)391                      *  
factor(PSA_ID)392                      .  
factor(PSA_ID)393                         
log(Crime_Daily_Rate_lag + 0.001)      ***
Log_Ridership:is_weekend_factorWeekend .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(13.484) family taken to be 1)

    Null deviance: 64740  on 11065  degrees of freedom
Residual deviance: 11871  on 10988  degrees of freedom
AIC: 76243

Number of Fisher Scoring iterations: 1

              Theta:  13.484 
          Std. Err.:  0.307 

 2 x log-likelihood:  -76085.254 </code></pre>
</div>
</div>
<p>在加入geoid前，aic等于77655，morans i约等于0.5；加入geoid之后，aic等于74009，morans i 约等于0.29，并且只有其他一个其他变量Avg_Poverty从显著变成了不显著。 GEOID 的作用： 当你放入factor(GEOID)，模型就已经知道了“这个区是贫困区”。 如果变量变得不显著： 说明这个变量对犯罪的影响，已经被 GEOID 这个“大标签”完全解释掉了。 如果其他变量依然显著： 这才是最牛的地方！说明像 客流 (Ridership)、路灯、酒铺这些变量，即使在控制了社区背景后，依然对犯罪有独立的、显著的影响。</p>
<p>而且我觉得用census tract可能是最能降morans i的了，其他空间区分方式（比如警区）更是很大一块</p>
<p>总体看来很需要加入geoid作为固定项。AIC 下降 3000 是硬道理，说明模型拟合度极佳。变量显著性稳定，说明模型结构健康。Moran’s I 的0.29虽然不完美，但在实际应用类项目中是可以容忍的（你可以说这是 limitations）。</p>
<p>如何解释那个不显著的变量？ 在结果表格里，如实汇报它变得不显著。 解释为：“该变量的影响已被社区固定效应所包含（Captured by neighborhood fixed effects）。”</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(model_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                         GVIF Df GVIF^(1/(2*Df))
Log_Ridership                        2.140750  1        1.463130
is_weekend_factor                    8.319162  1        2.884296
log(Alcohol_Count + 1)               3.845278  1        1.960938
poly(Light_Count, 2)                11.981538  2        1.860493
Avg_Poverty                          9.159654  1        3.026492
Avg_Vacancy                         23.286389  1        4.825597
I(Avg_Vacancy^2)                    14.466404  1        3.803473
Avg_Income                          98.553277  1        9.927400
I(Avg_Income^2)                     63.899807  1        7.993735
Avg_Unemployment                     3.897398  1        1.974183
Dist_Police                          2.828785  1        1.681899
factor(PSA_ID)                    2368.120093 63        1.063606
log(Crime_Daily_Rate_lag + 0.001)    2.737960  1        1.654678
Log_Ridership:is_weekend_factor      8.153167  1        2.855375</code></pre>
</div>
</div>
<p>其实在加入geoid做固定效应之后，vif变得很屎（看第二列的平方值），但是log ridership还行（1.53^2=2.3）。 多重共线性（High VIF）的主要后果是让相关变量的系数变得不稳定（方差变大，导致显著性消失）。在你的模型里，Light_Count 和 GEOID 打架，导致路灯的系数废了。但是，Log_Ridership 没有参与这场架（它的 VIF 很低）。</p>
<p>只要核心变量不共线，且模型设定正确（AIC 降低证明了这一点），你对 Log_Ridership 的系数估计依然是无偏且有效的。</p>
<p>以前的解释（不加 GEOID）： “客流高的站点犯罪率高，但我们不确定是因为客流本身，还是因为这些站点恰好都在贫民窟或治安差的区域。”</p>
<p>现在的解释（加了 GEOID）： “我们在同一个普查区（Census Tract）内部进行了比较。即便是在同一个社区、面临同样的贫困水平和同样的警力管辖下，那个客流更大的站点，依然比它隔壁客流小的站点有更高的犯罪风险。”</p>
<p>对于不显著的变量，就简单报告：加入了建成环境（路灯、酒铺）作为控制变量，并加入了社区固定效应以消除偏差。虽然这些变量吸收了空间变异，但我们的核心关注点依然是客流带来的稳健影响……</p>
</section>
<section id="model6-比model5减去income" class="level2">
<h2 class="anchored" data-anchor-id="model6-比model5减去income">Model6 比model5减去income</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>model_6 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Crime_Total_Count <span class="sc">~</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                             Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                             Light_Count <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># --- 核心修改 ---</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># 保留贫困率</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                             Avg_Poverty <span class="sc">+</span>   </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># 删除了 Avg_Income 和 I(Avg_Income^2）</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># 检查空置率：如果平方项不显著，也可以删掉平方项只留 Avg_Vacancy</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>                             Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>                             </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>                             Avg_Unemployment <span class="sc">+</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>                             Dist_Police <span class="sc">+</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span> </span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">log</span>(Crime_Daily_Rate_lag <span class="sc">+</span> <span class="fl">0.001</span>) <span class="sc">+</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)), </span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> final_data,</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">100</span>))</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Crime_Total_Count ~ Log_Ridership * is_weekend_factor + 
    log(Alcohol_Count + 1) + Light_Count + Avg_Poverty + Avg_Vacancy + 
    I(Avg_Vacancy^2) + Avg_Unemployment + Dist_Police + factor(PSA_ID) + 
    log(Crime_Daily_Rate_lag + 0.001) + offset(log(Exposure_Days)), 
    data = final_data, control = glm.control(maxit = 100), init.theta = 13.34075513, 
    link = log)

Coefficients:
                                         Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                            -1.939e-01  4.323e-02  -4.485 7.30e-06
Log_Ridership                           3.134e-02  3.564e-03   8.793  &lt; 2e-16
is_weekend_factorWeekend                8.872e-03  1.987e-02   0.447 0.655203
log(Alcohol_Count + 1)                  6.276e-02  5.758e-03  10.899  &lt; 2e-16
Light_Count                             1.154e-04  3.655e-05   3.158 0.001590
Avg_Poverty                             3.399e-01  7.377e-02   4.607 4.08e-06
Avg_Vacancy                            -6.985e-03  2.840e-03  -2.460 0.013899
I(Avg_Vacancy^2)                        2.459e-04  6.941e-05   3.543 0.000396
Avg_Unemployment                       -9.685e-03  1.477e-03  -6.555 5.55e-11
Dist_Police                            -9.825e-02  1.095e-02  -8.971  &lt; 2e-16
factor(PSA_ID)012                      -1.422e-01  5.058e-02  -2.811 0.004946
factor(PSA_ID)021                       1.509e-01  3.998e-02   3.773 0.000161
factor(PSA_ID)022                       1.014e-01  4.228e-02   2.399 0.016438
factor(PSA_ID)023                       6.396e-02  3.636e-02   1.759 0.078605
factor(PSA_ID)031                       2.073e-02  3.584e-02   0.578 0.563028
factor(PSA_ID)032                       5.317e-02  3.469e-02   1.533 0.125309
factor(PSA_ID)033                      -8.258e-02  3.112e-02  -2.654 0.007952
factor(PSA_ID)051                       6.217e-02  4.519e-02   1.376 0.168953
factor(PSA_ID)052                      -1.710e-01  5.178e-02  -3.302 0.000961
factor(PSA_ID)053                      -3.309e-01  6.830e-02  -4.845 1.27e-06
factor(PSA_ID)071                       2.547e-01  4.842e-02   5.259 1.45e-07
factor(PSA_ID)072                      -2.214e-01  4.646e-02  -4.764 1.89e-06
factor(PSA_ID)073                      -1.700e-01  4.882e-02  -3.482 0.000498
factor(PSA_ID)081                       2.072e-01  4.248e-02   4.877 1.08e-06
factor(PSA_ID)082                      -2.493e-01  4.219e-02  -5.909 3.45e-09
factor(PSA_ID)083                      -1.196e-01  4.575e-02  -2.615 0.008924
factor(PSA_ID)091                      -9.835e-02  3.360e-02  -2.927 0.003423
factor(PSA_ID)092                       1.325e-01  3.576e-02   3.705 0.000212
factor(PSA_ID)093                       3.605e-02  3.468e-02   1.040 0.298572
factor(PSA_ID)094                       2.110e-01  3.357e-02   6.287 3.25e-10
factor(PSA_ID)095                      -3.208e-02  3.647e-02  -0.880 0.379119
factor(PSA_ID)121                       4.456e-01  4.336e-02  10.275  &lt; 2e-16
factor(PSA_ID)122                      -1.271e-01  7.201e-02  -1.765 0.077630
factor(PSA_ID)123                      -1.146e-01  4.141e-02  -2.767 0.005659
factor(PSA_ID)124                       2.308e-01  5.113e-02   4.515 6.34e-06
factor(PSA_ID)141                      -1.059e-01  3.856e-02  -2.747 0.006022
factor(PSA_ID)142                      -8.819e-02  4.343e-02  -2.030 0.042325
factor(PSA_ID)143                       2.082e-02  4.008e-02   0.519 0.603501
factor(PSA_ID)144                      -5.119e-02  4.695e-02  -1.090 0.275505
factor(PSA_ID)151                       4.567e-02  3.592e-02   1.271 0.203590
factor(PSA_ID)152                       1.576e-01  3.578e-02   4.404 1.06e-05
factor(PSA_ID)153                       2.389e-01  3.681e-02   6.490 8.58e-11
factor(PSA_ID)161                       1.985e-01  3.806e-02   5.215 1.84e-07
factor(PSA_ID)162                       1.781e-01  3.975e-02   4.480 7.48e-06
factor(PSA_ID)171                      -4.983e-02  3.509e-02  -1.420 0.155534
factor(PSA_ID)172                      -4.390e-01  4.839e-02  -9.073  &lt; 2e-16
factor(PSA_ID)173                      -2.201e-01  3.978e-02  -5.533 3.15e-08
factor(PSA_ID)181                      -9.756e-02  4.423e-02  -2.206 0.027403
factor(PSA_ID)182                       1.344e-01  3.864e-02   3.479 0.000503
factor(PSA_ID)183                      -4.389e-02  3.495e-02  -1.256 0.209178
factor(PSA_ID)191                       1.931e-01  3.687e-02   5.237 1.63e-07
factor(PSA_ID)192                       1.307e-01  3.848e-02   3.396 0.000684
factor(PSA_ID)193                       2.633e-01  3.985e-02   6.608 3.88e-11
factor(PSA_ID)221                       1.218e-01  3.758e-02   3.242 0.001189
factor(PSA_ID)222                       7.118e-02  4.376e-02   1.627 0.103789
factor(PSA_ID)223                      -1.989e-02  3.955e-02  -0.503 0.615088
factor(PSA_ID)224                      -1.497e-01  4.627e-02  -3.235 0.001215
factor(PSA_ID)241                       1.896e-03  4.282e-02   0.044 0.964684
factor(PSA_ID)242                       4.314e-02  4.490e-02   0.961 0.336712
factor(PSA_ID)243                       1.449e-01  4.519e-02   3.206 0.001345
factor(PSA_ID)251                       2.562e-01  4.454e-02   5.752 8.84e-09
factor(PSA_ID)252                       8.936e-03  4.432e-02   0.202 0.840212
factor(PSA_ID)253                      -1.611e-01  4.549e-02  -3.540 0.000399
factor(PSA_ID)254                       1.288e-01  4.258e-02   3.024 0.002497
factor(PSA_ID)261                      -2.606e-02  4.353e-02  -0.599 0.549301
factor(PSA_ID)262                       6.579e-02  3.819e-02   1.723 0.084969
factor(PSA_ID)263                      -4.964e-02  3.330e-02  -1.491 0.135995
factor(PSA_ID)351                      -7.299e-02  3.527e-02  -2.070 0.038487
factor(PSA_ID)352                       1.256e-01  3.624e-02   3.466 0.000528
factor(PSA_ID)353                      -5.349e-02  3.886e-02  -1.377 0.168638
factor(PSA_ID)391                      -4.033e-02  3.657e-02  -1.103 0.270083
factor(PSA_ID)392                      -1.015e-02  3.821e-02  -0.266 0.790478
factor(PSA_ID)393                       1.247e-01  4.552e-02   2.739 0.006163
log(Crime_Daily_Rate_lag + 0.001)       7.118e-01  6.898e-03 103.194  &lt; 2e-16
Log_Ridership:is_weekend_factorWeekend -8.741e-03  5.073e-03  -1.723 0.084891
                                          
(Intercept)                            ***
Log_Ridership                          ***
is_weekend_factorWeekend                  
log(Alcohol_Count + 1)                 ***
Light_Count                            ** 
Avg_Poverty                            ***
Avg_Vacancy                            *  
I(Avg_Vacancy^2)                       ***
Avg_Unemployment                       ***
Dist_Police                            ***
factor(PSA_ID)012                      ** 
factor(PSA_ID)021                      ***
factor(PSA_ID)022                      *  
factor(PSA_ID)023                      .  
factor(PSA_ID)031                         
factor(PSA_ID)032                         
factor(PSA_ID)033                      ** 
factor(PSA_ID)051                         
factor(PSA_ID)052                      ***
factor(PSA_ID)053                      ***
factor(PSA_ID)071                      ***
factor(PSA_ID)072                      ***
factor(PSA_ID)073                      ***
factor(PSA_ID)081                      ***
factor(PSA_ID)082                      ***
factor(PSA_ID)083                      ** 
factor(PSA_ID)091                      ** 
factor(PSA_ID)092                      ***
factor(PSA_ID)093                         
factor(PSA_ID)094                      ***
factor(PSA_ID)095                         
factor(PSA_ID)121                      ***
factor(PSA_ID)122                      .  
factor(PSA_ID)123                      ** 
factor(PSA_ID)124                      ***
factor(PSA_ID)141                      ** 
factor(PSA_ID)142                      *  
factor(PSA_ID)143                         
factor(PSA_ID)144                         
factor(PSA_ID)151                         
factor(PSA_ID)152                      ***
factor(PSA_ID)153                      ***
factor(PSA_ID)161                      ***
factor(PSA_ID)162                      ***
factor(PSA_ID)171                         
factor(PSA_ID)172                      ***
factor(PSA_ID)173                      ***
factor(PSA_ID)181                      *  
factor(PSA_ID)182                      ***
factor(PSA_ID)183                         
factor(PSA_ID)191                      ***
factor(PSA_ID)192                      ***
factor(PSA_ID)193                      ***
factor(PSA_ID)221                      ** 
factor(PSA_ID)222                         
factor(PSA_ID)223                         
factor(PSA_ID)224                      ** 
factor(PSA_ID)241                         
factor(PSA_ID)242                         
factor(PSA_ID)243                      ** 
factor(PSA_ID)251                      ***
factor(PSA_ID)252                         
factor(PSA_ID)253                      ***
factor(PSA_ID)254                      ** 
factor(PSA_ID)261                         
factor(PSA_ID)262                      .  
factor(PSA_ID)263                         
factor(PSA_ID)351                      *  
factor(PSA_ID)352                      ***
factor(PSA_ID)353                         
factor(PSA_ID)391                         
factor(PSA_ID)392                         
factor(PSA_ID)393                      ** 
log(Crime_Daily_Rate_lag + 0.001)      ***
Log_Ridership:is_weekend_factorWeekend .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(13.3408) family taken to be 1)

    Null deviance: 64299  on 11065  degrees of freedom
Residual deviance: 11874  on 10991  degrees of freedom
AIC: 76310

Number of Fisher Scoring iterations: 1

              Theta:  13.341 
          Std. Err.:  0.303 

 2 x log-likelihood:  -76157.840 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 重新看 VIF</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(model_6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                        GVIF Df GVIF^(1/(2*Df))
Log_Ridership                       2.133246  1        1.460563
is_weekend_factor                   8.301509  1        2.881234
log(Alcohol_Count + 1)              3.798142  1        1.948882
Light_Count                         5.541211  1        2.353978
Avg_Poverty                         5.428573  1        2.329930
Avg_Vacancy                        23.126903  1        4.809044
I(Avg_Vacancy^2)                   14.459269  1        3.802535
Avg_Unemployment                    3.561355  1        1.887155
Dist_Police                         2.751623  1        1.658802
factor(PSA_ID)                    467.133380 63        1.049992
log(Crime_Daily_Rate_lag + 0.001)   2.717994  1        1.648634
Log_Ridership:is_weekend_factor     8.139565  1        2.852992</code></pre>
</div>
</div>
</section>
<section id="输出对比表格" class="level2">
<h2 class="anchored" data-anchor-id="输出对比表格"><strong>4.5 输出对比表格</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 加载必要的包</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 定义变量名的“美化映射” (跟 Stargazer 的 label 对应)</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>coef_map_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Log_Ridership"</span> <span class="ot">=</span> <span class="st">"Ridership (Log)"</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"is_weekend_factorWeekend"</span> <span class="ot">=</span> <span class="st">"Weekend Effect"</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Log_Ridership:is_weekend_factorWeekend"</span> <span class="ot">=</span> <span class="st">"Interaction: Ridership × Weekend"</span>,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 环境变量 ---</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(Alcohol_Count + 1)"</span> <span class="ot">=</span> <span class="st">"Alcohol Outlets"</span>, </span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 路灯 (兼容 model_6 的线性项和旧模型的二次项) ---</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Light_Count"</span> <span class="ot">=</span> <span class="st">"Street Lights (Linear)"</span>,       <span class="co"># Model 6 用</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"poly(Light_Count, 2)1"</span> <span class="ot">=</span> <span class="st">"Street Lights (Poly 1)"</span>, <span class="co"># Model 5 用</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"poly(Light_Count, 2)2"</span> <span class="ot">=</span> <span class="st">"Street Lights (Poly 2)"</span>, <span class="co"># Model 5 用</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 社会经济 (model_6 去掉了 Income) ---</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Avg_Poverty"</span> <span class="ot">=</span> <span class="st">"Poverty Rate"</span>,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Avg_Vacancy"</span> <span class="ot">=</span> <span class="st">"Vacancy Rate"</span>,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"I(Avg_Vacancy^2)"</span> <span class="ot">=</span> <span class="st">"Vacancy Rate (Squared)"</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 政策变量 ---</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Dist_Police"</span> <span class="ot">=</span> <span class="st">"Dist to Police Station"</span>,</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 滞后项 ---</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(Crime_Daily_Rate_lag + 0.001)"</span> <span class="ot">=</span> <span class="st">"Temporal Lag (Prev. Quarter)"</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 绘制系数图</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>p_models <span class="ot">&lt;-</span> <span class="fu">modelplot</span>(</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1. Naive"</span> <span class="ot">=</span> model_1, </span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "3. Context" = model_3, # 可以根据需要保留或注释掉旧模型</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5. Robust (PSA)"</span> <span class="ot">=</span> model_5,   <span class="co"># 含 Income 和 Poly Lights</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"6. Final (Refined)"</span> <span class="ot">=</span> model_6 <span class="co"># ⭐ 你的最终模型 (无 Income, 线性路灯)</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_map =</span> coef_map_list, </span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf_level =</span> <span class="fl">0.95</span></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 美化代码 ---</span></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"What Drives Crime Risk?"</span>,</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Model Evolution: Comparing Robust (M5) vs. Final Refined (M6)"</span>,</span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Size (Coefficient Estimate)"</span>,</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Note: Model 6 removes collinear Income variables and simplifies Street Lights to a linear term."</span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 展示图形</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>p_models</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Phase 4.5: Model Comparison Plot (Corrected) ---</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 修正 Coef Map (增加反向交互项以防万一)</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>coef_map_refined <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 核心交互项 ---</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Log_Ridership"</span> <span class="ot">=</span> <span class="st">"Ridership (Log)"</span>,</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"is_weekend_factorWeekend"</span> <span class="ot">=</span> <span class="st">"Weekend Effect"</span>,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># R 有时候会把交互项写反，为了保险，把两种可能都写上</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Log_Ridership:is_weekend_factorWeekend"</span> <span class="ot">=</span> <span class="st">"Interaction: Ridership × Weekend"</span>,</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"is_weekend_factorWeekend:Log_Ridership"</span> <span class="ot">=</span> <span class="st">"Interaction: Ridership × Weekend"</span>, </span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 最终选定的控制变量 ---</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(Alcohol_Count + 1)"</span> <span class="ot">=</span> <span class="st">"Alcohol Outlets"</span>, </span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Light_Count"</span> <span class="ot">=</span> <span class="st">"Street Lights (Linear)"</span>,   </span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Avg_Poverty"</span> <span class="ot">=</span> <span class="st">"Poverty Rate"</span>,             </span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Avg_Vacancy"</span> <span class="ot">=</span> <span class="st">"Vacancy Rate"</span>,</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"I(Avg_Vacancy^2)"</span> <span class="ot">=</span> <span class="st">"Vacancy Rate (Sq)"</span>,</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Avg_Unemployment"</span> <span class="ot">=</span> <span class="st">"Unemployment Rate"</span>,</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Dist_Police"</span> <span class="ot">=</span> <span class="st">"Dist to Police Station"</span>,</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(Crime_Daily_Rate_lag + 0.001)"</span> <span class="ot">=</span> <span class="st">"Temporal Lag (Prev. Q)"</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 绘图</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>p_comparison <span class="ot">&lt;-</span> <span class="fu">modelplot</span>(</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M1: Ridership"</span> <span class="ot">=</span> model_1, </span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M2: +Interact"</span> <span class="ot">=</span> model_2,</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M3: +Env/Demo"</span> <span class="ot">=</span> model_3,</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M4: +PSA Fixed"</span> <span class="ot">=</span> model_4, </span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M5: +Lag"</span> <span class="ot">=</span> model_5,</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M6: Final"</span> <span class="ot">=</span> model_6 </span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_map =</span> coef_map_refined, </span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ⭐⭐⭐ 核心修改在这里 ⭐⭐⭐</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 原来的写法: "Intercept|factor|PSA_ID" -&gt; 误杀了 is_weekend_factor</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 现在的写法: 只过滤 Intercept。</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 原理解释: modelplot 使用 coef_map 时，会自动隐藏所有"不在 map 里"的变量。</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 所以你根本不需要写 factor 或 PSA_ID，只要 map 里没写它们，它们自动就不显示。</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 我们只保留 Intercept 过滤以防万一。</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>, </span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf_level =</span> <span class="fl">0.95</span>,</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="fl">0.8</span> </span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Evolution: Stability of Key Drivers"</span>,</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing coefficients across model iterations (M1-M6)"</span>,</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Size (Coefficient Estimate)"</span>,</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Note: To facilitate direct comparison, this plot displays only the variables selected for the Final Refined Model (M6)."</span></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span> </span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出图形</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>p_comparison</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. 提取系数和方差协方差矩阵 ---</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们需要手动计算周末的斜率标准误 (Standard Error)，公式是 Var(A+B) = Var(A) + Var(B) + 2Cov(A,B)</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 确保你的模型名字是 model_6</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>model_final <span class="ot">&lt;-</span> model_6 </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取系数名 (根据你的模型结果，可能需要微调名字)</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>coef_name_base <span class="ot">&lt;-</span> <span class="st">"Log_Ridership"</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>coef_name_interact <span class="ot">&lt;-</span> <span class="st">"Log_Ridership:is_weekend_factorWeekend"</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取数值</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>beta_base <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_final)[coef_name_base]        <span class="co"># 工作日斜率</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>beta_interact <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_final)[coef_name_interact]<span class="co"># 交互项系数</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>vcov_matrix <span class="ot">&lt;-</span> <span class="fu">vcov</span>(model_final)                      <span class="co"># 协方差矩阵</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. 计算两个场景下的真实斜率 (Marginal Effects) ---</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a><span class="co"># A. 工作日 (Weekday): 也就是基准组 (Base)</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>slope_weekday <span class="ot">&lt;-</span> beta_base</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>se_weekday <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(vcov_matrix[coef_name_base, coef_name_base])</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>p_weekday <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(slope_weekday <span class="sc">/</span> se_weekday)))</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a><span class="co"># B. 周末 (Weekend): 基准 + 交互 (Base + Interaction)</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>slope_weekend <span class="ot">&lt;-</span> beta_base <span class="sc">+</span> beta_interact</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算组合方差: Var(A+B) = Var(A) + Var(B) + 2*Cov(A,B)</span></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>var_weekend <span class="ot">&lt;-</span> vcov_matrix[coef_name_base, coef_name_base] <span class="sc">+</span> </span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>               vcov_matrix[coef_name_interact, coef_name_interact] <span class="sc">+</span> </span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>               <span class="dv">2</span> <span class="sc">*</span> vcov_matrix[coef_name_base, coef_name_interact]</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>se_weekend <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var_weekend)</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>p_weekend <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(slope_weekend <span class="sc">/</span> se_weekend)))</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. 制作“最终判决表” (The Verdict Table) ---</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>hypothesis_test <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario =</span> <span class="fu">c</span>(<span class="st">"Weekday (Commuters)"</span>, <span class="st">"Weekend (Non-Routine)"</span>),</span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">Impact_Slope =</span> <span class="fu">c</span>(slope_weekday, slope_weekend),</span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">Std_Error =</span> <span class="fu">c</span>(se_weekday, se_weekend),</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">P_Value =</span> <span class="fu">c</span>(p_weekday, p_weekend)</span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 自动生成结论列</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">Interpretation =</span> <span class="fu">case_when</span>(</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>      Impact_Slope <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> P_Value <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Positive &amp; Significant (Target Hypothesis Supported)"</span>,</span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>      Impact_Slope <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> P_Value <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Negative &amp; Significant (Eyes on Street Supported)"</span>,</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Not Significant"</span></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 格式化数字</span></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">Impact_Slope =</span> <span class="fu">round</span>(Impact_Slope, <span class="dv">3</span>),</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">Std_Error =</span> <span class="fu">round</span>(Std_Error, <span class="dv">3</span>),</span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">P_Value =</span> <span class="fu">ifelse</span>(P_Value <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"&lt; 0.001"</span>, <span class="fu">round</span>(P_Value, <span class="dv">3</span>))</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出美化表格</span></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(hypothesis_test, <span class="at">caption =</span> <span class="st">"The Verdict: Does Ridership Drive Crime in Both Contexts?"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>), <span class="at">full_width =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">row_spec</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">background =</span> <span class="st">"#e6f5ff"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(<span class="at">general =</span> <span class="st">"Slopes &gt; 0 indicate that higher ridership is associated with higher crime counts."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>The Verdict: Does Ridership Drive Crime in Both Contexts?</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Scenario</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Impact_Slope</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Std_Error</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">P_Value</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">Weekday (Commuters)</td>
<td style="text-align: right; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">0.031</td>
<td style="text-align: right; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">0.004</td>
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">&lt; 0.001</td>
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">Positive &amp; Significant (Target Hypothesis Supported)</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">Weekend (Non-Routine)</td>
<td style="text-align: right; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">0.023</td>
<td style="text-align: right; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">0.004</td>
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">&lt; 0.001</td>
<td style="text-align: left; font-weight: bold; color: black !important; background-color: rgba(230, 245, 255, 255) !important;">Positive &amp; Significant (Target Hypothesis Supported)</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><span style="font-style: italic;">Note: </span></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0;"><sup></sup> Slopes &gt; 0 indicate that higher ridership is associated with higher crime counts.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tfoot>

</table>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. 制作“效应对比图” (Visual Evidence) ---</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hypothesis_test, <span class="fu">aes</span>(<span class="at">x =</span> Scenario, <span class="at">y =</span> Impact_Slope, <span class="at">color =</span> Scenario)) <span class="sc">+</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 画点和误差线 (95% CI)</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Impact_Slope <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span>Std_Error, </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ymax =</span> Impact_Slope <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span>Std_Error), </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 添加一条 0 线 (如果区间跨过0线，说明不显著)</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 标注文字</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Slope ="</span>, Impact_Slope)), </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#3182bd"</span>, <span class="st">"#de2d26"</span>)) <span class="sc">+</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">min</span>(<span class="dv">0</span>, slope_weekday <span class="sc">-</span> <span class="fl">0.2</span>), <span class="fu">max</span>(slope_weekend <span class="sc">+</span> <span class="fl">0.2</span>)) <span class="sc">+</span> <span class="co"># 动态调整Y轴</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparing the 'Ridership Effect'"</span>,</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Both slopes are significantly positive (&gt;0), rejecting 'Eyes on the Street'."</span>,</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Impact of Ridership on Crime (Coefficient)"</span>,</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">""</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Coefficient Interpretation:</strong></p>
<ul>
<li>Fixed Effects Interpretation:</li>
</ul>
</section>
</section>
<section id="phase-5-model-validation" class="level1">
<h1>Phase 5: Model Validation</h1>
<section id="compare-all-5-models" class="level2">
<h2 class="anchored" data-anchor-id="compare-all-5-models"><strong>5.1 Compare all 5 models:</strong></h2>
<section id="create-predicted-vs.-actual-plot" class="level3">
<h3 class="anchored" data-anchor-id="create-predicted-vs.-actual-plot">5.1.1 Create predicted vs.&nbsp;actual plot</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 重新定义五个模型的公式 (确保与 Phase 4 一致)</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days))</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span> Avg_Poverty <span class="sc">+</span> Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> Avg_Unemployment <span class="sc">+</span> Dist_Police <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days))</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>f4 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span> Avg_Poverty <span class="sc">+</span> Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> Avg_Unemployment <span class="sc">+</span> Dist_Police <span class="sc">+</span> <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days)) </span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>f5 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">poly</span>(Light_Count, <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>      Avg_Poverty <span class="sc">+</span> Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>      Avg_Income <span class="sc">+</span> <span class="fu">I</span>(Avg_Income<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> Avg_Unemployment <span class="sc">+</span> </span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>      Dist_Police <span class="sc">+</span> <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span> </span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span>(Crime_Daily_Rate_lag <span class="sc">+</span> <span class="fl">0.001</span>) <span class="sc">+</span> </span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days))</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>f6 <span class="ot">&lt;-</span> Crime_Total_Count <span class="sc">~</span> Log_Ridership <span class="sc">*</span> is_weekend_factor <span class="sc">+</span> </span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span>(Alcohol_Count <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>      Light_Count <span class="sc">+</span>              <span class="co"># 线性项</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>      Avg_Poverty <span class="sc">+</span>              <span class="co"># 仅保留贫困</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>      Avg_Vacancy <span class="sc">+</span> <span class="fu">I</span>(Avg_Vacancy<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>      Avg_Unemployment <span class="sc">+</span> </span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>      Dist_Police <span class="sc">+</span> </span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(PSA_ID) <span class="sc">+</span>           <span class="co"># PSA 固定效应</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span>(Crime_Daily_Rate_lag <span class="sc">+</span> <span class="fl">0.001</span>) <span class="sc">+</span> </span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">offset</span>(<span class="fu">log</span>(Exposure_Days))</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 训练五个模型</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f1, <span class="at">data =</span> final_data)</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f2, <span class="at">data =</span> final_data)</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f3, <span class="at">data =</span> final_data)</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f4, <span class="at">data =</span> final_data)</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f5, <span class="at">data =</span> final_data)</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>m6 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(f6, <span class="at">data =</span> final_data)</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 生成预测数据 (Gather Predictions)</span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a><span class="co"># type = "response" 会直接返回预测的犯罪数量 (Count)，不需要再 exp</span></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Crime_Total_Count) <span class="sc">%&gt;%</span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_1_Pred =</span> <span class="fu">predict</span>(m1, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_2_Pred =</span> <span class="fu">predict</span>(m2, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_3_Pred =</span> <span class="fu">predict</span>(m3, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_4_Pred =</span> <span class="fu">predict</span>(m4, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_5_Pred =</span> <span class="fu">predict</span>(m5, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model_6_Pred =</span> <span class="fu">predict</span>(m6, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Model"</span>), </span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"Model"</span>, </span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"Predicted_Count"</span></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 绘图：Facet Wrap 对比6个模型</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 因为犯罪是计数数据，点会重叠，我们使用 alpha 和 45度线</span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> Predicted_Count, <span class="at">y =</span> Crime_Total_Count)) <span class="sc">+</span></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 添加完美预测线 (y=x)</span></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Model, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs. Actual Crime Counts"</span>,</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing Model Fit: Final Model (M6) shows robust predictions"</span>,</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predicted Crime Count"</span>,</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Actual Crime Count"</span></span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 限制坐标轴范围以便看清核心区域 (去掉极值干扰)</span></span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="report-and-compare-rmse-mae-r²" class="level3">
<h3 class="anchored" data-anchor-id="report-and-compare-rmse-mae-r²">5.1.2 Report and Compare RMSE, MAE, R²</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 设置 5-Fold Cross Validation</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">999</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(final_data<span class="sc">$</span>Crime_Total_Count, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">list =</span> <span class="cn">TRUE</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 定义一个辅助函数：跑 CV 并计算指标</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>run_cv <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, folds) {</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  mae_list <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  rmse_list <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(folds)) {</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split Data</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    test_idx <span class="ot">&lt;-</span> folds[[i]]</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    train_set <span class="ot">&lt;-</span> data[<span class="sc">-</span>test_idx, ]</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    test_set  <span class="ot">&lt;-</span> data[test_idx, ]</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train Model (tryCatch 防止不收敛报错)</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glm.nb</span>(formula, <span class="at">data =</span> train_set)</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">return</span>(<span class="cn">NULL</span>))</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model)) {</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Predict (type = "response" 返回预测的数量)</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>      preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_set, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate Errors</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>      actuals <span class="ot">&lt;-</span> test_set<span class="sc">$</span>Crime_Total_Count</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>      mae_list <span class="ot">&lt;-</span> <span class="fu">c</span>(mae_list, <span class="fu">mean</span>(<span class="fu">abs</span>(actuals <span class="sc">-</span> preds)))</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>      rmse_list <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_list, <span class="fu">sqrt</span>(<span class="fu">mean</span>((actuals <span class="sc">-</span> preds)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="fu">mean</span>(mae_list), <span class="fu">mean</span>(rmse_list)))</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 对五个模型分别跑 CV</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 这里的公式需要跟上面定义的一致</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>results_m1 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f1, final_data, folds)</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>results_m2 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f2, final_data, folds)</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>results_m3 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f3, final_data, folds)</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>results_m4 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f4, final_data, folds)</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>results_m5 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f5, final_data, folds)</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>results_m6 <span class="ot">&lt;-</span> <span class="fu">run_cv</span>(f6, final_data, folds)</span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 汇总表格</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>validation_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"1. Ridership Only"</span>, <span class="st">"2. +Interaction"</span>, <span class="st">"3. +Env &amp; Demo"</span>, <span class="st">"4. +Policy &amp; Dist"</span>, <span class="st">"5. +Temporal lag"</span>, <span class="st">"6. Refined"</span>),</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">c</span>(results_m1[<span class="dv">1</span>], results_m2[<span class="dv">1</span>], results_m3[<span class="dv">1</span>], results_m4[<span class="dv">1</span>], results_m5[<span class="dv">1</span>], results_m6[<span class="dv">1</span>]),</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(results_m1[<span class="dv">2</span>], results_m2[<span class="dv">2</span>], results_m3[<span class="dv">2</span>], results_m4[<span class="dv">2</span>], results_m5[<span class="dv">2</span>], results_m6[<span class="dv">2</span>])</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算相对于 Model 1 的提升百分比</span></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">Improvement_MAE =</span> (MAE[<span class="dv">1</span>] <span class="sc">-</span> MAE) <span class="sc">/</span> MAE[<span class="dv">1</span>]</span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 展示漂亮的表格</span></span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(validation_summary, <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"5-Fold Cross-Validation Metrics"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="st">"striped"</span>, <span class="at">full_width =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">4</span>, <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped caption-top table-sm small" data-quarto-postprocess="true">
<caption>5-Fold Cross-Validation Metrics</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MAE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">RMSE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Improvement_MAE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1. Ridership Only</td>
<td style="text-align: right;">17.268</td>
<td style="text-align: right;">28.877</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2. +Interaction</td>
<td style="text-align: right;">17.209</td>
<td style="text-align: right;">28.868</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.003</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3. +Env &amp; Demo</td>
<td style="text-align: right;">12.777</td>
<td style="text-align: right;">21.039</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.260</td>
</tr>
<tr class="even">
<td style="text-align: left;">4. +Policy &amp; Dist</td>
<td style="text-align: right;">11.409</td>
<td style="text-align: right;">18.343</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.339</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5. +Temporal lag</td>
<td style="text-align: right;">7.453</td>
<td style="text-align: right;">11.629</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.568</td>
</tr>
<tr class="even">
<td style="text-align: left;">6. Refined</td>
<td style="text-align: right;">7.475</td>
<td style="text-align: right;">11.662</td>
<td style="text-align: right; font-weight: bold; color: green !important;">0.567</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Discussion of the most mattered features</strong>:</p>
<p>Result Interpretation (Interpretation Guide for Report):</p>
<p>MAE (Mean Absolute Error):看 Model 3 或 Model 4 的 MAE。假设 MAE = 2.5，这意味着你的模型对每个站点整个夏天的犯罪预测，平均误差在 2.5 起案件左右。</p>
<p>Improvement:对比 Model 1 (Baseline) 和 Model 2 (Interaction)。如果 Model 2 的误差更低，说明把周末和工作日分开预测是必要的（支持了你的 Shark Tank Pitch）。对比 Model 3/4。如果加入了环境变量（酒类、路灯）后误差大幅下降，说明环境因素比单纯的客流更重要。</p>
</section>
</section>
</section>
<section id="phase-6-model-diagnostics" class="level1">
<h1>Phase 6: Model Diagnostics</h1>
<section id="check-assumptions-for-best-model" class="level3">
<h3 class="anchored" data-anchor-id="check-assumptions-for-best-model">Check assumptions for best model:</h3>
</section>
<section id="spatial-autocorrelation-of-residuals-morans-i" class="level2">
<h2 class="anchored" data-anchor-id="spatial-autocorrelation-of-residuals-morans-i"><strong>6.1 Spatial Autocorrelation of Residuals (Moran’s I)</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 明确指定 Model 5 为最佳模型</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> model_6</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 提取残差</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pearson 残差用于统计检验（因为它是标准化的）</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Deviance 残差用于绘图（因为视觉上更能反映拟合优度）</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>final_data<span class="sc">$</span>resid_pearson  <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_model, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>final_data<span class="sc">$</span>resid_deviance <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_model, <span class="at">type =</span> <span class="st">"deviance"</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 构建空间权重矩阵 (Spatial Weights Matrix)</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 由于公交站点是离散点，使用 k-Nearest Neighbors (KNN) 比距离阈值更稳健</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 这里选取 k=8，意味着每个站点对比它最近的 8 个邻居</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(final_data)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>neighbor_nb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">8</span>))</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>spatial_weights <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(neighbor_nb, <span class="at">style =</span> <span class="st">"W"</span>)</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. 运行 Moran's I 检验</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>moran_result <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(final_data<span class="sc">$</span>resid_pearson, spatial_weights)</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 打印结果</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(moran_result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Moran I test under randomisation

data:  final_data$resid_pearson  
weights: spatial_weights    

Moran I statistic standard deviate = 100.73, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
     4.518144e-01     -9.037506e-05      2.012726e-05 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 解释逻辑：</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果 p-value &gt; 0.05: 恭喜！残差是随机分布的，模型非常完美，没有遗漏空间变量。</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果 p-value &lt; 0.05 但 Moran's I 很小 (如 &lt; 0.1): 模型还可以，只有轻微的空间依赖。</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Distribution of Residuals</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 将残差添加回空间数据</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># type = "deviance" residuals are often better for mapping goodness-of-fit</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>final_data<span class="sc">$</span>spatial_resid <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_model, <span class="at">type =</span> <span class="st">"deviance"</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 绘制地图</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 底图</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 站点残差图</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> final_data, </span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> spatial_resid), </span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 颜色比例尺</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"grey90"</span>, <span class="at">high =</span> <span class="st">"red"</span>,</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Deviance</span><span class="sc">\n</span><span class="st">Residual"</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 限制范围，防止极个别离群值破坏颜色分布</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>), </span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish </span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Map of Model Residuals"</span>,</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red = Unexpectedly High Crime (Under-predicted)</span><span class="sc">\n</span><span class="st">Blue = Unexpectedly Low Crime (Over-predicted)"</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li>Interpretation:</li>
</ul>
<p>Red Spots (Positive Residuals): These are “Anomalies”. The model (based on income, lighting, ridership) predicted low crime, but actual crime was high. These are targets for specific police intervention or CPTED audits.</p>
<p>Blue Spots (Negative Residuals): These areas are safer than their environment suggests. What are they doing right?</p>
<p>morans I还是很高，但是空间负二项式回归很难做，我们只能保留这个高Morans i作为limitation： C. 数学上的噩梦：“非线性链接” (The Link Function Problem)这是最硬核的技术原因。线性模型 (OLS): <span class="math inline">\(Y = X\beta + \text{Spatial Effects} + \epsilon\)</span>。加法运算，很容易解。广义线性模型 (GLM/NegBin): <span class="math inline">\(\ln(Y) = X\beta\)</span>。如果你想把空间效应加进去，模型就变成了 <span class="math inline">\(\ln(Y) = \rho W Y + X\beta\)</span>。问题来了： <span class="math inline">\(Y\)</span> 在左边取了对数，在右边又是原始值。这导致似然函数（Likelihood Function）变得极其复杂，无法像普通回归那样求出解析解，必须用非常复杂的马尔可夫链蒙特卡洛（MCMC/Bayesian）方法去“猜”参数。</p>
<p>可以说：我们使用负二项模型，因为标准空间模型无法处理离散的计数数据。但为了修正空间自相关，我们引入了固定效应/空间滤波。这是一种“两全其美”的策略：既尊重了数据的计数属性，又控制了空间聚集风险。</p>
</section>
<section id="residual-plot找实际犯罪预测" class="level2">
<h2 class="anchored" data-anchor-id="residual-plot找实际犯罪预测"><strong>6.1 Residual plot:（找实际犯罪&gt;预测）</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> model_6</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 提取拟合值和残差</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 注意：对于 glm.nb，必须指定 type = "pearson" 来标准化残差</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Fitted =</span> <span class="fu">fitted</span>(best_model),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Residuals =</span> <span class="fu">residuals</span>(best_model, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 绘制残差 vs. 拟合值图</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>p_resid_fitted <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(model_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(Fitted), <span class="at">y =</span> Residuals)) <span class="sc">+</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"#6A1B9A"</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Residuals vs Fitted Values"</span>,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Checking for systematic bias in the Count Model"</span>,</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Log(Fitted Values) - Predicted Crime Count"</span>,</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Pearson Residuals"</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>p_resid_fitted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Interpretation:</p>
<p>Ideal Plot: The points should be scattered randomly around the horizontal red line (0).</p>
<p>Curvature? If the black line curves significantly, it suggests we might be missing a non-linear variable (like a squared term).</p>
<p>Fan Shape? Ideally, the spread should be roughly constant. Since we used Negative Binomial (which handles overdispersion), we hope to see a relatively even spread compared to a Poisson model.</p>
<p>“The Integer Effect” (整数效应) 或 “Discreteness” (离散性)</p>
<p>不要惊慌，这些线条不是模型错误的标志，反而证明了你使用 负二项回归 (Count Model) 来处理犯罪数据是正确的选择。</p>
<p>没看懂啥原理，对就完了</p>
</section>
<section id="q-q-plot" class="level2">
<h2 class="anchored" data-anchor-id="q-q-plot"><strong>6.2 Q-Q plot:</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>p_qq <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(model_data, <span class="fu">aes</span>(<span class="at">sample =</span> Residuals)) <span class="sc">+</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>(<span class="at">color =</span> <span class="st">"#6A1B9A"</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Q-Q Plot of Pearson Residuals"</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Checking for extreme outliers in count data"</span>,</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Theoretical Quantiles"</span>,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sample Quantiles"</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>p_qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li>Deviation at tails: It is common for count data models to deviate at the extreme ends.</li>
</ul>
<p>Interpretation: If the points mostly follow the line in the middle range, the model is acceptable. If there is a massive curve, the Negative Binomial assumption might still be struggling with extreme overdispersion.</p>
</section>
<section id="top-50-风险站点地图" class="level2">
<h2 class="anchored" data-anchor-id="top-50-风险站点地图"><strong>6.3</strong> Top 50 风险站点地图<strong>:</strong></h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 提取预测值 (Predicted Counts)</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Predicted_Crime =</span> <span class="fu">predict</span>(best_model, <span class="at">type =</span> <span class="st">"response"</span>))</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 筛选前 50 个高风险站点</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>top_50_risky <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Predicted_Crime)) <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 绘制行动地图</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 背景底图</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 所有站点 (灰色背景)</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> final_data, <span class="at">color =</span> <span class="st">"grey80"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 高风险站点 (红色醒目)</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> top_50_risky, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (可选) 加上文字标签</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_sf_text(data = head(top_50_risky, 5), aes(label = Stop), dy = 100, size = 3) +</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 50 High-Risk Bus Stops"</span>,</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Priority Zones for Police Patrol Deployment (Based on Model Prediction)"</span>,</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red dots represent the stops with the highest predicted crime counts."</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Top 50 异常风险站点地图 (Residuals)</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 计算残差 (Actual - Predicted)</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们使用 "Raw Residuals" (原始残差)，因为它的业务含义最直观：</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># "实际发生的犯罪比模型预测的多出了多少起？"</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Predicted_Crime =</span> <span class="fu">predict</span>(best_model, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算差异：实际 - 预测</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 正值 (Positive) = 实际犯罪 &gt; 预期 (危险异常)</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 负值 (Negative) = 实际犯罪 &lt; 预期 (安全异常)</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Resid_Raw =</span> Crime_Total_Count <span class="sc">-</span> Predicted_Crime</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 筛选前 50 个风险高（人多），但实际没什么事的站点</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>top_50_anomalies <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 按残差从大到小排序 (只看正值最大的)</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Resid_Raw)) <span class="sc">%&gt;%</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 绘制地图</span></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A. 背景底图 (费城)</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B. 所有站点 (作为背景参考，浅灰色)</span></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> final_data, <span class="at">color =</span> <span class="st">"grey80"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># C. 异常站点 (红色醒目)</span></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> top_50_anomalies, </span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">size =</span> Resid_Raw), <span class="co"># 让残差越大的点越大</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"steelblue"</span>, </span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E. 设置图例和标题</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">name =</span> <span class="st">"Excess Crimes</span><span class="sc">\n</span><span class="st">(Actual - Predicted)"</span>) <span class="sc">+</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 50 Under-policed Stops"</span>,</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Locations where actual crime significantly exceeds model predictions."</span>,</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Blue dots represent stops performing worse than their environment, suggesting there are more police in need."</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.3 Top 50 异常风险站点地图 (Residuals)</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 计算残差 (Actual - Predicted)</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们使用 "Raw Residuals" (原始残差)，因为它的业务含义最直观：</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co"># "实际发生的犯罪比模型预测的多出了多少起？"</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Predicted_Crime =</span> <span class="fu">predict</span>(best_model, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 计算差异：实际 - 预测</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 正值 (Positive) = 实际犯罪 &gt; 预期 (危险异常)</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 负值 (Negative) = 实际犯罪 &lt; 预期 (安全异常)</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Resid_Raw =</span>  Predicted_Crime <span class="sc">-</span> Crime_Total_Count</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 筛选前 50 个风险高（人多），但实际没什么事的站点</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>top_50_anomalies <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 按残差从大到小排序 (只看正值最大的)</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Resid_Raw)) <span class="sc">%&gt;%</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>)</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 绘制地图</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A. 背景底图 (费城)</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_boundary, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># B. 所有站点 (作为背景参考，浅灰色)</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> final_data, <span class="at">color =</span> <span class="st">"grey80"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># C. 异常站点 (红色醒目)</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> top_50_anomalies, </span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">size =</span> Resid_Raw), <span class="co"># 让残差越大的点越大</span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"#d73027"</span>, </span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E. 设置图例和标题</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">name =</span> <span class="st">"Excess Crimes</span><span class="sc">\n</span><span class="st">(Predicted - Actual)"</span>) <span class="sc">+</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 50 'Over-policed' Stops"</span>,</span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Locations where actual crime significantly under model predictions."</span>,</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red dots represent stations which are statistically risky, but the actual crime counts are actually small. "</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_appendix_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.4 Top 10 High-Risk Anomaly Table</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 准备数据</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>top_10_table <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Predicted =</span> <span class="fu">predict</span>(best_model, <span class="at">type =</span> <span class="st">"response"</span>),</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Residual =</span> Crime_Total_Count <span class="sc">-</span> Predicted</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 按残差排序：找出"实际犯罪"比"预测"高得最多的点</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Residual)) <span class="sc">%&gt;%</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 选择并重命名列，使其适合展示</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bus Stop Name"</span> <span class="ot">=</span> Stop,</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Police District (PSA)"</span> <span class="ot">=</span> PSA_ID,</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Actual Crime"</span> <span class="ot">=</span> Crime_Total_Count,</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model Predicted"</span> <span class="ot">=</span> Predicted,</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unexplained Excess"</span> <span class="ot">=</span> Residual</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 输出美化的表格</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a><span class="fu">kbl</span>(top_10_table, <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">caption =</span> <span class="st">"The 'Hit List': Top 10 Stops with Highest Unexplained Crime Risk"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>), <span class="at">full_width =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 高亮最后一列，强调这是我们需要解决的问题</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">background =</span> <span class="st">"#d73027"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 加一个脚注解释</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">footnote</span>(<span class="at">general =</span> <span class="st">" 'Unexplained Excess' = Actual Crime minus Predicted Crime based on local environment. Positive values indicate specific local security failures."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<caption>The 'Hit List': Top 10 Stops with Highest Unexplained Crime Risk</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Bus Stop Name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Police District (PSA)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Actual Crime</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Model Predicted</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Unexplained Excess</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Locust St &amp; 17th St</td>
<td style="text-align: left;">093</td>
<td style="text-align: right;">295</td>
<td style="text-align: right;">198.2</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">96.8</td>
<td style="text-align: left;">POINT (2691904 234766)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Whitby Av &amp; 53rd St</td>
<td style="text-align: left;">124</td>
<td style="text-align: right;">138</td>
<td style="text-align: right;">52.3</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">85.7</td>
<td style="text-align: left;">POINT (2675321 233206.7)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17th St &amp; Locust St</td>
<td style="text-align: left;">093</td>
<td style="text-align: right;">276</td>
<td style="text-align: right;">190.9</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">85.1</td>
<td style="text-align: left;">POINT (2691903 234716.1)</td>
</tr>
<tr class="even">
<td style="text-align: left;">54th St &amp; Willows Av</td>
<td style="text-align: left;">124</td>
<td style="text-align: right;">142</td>
<td style="text-align: right;">58.2</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">83.8</td>
<td style="text-align: left;">POINT (2675499 232607.7)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">52nd St &amp; Jefferson St</td>
<td style="text-align: left;">193</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">94.5</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">81.5</td>
<td style="text-align: left;">POINT (2675925 245535.5)</td>
</tr>
<tr class="even">
<td style="text-align: left;">54th St &amp; Whitby Av - FS</td>
<td style="text-align: left;">124</td>
<td style="text-align: right;">136</td>
<td style="text-align: right;">55.4</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">80.6</td>
<td style="text-align: left;">POINT (2675117 232954.9)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">54th St &amp; Whitby Av</td>
<td style="text-align: left;">124</td>
<td style="text-align: right;">137</td>
<td style="text-align: right;">57.2</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">79.8</td>
<td style="text-align: left;">POINT (2675141 233000)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Whitby Av &amp; 53rd St - FS</td>
<td style="text-align: left;">124</td>
<td style="text-align: right;">133</td>
<td style="text-align: right;">53.5</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">79.5</td>
<td style="text-align: left;">POINT (2675326 233279)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jefferson St &amp; 52nd St - FS</td>
<td style="text-align: left;">193</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">98.9</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">77.1</td>
<td style="text-align: left;">POINT (2675866 245528.4)</td>
</tr>
<tr class="even">
<td style="text-align: left;">52nd St &amp; Heston St</td>
<td style="text-align: left;">193</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">98.9</td>
<td style="text-align: right; font-weight: bold; color: white !important; background-color: rgba(215, 48, 39, 255) !important;">77.1</td>
<td style="text-align: left;">POINT (2675998 245602.9)</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><span style="font-style: italic;">Note: </span></td>
<td style="text-align: left;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0;"><sup></sup> 'Unexplained Excess' = Actual Crime minus Predicted Crime based on local environment. Positive values indicate specific local security failures.</td>
<td style="text-align: left;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
</tr>
</tfoot>

</table>
</div>
</div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li><strong>Overall</strong>These 50 stops represent the “Hotspots” identified by our algorithm.</li>
</ul>
<p>Actionable Insight: “We recommend SEPTA Police allocate dedicated patrol units to these specific locations during peak hours. By focusing resources on these top 1% of stops, we can potentially address a significant portion of the total crime risk.”</p>
<p>这很好，加了geoid之后，除了市中心还有另一坨红色</p>
<hr>
</section>
</section>
<section id="phase-7-conclusions" class="level1">
<h1>Phase 7: Conclusions</h1>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">7.1 Results:</h2>
<p><strong>系数解读:</strong></p>
<ul>
<li><p>如果客流系数是 <strong>负</strong>的 -&gt; <strong>支持“街道眼”理论</strong>（人多反而安全）。</p></li>
<li><p>如果客流系数是 <strong>正</strong>的 -&gt; <strong>支持“潜在受害者”理论</strong>（人多扒窃多）。</p></li>
</ul>
</section>
<section id="the-action-plan" class="level2">
<h2 class="anchored" data-anchor-id="the-action-plan">7.2 The Action Plan:</h2>
<ul>
<li><p><strong>警力部署:</strong> 根据预测的风险值，生成“每日巡逻热点图”。</p></li>
<li><p><strong>环境设计 (CPTED):</strong> 对于那些高犯罪站点，如果是路灯不够，装灯；如果是空置房太多，清理社区。</p></li>
</ul>
</section>
<section id="equity-concerns" class="level2">
<h2 class="anchored" data-anchor-id="equity-concerns"><strong>7.3 Equity concerns</strong></h2>
<ul>
<li><p><strong>Which neighborhoods are hardest to predict?</strong></p></li>
<li><p><strong>Any data bias?</strong></p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>